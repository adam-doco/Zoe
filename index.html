<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºLive2D - ç”Ÿäº§ç¯å¢ƒ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }

        /* Live2D canvas */
        #live2d-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 300px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        /* æŠ˜å çŠ¶æ€ */
        .controls.collapsed {
            transform: translateX(100%);
            opacity: 0;
        }
        
        /* æŠ˜å æŒ‰é’® */
        .collapse-btn {
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #333;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            z-index: 101;
        }
        
        .collapse-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .collapse-btn .arrow {
            transition: transform 0.3s ease;
        }
        
        .controls.collapsed .collapse-btn .arrow {
            transform: rotate(180deg);
        }

        /* å›ºå®šå¬å”¤æŒ‰é’® - å½“èœå•æŠ˜å æ—¶æ˜¾ç¤º */
        .summon-btn {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 102;
        }
        
        .summon-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
        }
        
        /* å½“èœå•æŠ˜å æ—¶æ˜¾ç¤ºå¬å”¤æŒ‰é’® */
        .controls.collapsed + .summon-btn {
            display: flex;
        }
        
        /* å¤‡ç”¨ï¼šé€šè¿‡JavaScriptç±»æ§åˆ¶ */
        .summon-btn.show {
            display: flex;
        }

        /* åº•éƒ¨è¾“å…¥åŒºåŸŸ */
        .input-area {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: stretch;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 5px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-width: 400px;
            max-width: 550px;
            height: 50px;
        }

        /* å·¦ä¾§è¯­éŸ³æŒ‰é’®å®¹å™¨ */
        .voice-section {
            display: flex;
            align-items: center;
            padding: 0 5px;
        }

        /* è¯­éŸ³æŒ‰é’® */
        .voice-input-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #00d4aa, #00c4a7);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(0, 212, 170, 0.3);
            position: relative;
            overflow: hidden;
        }

        .voice-input-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .voice-input-btn:hover::before {
            opacity: 1;
        }

        .voice-input-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 212, 170, 0.4);
        }

        .voice-input-btn.recording {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            animation: recordingPulse 1.5s ease-in-out infinite;
            box-shadow: 0 4px 20px rgba(255, 71, 87, 0.5);
        }

        /* æ–‡å­—è¾“å…¥åŒºåŸŸ */
        .text-section {
            flex: 1;
            display: flex;
            align-items: center;
            position: relative;
        }

        .text-input {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-size: 15px;
            padding: 12px 15px;
            color: #2c3e50;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
        }

        .text-input::placeholder {
            color: #95a5a6;
            font-weight: 300;
        }

        /* å‘é€æŒ‰é’® */
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
            margin-right: 5px;
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .send-btn:hover::before {
            opacity: 1;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            background: linear-gradient(135deg, #bdc3c7, #95a5a6);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* å¾…æœºçŠ¶æ€æ˜¾ç¤º */
        .standby-status {
            position: fixed;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            text-align: center;
        }

        .status-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-icon {
            font-size: 12px;
        }

        .status-text {
            font-size: 12px;
            color: #FF9800;
            font-weight: 400;
        }

        .activate-btn {
            background: none;
            border: none;
            color: #4CAF50;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s ease;
            font-weight: 400;
            margin-left: 8px;
            padding: 0;
        }

        .activate-btn:hover {
            color: #66BB6A;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* å½•éŸ³åŠ¨ç”» */
        @keyframes recordingPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(255, 71, 87, 0.5);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(255, 71, 87, 0.7);
            }
        }

        /* èŠå¤©æ˜¾ç¤ºåŒºåŸŸ */
        .chat-area {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 75%;
            max-width: 450px; /* è¿›ä¸€æ­¥ç¼©å°å®½åº¦ */
            height: 220px; /* é™ä½é«˜åº¦ */
            z-index: 90;
            display: flex;
            flex-direction: column;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ï¼Œä¸é˜»æŒ¡Live2Dæ¨¡å‹äº¤äº’ */
        }

        /* èŠå¤©æ¶ˆæ¯å®¹å™¨ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px 8px;
            display: flex;
            flex-direction: column;
            gap: 6px; /* å¤§å¹…å‡å°‘é—´è· */
            pointer-events: auto; /* æ¶ˆæ¯åŒºåŸŸå¯ä»¥äº¤äº’ */
        }

        /* éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½ */
        .chat-messages::-webkit-scrollbar {
            width: 3px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* æ¶ˆæ¯æ°”æ³¡ */
        .message {
            display: flex;
            align-items: flex-end;
            margin-bottom: 2px; /* å‡å°‘åº•éƒ¨è¾¹è· */
            animation: messageSlideIn 0.3s ease-out;
        }

        /* ç”¨æˆ·æ¶ˆæ¯ (å³ä¾§) */
        .message.user {
            justify-content: flex-end;
        }

        .message.user .bubble {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.85), rgba(0, 196, 167, 0.85));
            color: white;
            margin-left: 40px; /* å‡å°‘å·¦è¾¹è· */
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* AIæ¶ˆæ¯ (å·¦ä¾§) */
        .message.ai {
            justify-content: flex-start;
        }

        .message.ai .bubble {
            background: rgba(255, 255, 255, 0.75);
            color: #2c3e50;
            margin-right: 40px; /* å‡å°‘å³è¾¹è· */
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* æ¶ˆæ¯æ°”æ³¡å†…å®¹ */
        .bubble {
            max-width: 280px; /* è°ƒæ•´é€‚åˆæ–°å®½åº¦ */
            padding: 8px 12px; /* å‡å°‘å†…è¾¹è· */
            border-radius: 16px; /* ç¨å¾®è°ƒå°åœ†è§’ */
            font-size: 14px;
            line-height: 1.3; /* å‡å°‘è¡Œé«˜ */
            word-wrap: break-word;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        /* ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡å°¾å·´ */
        .message.user .bubble::after {
            content: '';
            position: absolute;
            right: -6px;
            bottom: 8px;
            width: 0;
            height: 0;
            border-left: 8px solid rgba(0, 196, 167, 0.85);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        /* AIæ¶ˆæ¯æ°”æ³¡å°¾å·´ */
        .message.ai .bubble::after {
            content: '';
            position: absolute;
            left: -6px;
            bottom: 8px;
            width: 0;
            height: 0;
            border-right: 8px solid rgba(255, 255, 255, 0.75);
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        /* æ¶ˆæ¯è¿›å…¥åŠ¨ç”» */
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ */
        .typing-indicator {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 4px; /* å‡å°‘åº•éƒ¨è¾¹è· */
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .typing-indicator.show {
            opacity: 1;
        }

        .typing-indicator .bubble {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px; /* å‡å°‘å†…è¾¹è· */
            margin-right: 40px; /* å‡å°‘å³è¾¹è· */
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #95a5a6;
            border-radius: 50%;
            animation: typingDots 1.4s ease-in-out infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDots {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* è„‰å†²åŠ¨ç”» */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.small {
            padding: 8px 12px;
            font-size: 11px;
        }

        /* è¯­éŸ³æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        #voice-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            font-size: 14px;
            padding: 15px 25px;
            width: 100%;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        #voice-btn:hover {
            background: linear-gradient(45deg, #ff5252, #ff7979);
        }

        #voice-btn.recording {
            background: linear-gradient(45deg, #ff1744, #f50057);
            animation: pulse 1.5s infinite;
        }

        #voice-btn.connecting {
            background: linear-gradient(45deg, #ffa726, #ffb74d);
            animation: connecting 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes connecting {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
            margin: 10px 0;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        /* ä¸­æ–­æŒ‰é’® */
        #interrupt-btn {
            background: linear-gradient(45deg, #f44336, #ef5350);
            width: 100%;
            margin-top: 10px;
        }

        #interrupt-btn:hover {
            background: linear-gradient(45deg, #d32f2f, #f44336);
        }

        #interrupt-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* é”™è¯¯ä¿¡æ¯ */
        .error-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f44336;
            color: white;
            padding: 10px;
            text-align: center;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .error-bar.show {
            transform: translateY(0);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .controls::-webkit-scrollbar {
            width: 6px;
        }

        .controls::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .controls::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .controls {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                padding: 15px;
            }
        }
        /* AudioBridgeæµ‹è¯•ç›¸å…³æ ·å¼ */
        .log-area {
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 10px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 20px;
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 400px;
            z-index: 200;
            display: none;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-success {
            color: #00ff00;
        }

        .log-error {
            color: #ff4444;
        }

        .log-warning {
            color: #ffaa00;
        }

        .log-info {
            color: #44ccff;
        }

        /* AudioBridgeçŠ¶æ€æ˜¾ç¤º */
        .audio-bridge-status {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 200;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 12px;
        }

        .status-label {
            font-weight: bold;
            margin-right: 10px;
        }

        .status-value {
            color: #007bff;
        }

        .status-success {
            color: #28a745;
        }

        .status-error {
            color: #dc3545;
        }

        .status-warning {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <canvas id="live2d-canvas"></canvas>
    
    <!-- é”™è¯¯æç¤ºæ¡ -->
    <div id="error-bar" class="error-bar"></div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls collapsed" id="controls-panel">
        <!-- æŠ˜å æŒ‰é’® -->
        <button class="collapse-btn" id="collapse-btn" onclick="toggleControlPanel()">
            <span class="arrow">â—€</span>
        </button>
        <!-- è¯­éŸ³æ§åˆ¶ -->
        <div class="control-group">
            <h3>ğŸ¤ è¯­éŸ³å¯¹è¯</h3>
            <div id="voice-status" class="status">ç‚¹å‡»è¿æ¥å°æ™º</div>
            <button id="voice-btn" class="btn">è¿æ¥å°æ™ºAI</button>
            <button id="interrupt-btn" class="btn" disabled>ä¸­æ–­å¯¹è¯</button>
        </div>

        <!-- çŠ¶æ€æ§åˆ¶ -->
        <div class="control-group">
            <h3>ğŸ’ƒ çŠ¶æ€æ§åˆ¶</h3>
            <div id="motions-container">
                <!-- çŠ¶æ€æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è¡¨æƒ…æ§åˆ¶ -->
        <div class="control-group">
            <h3>ğŸ˜Š è¡¨æƒ…æ§åˆ¶</h3>
            <div id="expressions-container">
                <!-- è¡¨æƒ…æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åŠ¨ä½œæ’­æ”¾å™¨ -->
        <div class="control-group">
            <h3>ğŸ­ åŠ¨ä½œæ’­æ”¾å™¨</h3>
            <button class="btn" onclick="openMotionPlayer()">æ‰“å¼€åŠ¨ä½œæ’­æ”¾å™¨</button>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="control-group">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <div style="font-size: 11px; color: #666; line-height: 1.4;">
                <div>ç¯å¢ƒ: ç”Ÿäº§ç¯å¢ƒ</div>
                <div>ç‰ˆæœ¬: v2.0.0</div>
                <div id="device-info">è®¾å¤‡: æ­£åœ¨è·å–...</div>
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒè„šæœ¬ -->
    <script>
        // ========== æŠ˜å æ§åˆ¶å‡½æ•° ==========
        function toggleControlPanel() {
            const panel = document.getElementById('controls-panel');
            const summonBtn = document.getElementById('summon-btn');
            
            panel.classList.toggle('collapsed');
            
            // æ§åˆ¶å¬å”¤æŒ‰é’®çš„æ˜¾ç¤º/éšè—
            if (panel.classList.contains('collapsed')) {
                summonBtn.classList.add('show');
            } else {
                summonBtn.classList.remove('show');
            }
        }

        // ========== AudioBridgeéŸ³é¢‘æ¡¥æ¥ç³»ç»Ÿ ==========
        class AudioBridgeTest {
            constructor() {
                this.websocket = null;
                this.recording = false;
                this.audioContext = null;
                this.mediaStream = null;
                this.processor = null;
                this.startTime = Date.now();
                this.recordingStartTime = 0;
                this.opusCount = 0;
                this.injectionCount = 0;

                this.init();
            }

            async init() {
                this.log('ğŸš€ åˆå§‹åŒ–éŸ³é¢‘æ¡¥æ¥æµ‹è¯•', 'info');
                this.bindEvents();
                this.connectWebSocket();
                this.updateConnectionTime();
            }

            bindEvents() {
                const voiceBtn = document.getElementById('voice-input-btn');
                voiceBtn.removeEventListener('click', this.originalToggleVoiceInput);
                voiceBtn.onclick = () => {
                    if (this.recording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                };
            }

            connectWebSocket() {
                try {
                    this.log('ğŸŒ‰ è¿æ¥éŸ³é¢‘æ¡¥æ¥æœåŠ¡...', 'info');
                    this.websocket = new WebSocket('ws://localhost:8004/ws/audio');

                    this.websocket.onopen = () => {
                        this.log('âœ… éŸ³é¢‘æ¡¥æ¥è¿æ¥æˆåŠŸ', 'success');
                        this.updateStatus('bridge-status', 'å·²è¿æ¥', 'success');
                        this.showAudioBridgeUI();
                    };

                    this.websocket.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            this.handleMessage(message);
                        } catch (e) {
                            this.log(`ğŸ“¥ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ${event.data}`, 'info');
                        }
                    };

                    this.websocket.onclose = () => {
                        this.log('ğŸ”Œ éŸ³é¢‘æ¡¥æ¥è¿æ¥æ–­å¼€', 'warning');
                        this.updateStatus('bridge-status', 'æœªè¿æ¥', 'error');
                    };

                    this.websocket.onerror = (error) => {
                        this.log('âŒ éŸ³é¢‘æ¡¥æ¥é”™è¯¯: ' + error, 'error');
                        this.updateStatus('bridge-status', 'é”™è¯¯', 'error');
                    };

                } catch (error) {
                    this.log('âŒ è¿æ¥å¤±è´¥: ' + error, 'error');
                }
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'bridge_welcome':
                        this.log(`ğŸ‰ ${message.message}`, 'success');
                        this.updateStatus('zoev3-status', message.zoev3_status,
                            message.zoev3_status === 'detected' ? 'success' : 'warning');
                        break;
                    case 'recording_started':
                        this.log(`ğŸ¬ å½•éŸ³ä¼šè¯å¼€å§‹: ${message.session_id}`, 'success');
                        break;
                    case 'recording_stopped':
                        this.log(`â¹ï¸ å½•éŸ³ä¼šè¯ç»“æŸ`, 'success');
                        if (message.recording && message.recording.success) {
                            this.log(`ğŸ“ å½•éŸ³æ–‡ä»¶: ${message.recording.filename}`, 'info');
                            this.log(`â±ï¸ å½•éŸ³æ—¶é•¿: ${message.recording.duration.toFixed(2)}ç§’`, 'info');
                            this.log(`ğŸ“¦ éŸ³é¢‘å¸§æ•°: ${message.recording.frames}`, 'info');
                        }
                        break;
                    case 'bridge_status':
                        this.opusCount = message.opus_packets || 0;
                        this.injectionCount = message.zoev3_injections || 0;
                        this.updateStats();
                        break;
                    case 'server_log':
                        this.log(message.message, 'info');
                        break;
                    default:
                        this.log(`ğŸ“¦ æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${message.type}`, 'warning');
                }
            }

            async startRecording() {
                if (this.recording) return;

                try {
                    this.log('ğŸ¤ å¼€å§‹å½•éŸ³...', 'info');

                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });

                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000
                    });

                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }

                    const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                    this.processor = this.audioContext.createScriptProcessor(1024, 1, 1);

                    this.processor.onaudioprocess = (event) => {
                        if (this.recording) {
                            const audioData = event.inputBuffer.getChannelData(0);
                            this.processAudioData(audioData);
                        }
                    };

                    source.connect(this.processor);
                    this.processor.connect(this.audioContext.destination);

                    this.recording = true;
                    this.recordingStartTime = Date.now();

                    // å‘é€å¼€å§‹å½•éŸ³æ¶ˆæ¯
                    if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                        this.websocket.send(JSON.stringify({
                            type: 'start_recording'
                        }));
                    }

                    // æ›´æ–°UI
                    const voiceBtn = document.getElementById('voice-input-btn');
                    const micIcon = document.getElementById('mic-icon');
                    const recordingIcon = document.getElementById('recording-icon');

                    micIcon.style.display = 'none';
                    recordingIcon.style.display = 'inline';
                    voiceBtn.classList.add('recording');
                    this.updateStatus('recording-status', 'å½•éŸ³ä¸­', 'warning');

                    this.log('âœ… å½•éŸ³å¼€å§‹', 'success');

                } catch (error) {
                    this.log('âŒ å¼€å§‹å½•éŸ³å¤±è´¥: ' + error, 'error');
                    alert('æ— æ³•å¯åŠ¨å½•éŸ³ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™');
                }
            }

            stopRecording() {
                if (!this.recording) return;

                this.log('â¹ï¸ åœæ­¢å½•éŸ³...', 'info');

                this.recording = false;

                if (this.processor) {
                    this.processor.disconnect();
                    this.processor = null;
                }

                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                    this.mediaStream = null;
                }

                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                // å‘é€åœæ­¢å½•éŸ³æ¶ˆæ¯
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(JSON.stringify({
                        type: 'stop_recording'
                    }));
                }

                // æ›´æ–°UI
                const voiceBtn = document.getElementById('voice-input-btn');
                const micIcon = document.getElementById('mic-icon');
                const recordingIcon = document.getElementById('recording-icon');

                micIcon.style.display = 'inline';
                recordingIcon.style.display = 'none';
                voiceBtn.classList.remove('recording');
                this.updateStatus('recording-status', 'å¾…æœº', 'success');

                this.log('âœ… å½•éŸ³åœæ­¢', 'success');
            }

            processAudioData(audioData) {
                // è½¬æ¢ä¸ºInt16Array
                const pcmData = new Int16Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    pcmData[i] = Math.max(-32768, Math.min(32767, Math.floor(audioData[i] * 32768)));
                }

                // å‘é€éŸ³é¢‘æ•°æ®
                if (this.websocket && this.websocket.readyState === WebSocket.OPEN) {
                    this.websocket.send(pcmData.buffer);
                }
            }

            updateStatus(elementId, text, status) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = text;
                    element.className = 'status-value status-' + status;
                }
            }

            updateStats() {
                document.getElementById('opus-count').textContent = this.opusCount;
                document.getElementById('injection-count').textContent = this.injectionCount;

                if (this.recording && this.recordingStartTime) {
                    const duration = (Date.now() - this.recordingStartTime) / 1000;
                    // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°å½•éŸ³æ—¶é•¿æ˜¾ç¤º
                }
            }

            updateConnectionTime() {
                const connectionTime = (Date.now() - this.startTime) / 1000;

                // æ›´æ–°å½•éŸ³æ—¶é•¿
                if (this.recording && this.recordingStartTime) {
                    const duration = (Date.now() - this.recordingStartTime) / 1000;
                    // å¯ä»¥åœ¨è¿™é‡Œæ›´æ–°å½•éŸ³æ—¶é•¿æ˜¾ç¤º
                }

                setTimeout(() => this.updateConnectionTime(), 1000);
            }

            showAudioBridgeUI() {
                document.getElementById('audio-bridge-status').style.display = 'block';
                document.getElementById('log-area').style.display = 'block';
            }

            log(message, type = 'info') {
                const logArea = document.getElementById('log-area');
                if (!logArea) return;

                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logArea.appendChild(logEntry);
                logArea.scrollTop = logArea.scrollHeight;

                // é™åˆ¶æ—¥å¿—æ¡æ•°
                if (logArea.children.length > 100) {
                    logArea.removeChild(logArea.firstChild);
                }
            }
        }

        // ========== åº•éƒ¨è¾“å…¥åŒºåŸŸæ§åˆ¶ ==========
        // ä¿ç•™å…¼å®¹æ€§å‡½æ•°
        function toggleVoiceInput() {
            // è¿™ä¸ªå‡½æ•°ç°åœ¨ç”±AudioBridgeTestç±»å¤„ç†
            if (window.audioBridge) {
                if (window.audioBridge.recording) {
                    window.audioBridge.stopRecording();
                } else {
                    window.audioBridge.startRecording();
                }
            }
        }
        
        
        function handleTextInput(event) {
            if (event.key === 'Enter') {
                sendTextMessage();
            }
        }
        
        function sendTextMessage() {
            const textInput = document.getElementById('text-input');
            const message = textInput.value.trim();
            
            if (message) {
                console.log('å‘é€æ–‡å­—æ¶ˆæ¯:', message);
                
                // è¿™é‡Œå¯ä»¥é›†æˆåˆ°ç°æœ‰çš„AIå¯¹è¯ç³»ç»Ÿ
                // ä¾‹å¦‚è¿æ¥åˆ°å°æ™ºAIæˆ–å…¶ä»–èŠå¤©æœºå™¨äºº
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                textInput.value = '';
                
                // å‘é€æ¶ˆæ¯æ—¶ä¸è§¦å‘è¯´è¯åŠ¨ä½œï¼Œç­‰AIå›å¤æ—¶å†è§¦å‘
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ æ¶ˆæ¯å‘é€é€»è¾‘
                processTextMessage(message);
            }
        }
        
        function processTextMessage(message) {
            // å¤„ç†æ–‡å­—æ¶ˆæ¯çš„å‡½æ•°
            console.log('å¤„ç†æ¶ˆæ¯:', message);
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
            addChatMessage(message, 'user');
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            showTypingIndicator();
            
            // å‘é€æ¶ˆæ¯åˆ°åç«¯Live2D + å°æ™ºAIç³»ç»Ÿ
            sendMessageToBackend(message);
        }
        
        async function sendMessageToBackend(message) {
            try {
                console.log('ğŸš€ å‘é€æ¶ˆæ¯åˆ°åç«¯:', message);
                
                // å‘é€åˆ°åç«¯çš„èŠå¤©API
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        type: 'user_message',
                        text: message,
                        sender: 'user',
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… æ¶ˆæ¯å·²å‘é€åˆ°åç«¯:', result);
                    
                    // ç«‹å³å¼€å§‹è½®è¯¢AIå›å¤
                    startPollingForReply();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('âŒ å‘é€æ¶ˆæ¯åˆ°åç«¯å¤±è´¥:', error);
                hideTypingIndicator();
                addChatMessage('æŠ±æ­‰ï¼Œè¿æ¥åˆ°å°æ™ºAIæ—¶å‡ºç°äº†é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚', 'ai');
            }
        }
        
        // å¤„ç†æ¥è‡ªåç«¯çš„AIå›å¤
        function handleAIResponse(aiMessage) {
            console.log('ğŸ¤– æ”¶åˆ°å°æ™ºAIå›å¤:', aiMessage);
            hideTypingIndicator();
            addChatMessage(aiMessage, 'ai');
            
            // å¤„ç†æ¶ˆæ¯æ—¶ä¸è§¦å‘è¯´è¯åŠ¨ä½œï¼Œç­‰AIå›å¤æ—¶å†è§¦å‘
        }
        
        // ========== åŸºäºç”¨æˆ·æ¶ˆæ¯æ´»åŠ¨çš„æ™ºèƒ½è½®è¯¢ç³»ç»Ÿ ==========
        let smartPollingInterval = null;
        let lastUserMessageTime = 0;
        const POLLING_DURATION = 5 * 60 * 1000; // 5åˆ†é’Ÿï¼ˆæ¯«ç§’ï¼‰

        // å¤„ç†AIå›å¤çš„æ ¸å¿ƒå‡½æ•°
        function handleAIReply(reply) {
            console.log('ğŸ“ å¤„ç†å›å¤:', reply);

            // å¤„ç†ä¸åŒç±»å‹çš„å›å¤
            if (reply.type === 'ai_reply') {
                // æ–‡æœ¬å›å¤
                hideTypingIndicator();
                addChatMessage(reply.text, 'ai');

                // è§¦å‘Live2DåŠ¨ä½œ
                if (window.Live2DAPI) {
                    const emotion = reply.emotion || 'neutral';
                    // ä¸ºAIå›å¤è§¦å‘ä¸€æ¬¡è¯´è¯åŠ¨ä½œï¼ˆé¿å…é‡å¤ï¼‰
                    if (!window.lastTalkTime || Date.now() - window.lastTalkTime > 2000) {
                        Live2DAPI.action.talk();
                        window.lastTalkTime = Date.now();
                    }
                }
            } else if (reply.type === 'tts_status') {
                // TTSçŠ¶æ€ä¿¡æ¯ï¼Œç”¨äºLive2Då˜´éƒ¨åŒæ­¥
                console.log('ğŸ—£ï¸ TTSçŠ¶æ€:', reply.state);
            } else if (reply.type === 'standby_status') {
                // å¾…æœºçŠ¶æ€é€šçŸ¥
                console.log('ğŸ’¤ æ”¶åˆ°å¾…æœºçŠ¶æ€é€šçŸ¥:', reply.is_standby);
                handleStandbyStatus(reply.is_standby, reply.message);
            } else if (reply.type === 'emotion') {
                // æƒ…æ„Ÿä¿¡æ¯ï¼Œç”¨äºLive2Dè¡¨æƒ…æ§åˆ¶
                console.log('ğŸ˜Š æ”¶åˆ°æƒ…æ„Ÿ:', reply.emotion);

                if (window.Live2DAPI) {
                    // è§¦å‘å¯¹åº”çš„è¡¨æƒ…åŠ¨ä½œ - å®Œæ•´è¦†ç›–æ‰€æœ‰å°æ™ºAIçš„emotionå€¼
                    const emotion = reply.emotion;
                    console.log('ğŸ­ å¤„ç†è¡¨æƒ…æ˜ å°„:', emotion);

                    // === ç§¯ææƒ…æ„Ÿç³»åˆ— ===
                    if (emotion === 'happy') {
                        console.log('ğŸ­ æ‰§è¡Œå¼€å¿ƒåŠ¨ä½œ+çˆ±å¿ƒçœ¼');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.love_eyes(), 300);
                    } else if (emotion === 'joy') {
                        console.log('ğŸ­ æ‰§è¡Œå–œæ‚¦åŠ¨ä½œ+æ˜Ÿæ˜Ÿçœ¼');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 350);
                    } else if (emotion === 'excited') {
                        console.log('ğŸ­ æ‰§è¡Œå…´å¥‹åŠ¨ä½œ+æ˜Ÿæ˜Ÿçœ¼');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 300);
                    } else if (emotion === 'love') {
                        console.log('ğŸ­ æ‰§è¡Œçˆ±æ„åŠ¨ä½œ+çˆ±å¿ƒçœ¼');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.love_eyes(), 300);
                    } else if (emotion === 'greeting') {
                        console.log('ğŸ­ æ‰§è¡Œé—®å€™åŠ¨ä½œ+çˆ±å¿ƒçœ¼');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.love_eyes(), 300);
                    } else if (emotion === 'amazed') {
                        console.log('ğŸ­ æ‰§è¡ŒæƒŠå¹åŠ¨ä½œ+æ˜Ÿæ˜Ÿçœ¼');
                        Live2DAPI.action.jingya();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 350);

                    // === æ¶ˆææƒ…æ„Ÿç³»åˆ— ===
                    } else if (emotion === 'sad') {
                        console.log('ğŸ­ æ‰§è¡Œæ‚²ä¼¤åŠ¨ä½œ+å“­æ³£è¡¨æƒ…');
                        Live2DAPI.action.idle();
                        setTimeout(() => Live2DAPI.expression.crying(), 400);
                    } else if (emotion === 'angry') {
                        console.log('ğŸ­ æ‰§è¡Œç”Ÿæ°”åŠ¨ä½œ+ç”Ÿæ°”è¡¨æƒ…');
                        Live2DAPI.action.shengqi();
                        setTimeout(() => Live2DAPI.expression.angry(), 300);
                    } else if (emotion === 'disappointed') {
                        console.log('ğŸ­ æ‰§è¡Œå¤±æœ›åŠ¨ä½œ+å“­æ³£è¡¨æƒ…');
                        Live2DAPI.action.idle();
                        setTimeout(() => Live2DAPI.expression.crying(), 300);
                    } else if (emotion === 'worried') {
                        console.log('ğŸ­ æ‰§è¡Œæ‹…å¿ƒåŠ¨ä½œ(æ‘‡å¤´)');
                        Live2DAPI.action.yaotou();

                    // === æƒŠè®¶ååº”ç³»åˆ— ===
                    } else if (emotion === 'surprised') {
                        console.log('ğŸ­ æ‰§è¡ŒæƒŠè®¶åŠ¨ä½œ+æ˜Ÿæ˜Ÿçœ¼');
                        Live2DAPI.action.jingya();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 250);
                    } else if (emotion === 'shocked') {
                        console.log('ğŸ­ æ‰§è¡Œéœ‡æƒŠåŠ¨ä½œ+æ˜Ÿæ˜Ÿçœ¼');
                        Live2DAPI.action.jingya();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 300);

                    // === ä¸­æ€§/æ€è€ƒçŠ¶æ€ç³»åˆ— ===
                    } else if (emotion === 'neutral') {
                        console.log('ğŸ­ ä¸­æ€§è¡¨æƒ…ï¼Œæ’­æ”¾å¾…æœºçŠ¶æ€');
                        Live2DAPI.action.idle();
                    } else if (emotion === 'calm') {
                        console.log('ğŸ­ æ‰§è¡Œå¹³é™åŠ¨ä½œ(å¾…æœº)');
                        Live2DAPI.action.idle();
                    } else if (emotion === 'thinking') {
                        console.log('ğŸ­ æ‰§è¡Œæ€è€ƒåŠ¨ä½œ(å¾…æœº)');
                        Live2DAPI.action.idle();
                    } else if (emotion === 'confused') {
                        console.log('ğŸ­ æ‰§è¡Œå›°æƒ‘åŠ¨ä½œ(æ‘‡å¤´)');
                        Live2DAPI.action.yaotou();

                    // === æ´»è·ƒçŠ¶æ€ç³»åˆ— ===
                    } else if (emotion === 'playful') {
                        console.log('ğŸ­ æ‰§è¡Œé¡½çš®åŠ¨ä½œ+èˆŒå¤´è¡¨æƒ…');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.tongue(), 250);
                    } else if (emotion === 'mischievous') {
                        console.log('ğŸ­ æ‰§è¡Œæ·˜æ°”åŠ¨ä½œ+èˆŒå¤´è¡¨æƒ…');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.tongue(), 300);

                    // === ç‰¹æ®ŠçŠ¶æ€ç³»åˆ— ===
                    } else if (emotion === 'farewell') {
                        console.log('ğŸ­ æ‰§è¡Œå‘Šåˆ«åŠ¨ä½œ(æ‘‡å¤´)');
                        Live2DAPI.action.yaotou();

                    // === å…¼å®¹æ—§ç‰ˆæœ¬çš„æ˜ å°„ ===
                    } else if (emotion === 'cool') {
                        console.log('ğŸ­ æ‰§è¡Œçœ¨çœ¼åŠ¨ä½œ');
                        Live2DAPI.action.wink();
                    } else if (emotion === 'funny') {
                        console.log('ğŸ­ æ‰§è¡Œæœ‰è¶£åŠ¨ä½œ+èˆŒå¤´è¡¨æƒ…');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.tongue(), 500);
                    } else if (emotion === 'laughing') {
                        console.log('ğŸ­ æ‰§è¡Œå¤§ç¬‘åŠ¨ä½œ+æ˜Ÿæ˜Ÿçœ¼');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 400);
                    } else if (emotion === 'loving') {
                        console.log('ğŸ­ æ‰§è¡Œçˆ±å¿ƒåŠ¨ä½œ+çˆ±å¿ƒçœ¼');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.love_eyes(), 300);

                    // === æ–°å¢å°æ™ºAIæ ‡å‡†emojiæ˜ å°„ ===
                    } else if (emotion === 'crying') {
                        console.log('ğŸ­ æ‰§è¡Œå“­æ³£çŠ¶æ€+å“­æ³£è¡¨æƒ… (ğŸ˜­)');
                        Live2DAPI.action.idle();
                        setTimeout(() => Live2DAPI.expression.crying(), 400);
                    } else if (emotion === 'embarrassed') {
                        console.log('ğŸ­ æ‰§è¡Œå°´å°¬çŠ¶æ€(æ‘‡å¤´) (ğŸ˜³)');
                        Live2DAPI.action.yaotou();
                    } else if (emotion === 'winking') {
                        console.log('ğŸ­ æ‰§è¡Œçœ¨çœ¼è°ƒçš®+èˆŒå¤´è¡¨æƒ… (ğŸ˜‰)');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.tongue(), 250);
                    } else if (emotion === 'relaxed') {
                        console.log('ğŸ­ æ‰§è¡Œæ”¾æ¾çŠ¶æ€(å¾…æœº) (ğŸ˜Œ)');
                        Live2DAPI.action.idle();
                    } else if (emotion === 'delicious') {
                        console.log('ğŸ­ æ‰§è¡Œç¾å‘³äº«å—+èˆŒå¤´è¡¨æƒ… (ğŸ¤¤)');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.tongue(), 300);
                    } else if (emotion === 'kissy') {
                        console.log('ğŸ­ æ‰§è¡Œé£å»çŠ¶æ€+çˆ±å¿ƒçœ¼ (ğŸ˜˜)');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.love_eyes(), 350);
                    } else if (emotion === 'confident') {
                        console.log('ğŸ­ æ‰§è¡Œè‡ªä¿¡çŠ¶æ€(çœ¨çœ¼) (ğŸ˜)');
                        Live2DAPI.action.wink();
                    } else if (emotion === 'sleepy') {
                        console.log('ğŸ­ æ‰§è¡Œå›°å€¦çŠ¶æ€(å¾…æœº) (ğŸ˜´)');
                        Live2DAPI.action.idle();
                    } else if (emotion === 'silly') {
                        console.log('ğŸ­ æ‰§è¡Œè°ƒçš®ææ€ª+èˆŒå¤´è¡¨æƒ… (ğŸ˜œ)');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.tongue(), 250);

                    // === emotion_mapping.pyåŒä¹‰è¯æ˜ å°„ ===
                    } else if (emotion === 'glad' || emotion === 'cheerful') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: glad/cheerful â†’ happy');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.love_eyes(), 300);
                    } else if (emotion === 'delighted') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: delighted â†’ joy');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 350);
                    } else if (emotion === 'thrilled') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: thrilled â†’ excited');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 300);
                    } else if (emotion === 'upset') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: upset â†’ sad');
                        Live2DAPI.action.idle();
                        setTimeout(() => Live2DAPI.expression.crying(), 400);
                    } else if (emotion === 'mad' || emotion === 'furious') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: mad/furious â†’ angry');
                        Live2DAPI.action.shengqi();
                        setTimeout(() => Live2DAPI.expression.angry(), 300);
                    } else if (emotion === 'startled') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: startled â†’ surprised');
                        Live2DAPI.action.jingya();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 250);
                    } else if (emotion === 'astonished') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: astonished â†’ amazed');
                        Live2DAPI.action.jingya();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 350);
                    } else if (emotion === 'puzzled') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: puzzled â†’ confused');
                        Live2DAPI.action.yaotou();
                    } else if (emotion === 'naughty') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: naughty â†’ mischievous');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.tongue(), 300);

                    // === å°æ™ºAI emojiåŒä¹‰è¯æ˜ å°„ ===
                    } else if (emotion === 'smile') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: smile â†’ happy (ğŸ˜Š â†’ ğŸ™‚)');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.love_eyes(), 300);
                    } else if (emotion === 'laugh') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: laugh â†’ laughing');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.star_eyes(), 400);
                    } else if (emotion === 'weep') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: weep â†’ crying');
                        Live2DAPI.action.idle();
                        setTimeout(() => Live2DAPI.expression.crying(), 400);
                    } else if (emotion === 'wink') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: wink â†’ winking');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.tongue(), 250);
                    } else if (emotion === 'blush') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: blush â†’ embarrassed');
                        Live2DAPI.action.yaotou();
                    } else if (emotion === 'tired') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: tired â†’ sleepy');
                        Live2DAPI.action.idle();
                    } else if (emotion === 'chuckle') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: chuckle â†’ funny');
                        Live2DAPI.action.kaixin();
                        setTimeout(() => Live2DAPI.expression.tongue(), 500);
                    } else if (emotion === 'giggle') {
                        console.log('ğŸ­ åŒä¹‰è¯æ˜ å°„: giggle â†’ silly');
                        Live2DAPI.action.wink();
                        setTimeout(() => Live2DAPI.expression.tongue(), 250);

                    // === é¢å¤–æ˜ å°„ä½¿ç”¨å‰©ä½™è¡¨æƒ… ===
                    } else if (emotion === 'singing' || emotion === 'musical') {
                        console.log('ğŸ­ æ‰§è¡Œå”±æ­Œè¡¨æƒ…(éº¦å…‹é£)');
                        Live2DAPI.expression.microphone();
                    } else if (emotion === 'cold' || emotion === 'chilly') {
                        console.log('ğŸ­ æ‰§è¡Œå¯’å†·è¡¨æƒ…(å¤–å¥—)');
                        Live2DAPI.expression.coat();
                    } else if (emotion === 'stylish' || emotion === 'fashionable') {
                        console.log('ğŸ­ æ‰§è¡Œæ—¶å°šåŠ¨ä½œ+å¤–å¥—è¡¨æƒ…');
                        Live2DAPI.action.jingya();
                        setTimeout(() => Live2DAPI.expression.coat(), 300);

                    } else {
                        console.log('ğŸ­ æœªæ˜ å°„çš„è¡¨æƒ…:', emotion, '- æ’­æ”¾é»˜è®¤å¾…æœºçŠ¶æ€');
                        Live2DAPI.action.idle();
                    }
                }
            }
        }

        // æ™ºèƒ½è½®è¯¢AIå›å¤
        async function smartPollAIReplies() {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²è¶…è¿‡è½®è¯¢æ—¶é—´
                const now = Date.now();
                if (now - lastUserMessageTime > POLLING_DURATION) {
                    // è¶…è¿‡5åˆ†é’Ÿï¼Œåœæ­¢è½®è¯¢
                    stopSmartPolling();
                    console.log('â° 5åˆ†é’Ÿæ— ç”¨æˆ·æ´»åŠ¨ï¼Œåœæ­¢è½®è¯¢');
                    return;
                }

                // è½®è¯¢AIå›å¤
                const response = await fetch('/api/poll_reply');
                if (response.ok) {
                    const result = await response.json();

                    if (result.has_reply) {
                        // å¤„ç†å¤šæ¡å›å¤ï¼ˆæ–°æ ¼å¼ï¼‰æˆ–å•æ¡å›å¤ï¼ˆå…¼å®¹æ—§æ ¼å¼ï¼‰
                        const replies = result.replies || [result.reply];
                        const replyCount = result.count || 1;

                        console.log(`âœ… æ”¶åˆ°æ™ºèƒ½è½®è¯¢å›å¤: ${replyCount}æ¡æ¶ˆæ¯`, replies);

                        // é€æ¡å¤„ç†æ‰€æœ‰å›å¤
                        for (const reply of replies) {
                            handleAIReply(reply);
                        }
                    }
                }
            } catch (error) {
                console.error('âŒ æ™ºèƒ½è½®è¯¢å›å¤é”™è¯¯:', error);
            }
        }

        // å¯åŠ¨æ™ºèƒ½è½®è¯¢
        function startSmartPolling() {
            if (smartPollingInterval) {
                console.log('âš ï¸ æ™ºèƒ½è½®è¯¢å·²åœ¨è¿è¡Œä¸­');
                return;
            }

            console.log('ğŸ§  å¯åŠ¨åŸºäºç”¨æˆ·æ´»åŠ¨çš„æ™ºèƒ½è½®è¯¢ç³»ç»Ÿ...');

            // æ¯1ç§’è½®è¯¢ä¸€æ¬¡
            smartPollingInterval = setInterval(smartPollAIReplies, 1000);
        }

        // åœæ­¢æ™ºèƒ½è½®è¯¢
        function stopSmartPolling() {
            if (smartPollingInterval) {
                clearInterval(smartPollingInterval);
                smartPollingInterval = null;
                console.log('â›” æ™ºèƒ½è½®è¯¢å·²åœæ­¢');
            }
        }

        // ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶è°ƒç”¨ï¼Œæ›´æ–°æ´»åŠ¨æ—¶é—´å¹¶å¯åŠ¨è½®è¯¢
        function onUserMessageSent() {
            const now = Date.now();
            lastUserMessageTime = now;

            console.log('ğŸ“¤ ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼Œæ›´æ–°è½®è¯¢è®¡æ—¶å™¨');

            // å¯åŠ¨æˆ–é‡ç½®è½®è¯¢
            if (!smartPollingInterval) {
                startSmartPolling();
            }

            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
            showTypingIndicator();
        }

        // å…¼å®¹å‡½æ•°ï¼šä¸ºäº†ä¸ç ´åç°æœ‰è°ƒç”¨
        function startPollingForReply() {
            onUserMessageSent();
        }

        // ========== èŠå¤©ç•Œé¢åŠŸèƒ½ ==========
        
        function addChatMessage(text, sender) {
            const chatMessages = document.getElementById('chat-messages');
            
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'bubble';
            bubbleDiv.textContent = text;
            
            messageDiv.appendChild(bubbleDiv);
            chatMessages.appendChild(messageDiv);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom();
        }
        
        function showTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            indicator.classList.add('show');
            scrollToBottom();
        }
        
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            indicator.classList.remove('show');
        }
        
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }
        
        // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ¶ˆæ¯ç”¨äºæ¼”ç¤º
        function addDemoMessages() {
            setTimeout(() => {
                addChatMessage("ä½ å¥½ï¼", "user");
            }, 1000);
            
            setTimeout(() => {
                showTypingIndicator();
                setTimeout(() => {
                    hideTypingIndicator();
                    addChatMessage("ä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ", "ai");
                    if (window.Live2DAPI) {
                        Live2DAPI.action.kaixin(); // æ’­æ”¾å¼€å¿ƒåŠ¨ä½œ
                    }
                }, 1500);
            }, 2000);
        }

        // ========== å¾…æœºçŠ¶æ€ç®¡ç† ==========

        // å¤„ç†å¾…æœºçŠ¶æ€æ˜¾ç¤º/éšè—
        function handleStandbyStatus(isStandby, message) {
            const standbyStatus = document.getElementById('standby-status');
            const statusText = standbyStatus.querySelector('.status-text');

            if (isStandby) {
                console.log('ğŸ’¤ ç³»ç»Ÿè¿›å…¥å¾…æœºçŠ¶æ€:', message);
                statusText.textContent = 'çŠ¶æ€ï¼šå¾…æœºä¸­';
                standbyStatus.style.display = 'block';

                // æ·»åŠ è¿›å…¥å¾…æœºçŠ¶æ€çš„æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
                if (message) {
                    addChatMessage(message, 'system');
                }
            } else {
                console.log('âœ… ç³»ç»Ÿå·²æ¿€æ´»:', message);
                standbyStatus.style.display = 'none';

                // æ·»åŠ æ¿€æ´»æˆåŠŸæ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
                if (message) {
                    addChatMessage(message, 'system');
                }
            }
        }

        // æ¿€æ´»ç³»ç»Ÿå‡½æ•°
        async function activateSystem() {
            const activateBtn = document.getElementById('activate-btn');
            const originalText = activateBtn.textContent;

            try {
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                activateBtn.disabled = true;
                activateBtn.textContent = 'æ¿€æ´»ä¸­...';

                console.log('ğŸ”„ å‘é€æ¿€æ´»è¯·æ±‚...');

                const response = await fetch('/api/activate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('âœ… æ¿€æ´»è¯·æ±‚ç»“æœ:', result);

                    if (result.status === 'success') {
                        // æ¿€æ´»æˆåŠŸï¼Œç«‹å³æ£€æŸ¥çŠ¶æ€æ›´æ–°
                        console.log('ğŸ‰ ç³»ç»Ÿæ¿€æ´»æˆåŠŸ');
                    } else {
                        console.error('âŒ æ¿€æ´»å¤±è´¥:', result.message);
                        addChatMessage('æ¿€æ´»å¤±è´¥ï¼š' + result.message, 'system');
                    }
                } else {
                    console.error('âŒ æ¿€æ´»è¯·æ±‚å¤±è´¥:', response.status);
                    addChatMessage('æ¿€æ´»è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'system');
                }

            } catch (error) {
                console.error('âŒ æ¿€æ´»è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                addChatMessage('æ¿€æ´»è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'system');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                activateBtn.disabled = false;
                activateBtn.textContent = originalText;
            }
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addSystemMessage(message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="message-content system">
                    <div class="message-text">${message}</div>
                    <div class="message-time">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ========== å…¨å±€é…ç½® ==========
        const XIAOZHI_CONFIG = {
            // ç”Ÿäº§ç¯å¢ƒé…ç½®
            websocketUrl: 'wss://api.tenclass.net/xiaozhi/v1/',
            otaUrl: 'https://api.tenclass.net/xiaozhi/ota/',
            
            // è®¾å¤‡ä¿¡æ¯ (å·²æ¿€æ´»çš„è®¾å¤‡)
            deviceId: 'b3:66:fa:cc:95:b9',
            clientId: 'c5d17de5-277a-47d9-8a7b-137300ea0fbc',
            serialNumber: 'SN-07BB9BEF-b366facc95b9',
            hmacKey: '431c400f98c949da553dff65800effa5183d2f5def9db9698bbcd40b9d751df2',
            
            // éŸ³é¢‘é…ç½®
            audio: {
                sampleRate: 16000,
                channels: 1,
                frameSize: 960
            }
        };

        // ========== Live2Dç®¡ç†å™¨ ==========
        class Live2DManager {
            constructor() {
                this.app = null;
                this.model = null;
                this.canvas = document.getElementById('live2d-canvas');
                this.isLoaded = false;
                this.idleReturnTimer = null; // è‡ªåŠ¨å›å½’å¾…æœºçš„å®šæ—¶å™¨
                this.initialStateSnapshot = null; // åˆå§‹çŠ¶æ€å¿«ç…§
            }

            async init() {
                try {
                    await this.loadScripts();
                    await this.initPixiApp();
                    await this.loadModel();
                    this.setupControls();
                    console.log('âœ“ Live2Dåˆå§‹åŒ–å®Œæˆ');
                    this.isLoaded = true;
                } catch (error) {
                    console.error('Live2Dåˆå§‹åŒ–å¤±è´¥:', error);
                    showError('Live2DåŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            async loadScripts() {
                const scripts = [
                    'https://unpkg.com/pixi.js@7.3.2/dist/pixi.min.js',
                    'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js'
                ];

                for (const src of scripts) {
                    await this.loadScript(src);
                }

                // è®¾ç½®PIXIå…¨å±€å˜é‡
                window.PIXI = PIXI;
                
                // åŠ è½½Live2Dæ˜¾ç¤ºåº“
                await this.loadScript('https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.min.js');
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = () => reject(new Error(`è„šæœ¬åŠ è½½å¤±è´¥: ${src}`));
                    document.head.appendChild(script);
                });
            }

            async initPixiApp() {
                this.app = new PIXI.Application({
                    view: this.canvas,
                    width: window.innerWidth,
                    height: window.innerHeight,
                    backgroundColor: 0x000000,
                    backgroundAlpha: 0,
                    antialias: true,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true
                });

                // å“åº”å¼å¤„ç†
                window.addEventListener('resize', () => {
                    this.app.renderer.resize(window.innerWidth, window.innerHeight);
                    if (this.model) {
                        this.positionModel();
                    }
                });
            }

            async loadModel() {
                try {
                    console.log('æ­£åœ¨åŠ è½½Live2Dæ¨¡å‹...');
                    
                    // éªŒè¯æ¨¡å‹æ–‡ä»¶
                    const response = await fetch('Mould/Z.model3.json', { method: 'HEAD' });
                    if (!response.ok) {
                        throw new Error('æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                    }

                    this.model = await PIXI.live2d.Live2DModel.from('Mould/Z.model3.json');
                    this.app.stage.addChild(this.model);
                    this.positionModel();

                    // ä¿å­˜åˆå§‹çŠ¶æ€å¿«ç…§
                    this.saveInitialState();

                    console.log('âœ“ Live2Dæ¨¡å‹åŠ è½½æˆåŠŸ');
                } catch (error) {
                    console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                    throw error;
                }
            }

            positionModel() {
                if (!this.model) return;

                // å…ˆè®¾ç½®é”šç‚¹å’Œä½ç½®ï¼Œç¡®ä¿æ¨¡å‹å±…ä¸­æ˜¾ç¤º
                this.model.anchor.set(0.5, 0.5);
                this.model.x = window.innerWidth * 0.5;
                this.model.y = window.innerHeight * 0.5;

                // ç­‰å¾…æ¨¡å‹å®Œå…¨åŠ è½½å¹¶è·å–æ­£ç¡®å°ºå¯¸ï¼Œæœ€å¤šé‡è¯•5æ¬¡
                if (!this.positionRetryCount) this.positionRetryCount = 0;

                if ((!this.model.width || !this.model.height || this.model.width < 10 || this.model.height < 10) && this.positionRetryCount < 5) {
                    console.log(`ğŸ”„ æ¨¡å‹å°ºå¯¸æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿå®šä½... (ç¬¬${this.positionRetryCount + 1}æ¬¡)`);
                    this.positionRetryCount++;
                    setTimeout(() => this.positionModel(), 200);
                    return;
                }

                // å¦‚æœé‡è¯•5æ¬¡åä»ç„¶æ— æ³•è·å–å°ºå¯¸ï¼Œä½¿ç”¨é»˜è®¤ç¼©æ”¾
                if (!this.model.width || !this.model.height || this.model.width < 10 || this.model.height < 10) {
                    console.log('âš ï¸ æ— æ³•è·å–æ¨¡å‹å°ºå¯¸ï¼Œä½¿ç”¨é»˜è®¤ç¼©æ”¾ 0.5');
                    this.model.scale.set(0.5);
                    this.positionRetryCount = 0;
                    return;
                }

                const scale = Math.min(
                    window.innerWidth / this.model.width,
                    window.innerHeight / this.model.height
                ) * 0.7;

                // é˜²æ­¢å¼‚å¸¸ç¼©æ”¾
                const finalScale = Math.max(0.1, Math.min(2.0, scale));
                console.log(`ğŸ“ æ¨¡å‹å®šä½: çª—å£${window.innerWidth}x${window.innerHeight}, æ¨¡å‹${this.model.width}x${this.model.height}, ç¼©æ”¾${finalScale}`);

                this.model.scale.set(finalScale);
                this.positionRetryCount = 0;
            }

            setupControls() {
                if (!this.model) return;

                const motionsContainer = document.getElementById('motions-container');
                const expressionsContainer = document.getElementById('expressions-container');

                // ä»æ¨¡å‹æ–‡ä»¶ä¸­è·å–åŠ¨ä½œåˆ—è¡¨ï¼ˆæŒ‰ç´¢å¼•é¡ºåºå¯¹åº”motionæ–‡ä»¶ï¼‰
                const motions = [
                    { name: 'å¾…æœº', group: '', index: 0 },
                    { name: 'æƒŠè®¶', group: '', index: 1 },
                    { name: 'å¼€å¿ƒ', group: '', index: 2 },
                    { name: 'ç”Ÿæ°”', group: '', index: 3 },
                    { name: 'çœ¨çœ¼', group: '', index: 4 },
                    { name: 'æ‘‡å¤´', group: '', index: 5 },
                    { name: 'è¯´è¯', action: 'talk' }
                ];

                // ç”ŸæˆåŠ¨ä½œæŒ‰é’®
                motions.forEach(motion => {
                    const btn = document.createElement('button');
                    btn.className = 'btn small';
                    btn.textContent = motion.name;
                    btn.onclick = () => {
                        if (motion.action === 'talk') {
                            // ç‰¹æ®Šå¤„ç†è¯´è¯åŠ¨ä½œ
                            this.apiPlayTalk();
                        } else {
                            this.playMotion(motion.group, motion.index);
                        }
                    };
                    motionsContainer.appendChild(btn);
                });

                // ä»æ¨¡å‹æ–‡ä»¶ä¸­è·å–è¡¨æƒ…åˆ—è¡¨
                const expressions = [
                    { name: 'çˆ±å¿ƒçœ¼', file: 'A1çˆ±å¿ƒçœ¼' },
                    { name: 'ç”Ÿæ°”', file: 'A2ç”Ÿæ°”' },
                    { name: 'æ˜Ÿæ˜Ÿçœ¼', file: 'A3æ˜Ÿæ˜Ÿçœ¼' },
                    { name: 'å“­å“­', file: 'A4å“­å“­' },
                    { name: 'éº¦å…‹é£', file: 'B1éº¦å…‹é£' },
                    { name: 'å¤–å¥—', file: 'B2å¤–å¥—' },
                    { name: 'èˆŒå¤´', file: 'èˆŒå¤´' }
                ];

                // ç”Ÿæˆè¡¨æƒ…æŒ‰é’®
                expressions.forEach(expression => {
                    const btn = document.createElement('button');
                    btn.className = 'btn small';
                    btn.textContent = expression.name;
                    btn.onclick = () => this.playExpression(expression.file);
                    expressionsContainer.appendChild(btn);
                });
            }

            playMotion(group, index = 0, skipIdleReturn = false) {
                if (this.model && this.model.internalModel) {
                    try {
                        // ä½¿ç”¨pixi-live2d-displayçš„motionæ–¹æ³•ï¼Œä¼ å…¥ç»„åå’Œç´¢å¼•
                        this.model.motion(group, index);
                        console.log(`æ’­æ”¾åŠ¨ä½œ: ç»„=${group}, ç´¢å¼•=${index}`);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.textContent = `æ’­æ”¾åŠ¨ä½œ: ç´¢å¼• ${index}`;
                        }

                        // å¦‚æœä¸æ˜¯å¾…æœºåŠ¨ä½œä¸”æ²¡æœ‰è·³è¿‡å›å½’ï¼Œåˆ™è®¾ç½®è‡ªåŠ¨å›åˆ°å¾…æœº
                        if (!skipIdleReturn && !(group === '' && index === 0)) {
                            this.scheduleIdleReturn();
                        }
                    } catch (error) {
                        console.error('æ’­æ”¾åŠ¨ä½œå¤±è´¥:', error);
                        // å°è¯•å…¶ä»–æ–¹å¼
                        try {
                            console.log('å°è¯•å¤‡ç”¨æ–¹æ³•...');
                            this.model.internalModel.motionManager.startMotion(group, index);
                            
                            // å¤‡ç”¨æ–¹æ³•æˆåŠŸæ—¶ä¹Ÿè®¾ç½®å›åˆ°å¾…æœº
                            if (!skipIdleReturn && !(group === '' && index === 0)) {
                                this.scheduleIdleReturn();
                            }
                        } catch (fallbackError) {
                            console.error('å¤‡ç”¨æ–¹æ³•ä¹Ÿå¤±è´¥:', fallbackError);
                        }
                    }
                }
            }

            // å®‰æ’å›åˆ°å¾…æœºåŠ¨ä½œ
            scheduleIdleReturn() {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (this.idleReturnTimer) {
                    clearTimeout(this.idleReturnTimer);
                }
                
                // è®¾ç½®æ–°çš„å®šæ—¶å™¨ï¼Œ3ç§’åå›åˆ°å¾…æœº
                this.idleReturnTimer = setTimeout(() => {
                    try {
                        this.playMotion('', 0, true); // skipIdleReturn = true é¿å…å¾ªç¯
                        console.log('è‡ªåŠ¨å›å½’å¾…æœºåŠ¨ä½œ');
                        
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.textContent = 'å·²å›å½’å¾…æœºçŠ¶æ€';
                        }
                    } catch (error) {
                        console.error('è‡ªåŠ¨å›å½’å¾…æœºå¤±è´¥:', error);
                    }
                }, 3000); // 3ç§’åå›åˆ°å¾…æœº
            }

            playExpression(expressionName) {
                if (this.model && this.model.internalModel) {
                    try {
                        // ä½¿ç”¨pixi-live2d-displayçš„expressionæ–¹æ³•
                        this.model.expression(expressionName);
                        console.log(`æ’­æ”¾è¡¨æƒ…: ${expressionName}`);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.textContent = `æ’­æ”¾è¡¨æƒ…: ${expressionName}`;
                        }

                        // è¡¨æƒ…æ’­æ”¾åä¸è‡ªåŠ¨å›å½’ï¼ˆç§»é™¤è¡¨æƒ…é‡ç½®åŠŸèƒ½ï¼‰
                        // this.scheduleIdleReturnWithExpression();
                    } catch (error) {
                        console.error('æ’­æ”¾è¡¨æƒ…å¤±è´¥:', error);
                    }
                }
            }

            // è¡¨æƒ…å›å½’ç›¸å…³æ–¹æ³•å·²ç§»é™¤ï¼Œä¿æŒè¡¨æƒ…çŠ¶æ€ä¸è‡ªåŠ¨é‡ç½®

            // ä¿å­˜åˆå§‹çŠ¶æ€å¿«ç…§
            saveInitialState() {
                if (!this.model || !this.model.internalModel) {
                    console.error('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•ä¿å­˜åˆå§‹çŠ¶æ€');
                    return;
                }

                try {
                    console.log('ğŸ’¾ ä¿å­˜åˆå§‹çŠ¶æ€å¿«ç…§...');
                    
                    const coreModel = this.model.internalModel.coreModel;
                    const parameterCount = coreModel.getParameterCount();
                    
                    // ä¿å­˜æ‰€æœ‰å‚æ•°çš„åˆå§‹å€¼
                    const parameters = [];
                    for (let i = 0; i < parameterCount; i++) {
                        const paramId = coreModel._parameterIds[i];
                        const value = coreModel.getParameterValueByIndex(i);
                        const defaultValue = coreModel.getParameterDefaultValue(i);
                        
                        parameters.push({
                            index: i,
                            id: paramId,
                            value: value,
                            defaultValue: defaultValue
                        });
                    }

                    // ä¿å­˜Parté€æ˜åº¦
                    const parts = [];
                    const partCount = coreModel.getPartCount();
                    for (let i = 0; i < partCount; i++) {
                        parts.push({
                            index: i,
                            opacity: coreModel.getPartOpacityByIndex(i)
                        });
                    }

                    // ä¿å­˜è¡¨æƒ…ç®¡ç†å™¨çŠ¶æ€
                    let expressionState = null;
                    try {
                        if (this.model.internalModel.motionManager && this.model.internalModel.motionManager.expressionManager) {
                            expressionState = {
                                currentExpression: null, // åˆå§‹çŠ¶æ€æ²¡æœ‰è¡¨æƒ…
                                reserveExpressionIndex: -1
                            };
                        }
                    } catch (e) {
                        console.log('è¡¨æƒ…ç®¡ç†å™¨çŠ¶æ€è·å–è·³è¿‡');
                    }

                    // åˆ›å»ºå®Œæ•´å¿«ç…§
                    this.initialStateSnapshot = {
                        timestamp: Date.now(),
                        parameters: parameters,
                        parts: parts,
                        expressionState: expressionState,
                        modelPosition: {
                            x: this.model.x,
                            y: this.model.y,
                            scaleX: this.model.scale.x,
                            scaleY: this.model.scale.y
                        }
                    };

                    console.log(`âœ… åˆå§‹çŠ¶æ€å¿«ç…§å·²ä¿å­˜: ${parameters.length}ä¸ªå‚æ•°, ${parts.length}ä¸ªéƒ¨ä»¶`);
                    console.log('å¿«ç…§è¯¦æƒ…:', this.initialStateSnapshot);

                } catch (error) {
                    console.error('ä¿å­˜åˆå§‹çŠ¶æ€å¤±è´¥:', error);
                }
            }

            // æ¢å¤åˆå§‹çŠ¶æ€å¿«ç…§
            restoreInitialState() {
                if (!this.initialStateSnapshot) {
                    console.error('æ²¡æœ‰æ‰¾åˆ°åˆå§‹çŠ¶æ€å¿«ç…§');
                    return;
                }

                if (!this.model || !this.model.internalModel) {
                    console.error('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•æ¢å¤çŠ¶æ€');
                    return;
                }

                try {
                    console.log('ğŸ”„ å¼€å§‹æ¢å¤åˆå§‹çŠ¶æ€...');
                    
                    const coreModel = this.model.internalModel.coreModel;
                    const snapshot = this.initialStateSnapshot;

                    // æ¢å¤æ‰€æœ‰å‚æ•°å€¼
                    console.log('æ¢å¤å‚æ•°å€¼...');
                    snapshot.parameters.forEach(param => {
                        try {
                            // ä½¿ç”¨åˆå§‹æ—¶çš„å®é™…å€¼ï¼Œä¸æ˜¯é»˜è®¤å€¼
                            coreModel.setParameterValueByIndex(param.index, param.value);
                            console.log(`æ¢å¤å‚æ•° ${param.id}: ${param.value}`);
                        } catch (e) {
                            console.warn(`å‚æ•°${param.id}æ¢å¤å¤±è´¥:`, e.message);
                        }
                    });

                    // æ¢å¤Parté€æ˜åº¦
                    console.log('æ¢å¤éƒ¨ä»¶é€æ˜åº¦...');
                    snapshot.parts.forEach(part => {
                        try {
                            coreModel.setPartOpacityByIndex(part.index, part.opacity);
                        } catch (e) {
                            console.warn(`éƒ¨ä»¶${part.index}é€æ˜åº¦æ¢å¤å¤±è´¥:`, e.message);
                        }
                    });

                    // æ¸…é™¤è¡¨æƒ…çŠ¶æ€
                    console.log('æ¸…é™¤è¡¨æƒ…çŠ¶æ€...');
                    try {
                        this.model.expression('');
                        this.model.expression(null);
                    } catch (e) {
                        console.log('è¡¨æƒ…æ¸…é™¤è·³è¿‡:', e.message);
                    }

                    // å¼ºåˆ¶æ›´æ–°æ¨¡å‹å¤šå¸§
                    console.log('å¼ºåˆ¶æ›´æ–°æ¨¡å‹æ¸²æŸ“...');
                    for (let frame = 0; frame < 10; frame++) {
                        try {
                            if (this.model.internalModel.motionManager) {
                                this.model.internalModel.motionManager.update(0.016);
                            }
                            if (this.model.update) {
                                this.model.update(0.016);
                            }
                        } catch (e) {
                            // å¿½ç•¥æ›´æ–°é”™è¯¯
                        }
                    }

                    // æ¢å¤æ¨¡å‹ä½ç½®ï¼ˆè™½ç„¶é€šå¸¸ä¸ä¼šå˜ï¼‰
                    if (snapshot.modelPosition) {
                        this.model.x = snapshot.modelPosition.x;
                        this.model.y = snapshot.modelPosition.y;
                        this.model.scale.set(snapshot.modelPosition.scaleX, snapshot.modelPosition.scaleY);
                    }

                    // å»¶è¿Ÿæ’­æ”¾å¾…æœºåŠ¨ä½œç¡®ä¿çŠ¶æ€ç¨³å®š
                    setTimeout(() => {
                        this.playMotion('', 0, true); // skipIdleReturn = true é¿å…å¾ªç¯
                        console.log('âœ¨ åˆå§‹çŠ¶æ€å¿«ç…§æ¢å¤å®Œæˆ');
                        
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.textContent = 'å·²å›å½’å¾…æœºçŠ¶æ€';
                        }
                    }, 100);

                } catch (error) {
                    console.error('æ¢å¤åˆå§‹çŠ¶æ€å¤±è´¥:', error);
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šå°è¯•åŸºç¡€é‡ç½®
                    try {
                        this.model.expression('');
                        this.playMotion('', 0, true);
                    } catch (fallbackError) {
                        console.error('å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥:', fallbackError);
                    }
                }
            }

            // å¹³æ»‘æ¸å˜é‡ç½®è¡¨æƒ…åˆ°åˆå§‹çŠ¶æ€
            smoothResetExpression() {
                if (!this.model || !this.model.internalModel) {
                    console.error('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•è¿›è¡Œæ¸å˜é‡ç½®');
                    return;
                }

                try {
                    const coreModel = this.model.internalModel.coreModel;
                    const duration = 500; // æ¸å˜æŒç»­æ—¶é—´500ms
                    const frameRate = 60; // 60FPS
                    const totalFrames = Math.floor(duration / (1000 / frameRate));
                    let currentFrame = 0;

                    console.log(`ğŸ¬ æ¸å˜é‡ç½®åŠ¨ç”»ï¼š${totalFrames}å¸§ï¼ŒæŒç»­${duration}ms`);

                    // æ”¶é›†éœ€è¦é‡ç½®çš„è¡¨æƒ…å‚æ•°çš„åˆå§‹çŠ¶æ€
                    const expressionParams = [];
                    const expressionParamNames = ['axy', 'axy2', 'shengqi', 'shengqi2', 'xxy', 'xxy2', 'kuku', 'kuku2', 'mkf', 'waitao'];
                    
                    for (let i = 0; i < expressionParamNames.length; i++) {
                        const paramName = expressionParamNames[i];
                        const currentValue = coreModel.getParameterValueByIndex(i);
                        const defaultValue = coreModel.getParameterDefaultValue(i);
                        
                        if (Math.abs(currentValue - defaultValue) > 0.001) {
                            expressionParams.push({
                                index: i,
                                name: paramName,
                                startValue: currentValue,
                                targetValue: defaultValue
                            });
                            console.log(`ğŸ“Š å‚æ•° ${paramName}: ${currentValue} â†’ ${defaultValue}`);
                        }
                    }

                    if (expressionParams.length === 0) {
                        console.log('âš ï¸  å‚æ•°å·²æ˜¯é»˜è®¤å€¼ï¼Œä½†å¯èƒ½å­˜åœ¨è§†è§‰åŒæ­¥é—®é¢˜ï¼Œå¼ºåˆ¶åˆ·æ–°æ¸²æŸ“');
                        // å³ä½¿å‚æ•°æ˜¯é»˜è®¤å€¼ï¼Œä¹Ÿè¦å¼ºåˆ¶è§†è§‰åŒæ­¥
                        this.forceVisualSync();
                        return;
                    }

                    // åˆ›å»ºå¹³æ»‘åŠ¨ç”»å‡½æ•°
                    const animateFrame = () => {
                        currentFrame++;
                        const progress = currentFrame / totalFrames;
                        
                        // ä½¿ç”¨ç¼“å‡ºå‡½æ•°åˆ›å»ºæ›´è‡ªç„¶çš„åŠ¨ç”»æ›²çº¿
                        const easeOut = 1 - Math.pow(1 - progress, 3);
                        
                        // æ›´æ–°æ¯ä¸ªéœ€è¦é‡ç½®çš„å‚æ•°
                        expressionParams.forEach(param => {
                            const currentVal = param.startValue + (param.targetValue - param.startValue) * easeOut;
                            coreModel.setParameterValueByIndex(param.index, currentVal);
                        });

                        // å¼ºåˆ¶æ›´æ–°æ¨¡å‹æ¸²æŸ“
                        if (this.model.internalModel.motionManager) {
                            this.model.internalModel.motionManager.update(0.016);
                        }
                        if (this.model.update) {
                            this.model.update(0.016);
                        }

                        // ç»§ç»­åŠ¨ç”»æˆ–å®Œæˆ
                        if (currentFrame < totalFrames) {
                            requestAnimationFrame(animateFrame);
                        } else {
                            console.log('ğŸ¯ æ¸å˜é‡ç½®å®Œæˆ');
                            this.finalizeExpressionReset();
                        }
                    };

                    // å¼€å§‹åŠ¨ç”»
                    requestAnimationFrame(animateFrame);

                } catch (error) {
                    console.error('æ¸å˜é‡ç½®å¤±è´¥:', error);
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥é‡ç½®
                    this.resetExpressionParameters();
                }
            }

            // å¼ºåˆ¶è§†è§‰åŒæ­¥ - è§£å†³å‚æ•°æ­£ç¡®ä½†è§†è§‰æœªæ›´æ–°çš„é—®é¢˜
            forceVisualSync() {
                console.log('ğŸ”„ å¼ºåˆ¶è§†è§‰åŒæ­¥å¼€å§‹...');
                
                try {
                    const coreModel = this.model.internalModel.coreModel;
                    
                    // æ–¹æ³•1: é€šè¿‡å¾®å°æ‰°åŠ¨å¼ºåˆ¶æ›´æ–°è§†è§‰
                    console.log('æ–¹æ³•1: å¾®æ‰°åŠ¨åŒæ­¥');
                    const expressionParamNames = ['axy', 'axy2', 'shengqi', 'shengqi2', 'xxy', 'xxy2', 'kuku', 'kuku2', 'mkf', 'waitao'];
                    
                    expressionParamNames.forEach((paramName, index) => {
                        const defaultValue = coreModel.getParameterDefaultValue(index);
                        
                        // å…ˆè®¾ç½®ä¸€ä¸ªæå°çš„åç§»å€¼ï¼Œå†è®¾å›é»˜è®¤å€¼ï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°
                        coreModel.setParameterValueByIndex(index, defaultValue + 0.001);
                        coreModel.setParameterValueByIndex(index, defaultValue - 0.001);
                        coreModel.setParameterValueByIndex(index, defaultValue);
                        
                        console.log(`å¾®æ‰°åŠ¨: ${paramName} = ${defaultValue}`);
                    });
                    
                    // æ–¹æ³•2: å¼ºåˆ¶å¤šæ¬¡æ›´æ–°æ¸²æŸ“
                    console.log('æ–¹æ³•2: å¼ºåˆ¶æ¸²æŸ“æ›´æ–°');
                    for (let frame = 0; frame < 30; frame++) {
                        // æ›´æ–°motionManager
                        if (this.model.internalModel.motionManager) {
                            this.model.internalModel.motionManager.update(0.016);
                        }
                        
                        // æ›´æ–°æ¨¡å‹
                        if (this.model.update) {
                            this.model.update(0.016);
                        }
                        
                        // æ›´æ–°å†…éƒ¨æ¨¡å‹
                        if (this.model.internalModel.update) {
                            this.model.internalModel.update(0.016);
                        }
                    }
                    
                    // æ–¹æ³•3: å¼ºåˆ¶è¡¨æƒ…APIå¤šæ¬¡è°ƒç”¨
                    console.log('æ–¹æ³•3: è¡¨æƒ…APIå¼ºåˆ¶é‡ç½®');
                    try {
                        this.model.expression('');
                        this.model.expression(null);
                        this.model.expression('');
                        
                        // å†æ¬¡æ›´æ–°æ¸²æŸ“
                        for (let i = 0; i < 10; i++) {
                            if (this.model.internalModel.motionManager) {
                                this.model.internalModel.motionManager.update(0.016);
                            }
                        }
                    } catch (e) {
                        console.log('è¡¨æƒ…APIè°ƒç”¨å¼‚å¸¸:', e.message);
                    }
                    
                    // æ–¹æ³•4: PIXIå¼ºåˆ¶é‡ç»˜
                    console.log('æ–¹æ³•4: PIXIå¼ºåˆ¶é‡ç»˜');
                    if (this.app) {
                        this.app.render();
                        if (this.app.ticker) {
                            this.app.ticker.update();
                        }
                    }
                    
                    // æ–¹æ³•5: å»¶è¿Ÿå¤šæ¬¡ç¡®è®¤
                    setTimeout(() => {
                        console.log('å»¶è¿Ÿç¡®è®¤è§†è§‰åŒæ­¥...');
                        for (let i = 0; i < 5; i++) {
                            if (this.model.update) this.model.update(0.016);
                        }
                        
                        // æœ€åæ’­æ”¾å¾…æœºåŠ¨ä½œ
                        setTimeout(() => {
                            this.playMotion('', 0, true);
                            console.log('ğŸ¯ å¼ºåˆ¶è§†è§‰åŒæ­¥å®Œæˆ');
                        }, 100);
                    }, 200);
                    
                } catch (error) {
                    console.error('å¼ºåˆ¶è§†è§‰åŒæ­¥å¤±è´¥:', error);
                }
            }

            // å®Œæˆè¡¨æƒ…é‡ç½®åçš„æœ€ç»ˆå¤„ç†
            finalizeExpressionReset() {
                try {
                    // æœ€ç»ˆç¡®ä¿æ‰€æœ‰å‚æ•°éƒ½æ˜¯ç²¾ç¡®çš„é»˜è®¤å€¼
                    const coreModel = this.model.internalModel.coreModel;
                    const expressionParamNames = ['axy', 'axy2', 'shengqi', 'shengqi2', 'xxy', 'xxy2', 'kuku', 'kuku2', 'mkf', 'waitao'];
                    
                    expressionParamNames.forEach((paramName, index) => {
                        const defaultValue = coreModel.getParameterDefaultValue(index);
                        coreModel.setParameterValueByIndex(index, defaultValue);
                    });

                    // é¢å¤–çš„è¡¨æƒ…APIé‡ç½®
                    this.model.expression('');
                    this.model.expression(null);

                    // å¼ºåˆ¶æ›´æ–°å‡ å¸§ç¡®ä¿ç”Ÿæ•ˆ
                    for (let i = 0; i < 5; i++) {
                        if (this.model.internalModel.motionManager) {
                            this.model.internalModel.motionManager.update(0.016);
                        }
                        if (this.model.update) {
                            this.model.update(0.016);
                        }
                    }

                    // å»¶è¿Ÿæ’­æ”¾å¾…æœºåŠ¨ä½œ
                    setTimeout(() => {
                        this.playMotion('', 0, true); // skipIdleReturn = true é¿å…å¾ªç¯
                        console.log('âœ¨ è¡¨æƒ…æ¸å˜é‡ç½®å®Œæˆï¼Œå·²å›å½’å¾…æœºçŠ¶æ€');
                        
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.textContent = 'å·²å›å½’å¾…æœºçŠ¶æ€';
                        }
                    }, 100);

                } catch (error) {
                    console.error('æœ€ç»ˆé‡ç½®å¤„ç†å¤±è´¥:', error);
                }
            }

            // å‚æ•°é‡ç½®æ–¹æ³• - ç›´æ¥é‡ç½®è¡¨æƒ…å‚æ•°ï¼Œé¿å…æ¨¡å‹é—ªçƒ
            resetExpressionParameters() {
                if (!this.model || !this.model.internalModel) {
                    console.error('æ¨¡å‹æœªåŠ è½½ï¼Œæ— æ³•é‡ç½®è¡¨æƒ…å‚æ•°');
                    return;
                }

                try {
                    console.log('ğŸ”„ å¼€å§‹é‡ç½®è¡¨æƒ…å‚æ•°...');
                    console.log('æ¨¡å‹å¯¹è±¡:', this.model);
                    console.log('å†…éƒ¨æ¨¡å‹:', this.model.internalModel);
                    
                    // å…ˆå°è¯•æ‰€æœ‰å·²çŸ¥çš„é‡ç½®æ–¹æ³•
                    let success = false;
                    
                    // æ–¹æ³•1: ä½¿ç”¨Live2D Core APIç›´æ¥é‡ç½®å‚æ•°
                    const coreModel = this.model.internalModel.coreModel;
                    console.log('Coreæ¨¡å‹:', coreModel);
                    
                    if (coreModel) {
                        const parameterCount = coreModel.getParameterCount();
                        console.log(`å‘ç° ${parameterCount} ä¸ªå‚æ•°`);
                        let resetCount = 0;
                        
                        // å…ˆæ£€æŸ¥Coreæ¨¡å‹çš„å¯ç”¨æ–¹æ³•
                        console.log('=== Coreæ¨¡å‹å¯ç”¨æ–¹æ³• ===');
                        console.log('Coreæ¨¡å‹å±æ€§:', Object.keys(coreModel));
                        console.log('Coreæ¨¡å‹æ–¹æ³•:', Object.getOwnPropertyNames(Object.getPrototypeOf(coreModel)));
                        
                        // å°è¯•ä¸åŒçš„APIæ–¹æ³•åç§°
                        const possibleMethods = [
                            'getParameterId', 'getParameterIds', '_parameterIds',
                            'getParameterDefaultValue', 'getParameterDefaultValues', '_parameterDefaultValues',
                            'getParameterValue', 'getParameterValues', '_parameterValues',
                            'setParameterValue', 'setParameterValues'
                        ];
                        
                        console.log('=== æ£€æŸ¥APIæ–¹æ³•å¯ç”¨æ€§ ===');
                        possibleMethods.forEach(method => {
                            console.log(`${method}: ${typeof coreModel[method]}`);
                        });
                        
                        // ä½¿ç”¨æ­£ç¡®çš„APIæ–¹æ³•é‡ç½®å‚æ•°
                        console.log('=== ä½¿ç”¨æ­£ç¡®APIé‡ç½®å‚æ•° ===');
                        
                        for (let i = 0; i < parameterCount; i++) {
                            try {
                                // ä½¿ç”¨æ­£ç¡®çš„APIè·å–å‚æ•°ä¿¡æ¯
                                const parameterId = coreModel._parameterIds[i];
                                const currentValue = coreModel.getParameterValueByIndex(i);
                                const defaultValue = coreModel.getParameterDefaultValue(i);
                                
                                // åªæ˜¾ç¤ºå‰20ä¸ªå‚æ•°çš„è¯¦ç»†ä¿¡æ¯ï¼Œé¿å…æ—¥å¿—è¿‡å¤š
                                if (i < 20) {
                                    console.log(`å‚æ•°${i}: ${parameterId}`);
                                    console.log(`  å½“å‰å€¼: ${currentValue}, é»˜è®¤å€¼: ${defaultValue}`);
                                }
                                
                                // æ£€æŸ¥æ˜¯å¦æ˜¯è¡¨æƒ…ç›¸å…³å‚æ•°å¹¶éœ€è¦é‡ç½®
                                const isExpressionParam = this.isExpressionParameterByName(parameterId);
                                const needsReset = Math.abs(currentValue - defaultValue) > 0.001;
                                
                                if (isExpressionParam && needsReset) {
                                    console.log(`ğŸ¯ é‡ç½®è¡¨æƒ…å‚æ•°: ${parameterId} ${currentValue} â†’ ${defaultValue}`);
                                    coreModel.setParameterValueByIndex(i, defaultValue);
                                    resetCount++;
                                    success = true;
                                } else if (needsReset && i < 20) {
                                    console.log(`â­ï¸  è·³è¿‡éè¡¨æƒ…å‚æ•°: ${parameterId}`);
                                }
                                
                            } catch (e) {
                                if (i < 5) { // åªæ˜¾ç¤ºå‰å‡ ä¸ªé”™è¯¯
                                    console.error(`å‚æ•°${i}å¤„ç†å¤±è´¥:`, e.message);
                                }
                            }
                        }
                        
                        console.log(`âœ“ å‚æ•°æ‰«æå®Œæˆï¼Œé‡ç½®äº† ${resetCount} ä¸ªå‚æ•°`);
                    }
                    
                    // æ–¹æ³•2: pixi-live2d-displayçš„è¡¨æƒ…API
                    try {
                        console.log('å°è¯•è¡¨æƒ…APIé‡ç½®...');
                        this.model.expression(''); // ç©ºå­—ç¬¦ä¸²åº”è¯¥æ¸…é™¤è¡¨æƒ…
                        this.model.expression(null); // nullå€¼é‡ç½®
                        console.log('âœ“ è¡¨æƒ…APIè°ƒç”¨å®Œæˆ');
                        success = true;
                    } catch (e) {
                        console.error('è¡¨æƒ…APIé‡ç½®å¤±è´¥:', e);
                    }
                    
                    // æ–¹æ³•3: è¡¨æƒ…ç®¡ç†å™¨é‡ç½®
                    try {
                        console.log('æ£€æŸ¥è¡¨æƒ…ç®¡ç†å™¨...');
                        const motionManager = this.model.internalModel.motionManager;
                        console.log('Motionç®¡ç†å™¨:', motionManager);
                        
                        if (motionManager) {
                            // æŸ¥æ‰¾è¡¨æƒ…ç®¡ç†å™¨
                            if (motionManager.expressionManager) {
                                console.log('æ‰¾åˆ°è¡¨æƒ…ç®¡ç†å™¨:', motionManager.expressionManager);
                                motionManager.expressionManager.setExpression(null);
                                success = true;
                            }
                            
                            // å¼ºåˆ¶æ›´æ–°å¤šå¸§ç¡®ä¿ç”Ÿæ•ˆ
                            for (let i = 0; i < 5; i++) {
                                motionManager.update(0.016);
                            }
                            console.log('âœ“ å¼ºåˆ¶æ›´æ–°5å¸§å®Œæˆ');
                        }
                    } catch (e) {
                        console.error('è¡¨æƒ…ç®¡ç†å™¨é‡ç½®å¤±è´¥:', e);
                    }
                    
                    // æ–¹æ³•4: å¼ºåˆ¶åˆ·æ–°æ¨¡å‹æ˜¾ç¤º - å¤šç§æ–¹æ³•ç»„åˆ
                    try {
                        console.log('ğŸ”„ å¼ºåˆ¶åˆ·æ–°æ¨¡å‹æ˜¾ç¤º...');
                        
                        // å¼ºåˆ¶æ›´æ–°å¤šå¸§ç¡®ä¿å‚æ•°ç”Ÿæ•ˆåˆ°è§†è§‰å±‚
                        for (let frame = 0; frame < 10; frame++) {
                            if (this.model.update) {
                                this.model.update(0.016);
                            }
                            if (this.model.internalModel && this.model.internalModel.update) {
                                this.model.internalModel.update(0.016);
                            }
                        }
                        
                        // å¼ºåˆ¶é‡ç»˜
                        if (this.model._refresh) {
                            this.model._refresh();
                        }
                        
                        // è§¦å‘æ¸²æŸ“å™¨æ›´æ–°
                        if (this.app && this.app.render) {
                            this.app.render();
                        }
                        
                        // å¼ºåˆ¶PIXIé‡ç»˜
                        if (this.model.texture) {
                            this.model.texture.update();
                        }
                        
                        console.log('âœ“ æ¨¡å‹å¼ºåˆ¶åˆ·æ–°å®Œæˆ(10å¸§)');
                    } catch (e) {
                        console.error('æ¨¡å‹åˆ·æ–°å¤±è´¥:', e);
                    }
                    
                    // æ–¹æ³•5: å»¶è¿Ÿå†æ¬¡ç¡®è®¤é‡ç½®
                    setTimeout(() => {
                        try {
                            console.log('ğŸ” å»¶è¿ŸéªŒè¯é‡ç½®æ•ˆæœ...');
                            
                            // å†æ¬¡æ£€æŸ¥å…³é”®è¡¨æƒ…å‚æ•°çš„å€¼
                            const keyParams = ['shengqi', 'shengqi2', 'axy', 'axy2', 'xxy', 'xxy2', 'kuku', 'kuku2'];
                            keyParams.forEach((paramName, index) => {
                                const currentValue = coreModel.getParameterValueByIndex(index);
                                const defaultValue = coreModel.getParameterDefaultValue(index);
                                console.log(`éªŒè¯ ${paramName}: å½“å‰=${currentValue}, é»˜è®¤=${defaultValue}`);
                                
                                // å¦‚æœä»æœ‰å·®å¼‚ï¼Œå†æ¬¡å¼ºåˆ¶é‡ç½®
                                if (Math.abs(currentValue - defaultValue) > 0.001) {
                                    coreModel.setParameterValueByIndex(index, defaultValue);
                                    console.log(`ğŸ”§ äºŒæ¬¡é‡ç½®: ${paramName}`);
                                }
                            });
                            
                            // å†æ¬¡å¼ºåˆ¶æ›´æ–°
                            for (let i = 0; i < 5; i++) {
                                if (this.model.update) this.model.update(0.016);
                            }
                            
                            console.log('âœ… å»¶è¿ŸéªŒè¯å®Œæˆ');
                            
                        } catch (e) {
                            console.error('å»¶è¿ŸéªŒè¯å¤±è´¥:', e);
                        }
                    }, 500); // 500msåéªŒè¯
                    
                    if (success) {
                        console.log('ğŸ‰ è¡¨æƒ…é‡ç½®æ“ä½œå·²æ‰§è¡Œ');
                    } else {
                        console.error('âŒ æ‰€æœ‰é‡ç½®æ–¹æ³•éƒ½å¤±è´¥äº†');
                        // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
                        this.fallbackExpressionReset();
                    }

                } catch (error) {
                    console.error('âŒ è¡¨æƒ…å‚æ•°é‡ç½®è¿‡ç¨‹å‡ºé”™:', error);
                    this.fallbackExpressionReset();
                }
            }

            // å¤‡ç”¨è¡¨æƒ…é‡ç½®æ–¹æ¡ˆ
            fallbackExpressionReset() {
                console.log('ğŸš¨ ä½¿ç”¨æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ...');
                try {
                    // å°è¯•æ’­æ”¾ä¸€ä¸ª"ç©º"çš„è¡¨æƒ…åŠ¨ä½œ
                    if (this.model.motion) {
                        this.model.motion('', 0); // æ’­æ”¾å¾…æœºåŠ¨ä½œæ¥è¦†ç›–è¡¨æƒ…
                    }
                    
                    // ç­‰å¾…ä¸€ç‚¹æ—¶é—´å†æ’­æ”¾æ ‡å‡†å¾…æœº
                    setTimeout(() => {
                        if (this.model.motion) {
                            this.model.motion('', 0);
                            console.log('âœ“ å¤‡ç”¨æ–¹æ¡ˆï¼šæ’­æ”¾å¾…æœºåŠ¨ä½œ');
                        }
                    }, 100);
                    
                } catch (e) {
                    console.error('å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥:', e);
                }
            }

            // åˆ¤æ–­å‚æ•°æ˜¯å¦ä¸è¡¨æƒ…ç›¸å…³ï¼ˆåŸºäºå®é™…æ¨¡å‹å‚æ•°åï¼‰
            isExpressionParameterByName(parameterId) {
                // æ ¹æ®æ§åˆ¶å°è¾“å‡ºï¼Œè¿™ä¸ªæ¨¡å‹çš„è¡¨æƒ…å‚æ•°åç§°
                const expressionParams = [
                    'axy',        // çˆ±å¿ƒçœ¼
                    'axy2',       // çˆ±å¿ƒçœ¼2
                    'shengqi',    // ç”Ÿæ°”
                    'shengqi2',   // ç”Ÿæ°”2  
                    'xxy',        // æ˜Ÿæ˜Ÿçœ¼
                    'xxy2',       // æ˜Ÿæ˜Ÿçœ¼2
                    'kuku',       // å“­å“­
                    'kuku2',      // å“­å“­2
                    'mkf',        // éº¦å…‹é£
                    'waitao',     // å¤–å¥—
                    'shetou'      // èˆŒå¤´ (ä»æ¨¡å‹æ–‡ä»¶æ¨æµ‹)
                ];
                
                return expressionParams.includes(parameterId);
            }

            // åŸæ¥çš„é€šç”¨è¡¨æƒ…å‚æ•°æ£€æµ‹æ–¹æ³•ï¼ˆå¤‡ç”¨ï¼‰
            isExpressionParameter(parameterId) {
                // Live2Dè¡¨æƒ…é€šå¸¸ä¼šå½±å“è¿™äº›å‚æ•°
                const expressionKeywords = [
                    'ParamEyeL',      // å·¦çœ¼ç›¸å…³
                    'ParamEyeR',      // å³çœ¼ç›¸å…³
                    'ParamEyeBallX',  // çœ¼çƒX
                    'ParamEyeBallY',  // çœ¼çƒY
                    'ParamBrowL',     // å·¦çœ‰æ¯›
                    'ParamBrowR',     // å³çœ‰æ¯›
                    'ParamMouth',     // å˜´éƒ¨
                    'ParamCheek',     // è„¸é¢Š
                    'ParamFace',      // è„¸éƒ¨è¡¨æƒ…
                    'ParamTears',     // çœ¼æ³ª
                    'ParamSweat',     // æ±—æ°´
                    'Param',          // é€šç”¨å‚æ•°å‰ç¼€
                    'Eye',            // çœ¼ç›ç›¸å…³
                    'Mouth',          // å˜´å·´ç›¸å…³
                    'Brow',           // çœ‰æ¯›ç›¸å…³
                    'Face'            // è„¸éƒ¨ç›¸å…³
                ];
                
                return expressionKeywords.some(keyword => 
                    parameterId.includes(keyword)
                );
            }

            // ========== APIè°ƒç”¨æ–¹æ³• ==========
            
            // çŠ¶æ€è°ƒç”¨API
            apiPlayIdle() {
                this.playMotion('', 0);
                return { success: true, message: 'æ’­æ”¾å¾…æœºçŠ¶æ€', action: 'idle' };
            }

            apiPlayJingya() {
                this.playMotion('', 1);
                return { success: true, message: 'æ’­æ”¾æƒŠè®¶çŠ¶æ€', action: 'jingya' };
            }

            apiPlayKaixin() {
                this.playMotion('', 2);
                return { success: true, message: 'æ’­æ”¾å¼€å¿ƒçŠ¶æ€', action: 'kaixin' };
            }

            apiPlayShengqi() {
                this.playMotion('', 3);
                return { success: true, message: 'æ’­æ”¾ç”Ÿæ°”çŠ¶æ€', action: 'shengqi' };
            }

            apiPlayWink() {
                this.playMotion('', 4);
                return { success: true, message: 'æ’­æ”¾çœ¨çœ¼çŠ¶æ€', action: 'wink' };
            }

            apiPlayYaotou() {
                this.playMotion('', 5);
                return { success: true, message: 'æ’­æ”¾æ‘‡å¤´çŠ¶æ€', action: 'yaotou' };
            }

            apiPlayTalk() {
                // è¯´è¯åŠ¨ä½œé€šè¿‡LipSyncå‚æ•°å®ç°å˜´éƒ¨åŠ¨ä½œ
                if (!this.model) {
                    return { success: false, message: 'æ¨¡å‹æœªåŠ è½½', error: 'MODEL_NOT_READY' };
                }
                
                // å°è¯•ç›´æ¥æ§åˆ¶å˜´éƒ¨å‚æ•°
                try {
                    console.log('ğŸ—£ï¸ å¼€å§‹è°ƒè¯•è¯´è¯åŠ¨ä½œ...');
                    console.log('æ¨¡å‹ç»“æ„:', this.model);
                    console.log('å†…éƒ¨æ¨¡å‹:', this.model.internalModel);
                    
                    // æ”¶é›†æ‰€æœ‰å˜´éƒ¨ç›¸å…³å‚æ•°
                    let mouthParams = [];
                    
                    // æ–¹æ³•1: å°è¯•é€šè¿‡PIXI Live2Dçš„æ¥å£
                    if (this.model.internalModel && this.model.internalModel.coreModel) {
                        const coreModel = this.model.internalModel.coreModel;
                        console.log('Core Model:', coreModel);
                        
                        // å°è¯•è·å–å‚æ•°ä¿¡æ¯
                        try {
                            const paramCount = coreModel.getParameterCount ? coreModel.getParameterCount() : 0;
                            console.log('å‚æ•°æ€»æ•°:', paramCount);
                            
                            if (paramCount > 0) {
                                console.log('ğŸ” å¼€å§‹æœç´¢æ‰€æœ‰å˜´éƒ¨å‚æ•°...');
                                // æœç´¢æ‰€æœ‰168ä¸ªå‚æ•°ï¼Œå¯»æ‰¾æ‰€æœ‰å˜´éƒ¨ç›¸å…³çš„
                                for (let i = 0; i < paramCount; i++) {
                                    try {
                                        // è·å–å‚æ•°å
                                        let paramId = null;
                                        if (coreModel._parameterIds && coreModel._parameterIds[i]) {
                                            paramId = coreModel._parameterIds[i];
                                        }
                                        
                                        if (paramId) {
                                            // æœç´¢å˜´éƒ¨ç›¸å…³å‚æ•° - æ‰©å±•æœç´¢èŒƒå›´
                                            if (paramId.toLowerCase().includes('mouth') || 
                                                paramId.toLowerCase().includes('lip') ||
                                                paramId.includes('å£') || 
                                                paramId.includes('PARAM_MOUTH') ||
                                                paramId.includes('ParamMouth') ||
                                                paramId.toLowerCase().includes('å˜´') ||
                                                // æ ¹æ®ä½ çš„æ¨¡å‹å‚æ•°ï¼Œå¯èƒ½è¿˜æœ‰å…¶ä»–ä¸­æ–‡å‚æ•°
                                                paramId.includes('å˜´') ||
                                                paramId.includes('mouth') ||
                                                paramId.includes('Mouth')) {
                                                
                                                const originalValue = coreModel.getParameterValueByIndex(i);
                                                const minValue = coreModel.getParameterMinimumValue(i);
                                                const maxValue = coreModel.getParameterMaximumValue(i);
                                                
                                                mouthParams.push({
                                                    index: i,
                                                    name: paramId,
                                                    originalValue: originalValue,
                                                    minValue: minValue,
                                                    maxValue: maxValue
                                                });
                                                
                                                console.log(`ğŸ¯ æ‰¾åˆ°å˜´éƒ¨å‚æ•°: ${paramId} (ç´¢å¼•:${i}) å½“å‰å€¼:${originalValue} èŒƒå›´:[${minValue}, ${maxValue}]`);
                                            }
                                        }
                                    } catch (e) {
                                        console.warn(`è·å–å‚æ•° ${i} å¤±è´¥:`, e);
                                    }
                                }
                                
                                console.log(`âœ… æ‰¾åˆ° ${mouthParams.length} ä¸ªå˜´éƒ¨ç›¸å…³å‚æ•°:`, mouthParams);
                                
                                // å¦‚æœæ‰¾åˆ°å˜´éƒ¨å‚æ•°ï¼Œåˆ›å»ºè¯´è¯åŠ¨ç”»
                                if (mouthParams.length > 0) {
                                    let animationStep = 0;
                                    const talkAnimation = setInterval(() => {
                                        // ä¸ºæ¯ä¸ªå˜´éƒ¨å‚æ•°åˆ›å»ºä¸åŒçš„åŠ¨ç”»
                                        mouthParams.forEach((param, index) => {
                                            let value;
                                            const range = param.maxValue - param.minValue;
                                            const mid = param.minValue + range * 0.5;
                                            
                                            if (param.name.includes('Form') || param.name.includes('form')) {
                                                // å˜´å½¢å‚æ•°ï¼šåˆ›å»ºå‘¨æœŸæ€§å˜åŒ–
                                                value = mid + Math.sin(animationStep * 0.7 + index) * range * 0.4;
                                            } else if (param.name.includes('Open') || param.name.includes('open')) {
                                                // å¼€å£å‚æ•°ï¼šéšæœºå¼€åˆ
                                                value = param.minValue + (Math.sin(animationStep * 0.8) * 0.5 + 0.5) * range * 0.8;
                                            } else {
                                                // å…¶ä»–å˜´éƒ¨å‚æ•°ï¼šè½»å¾®å˜åŒ–
                                                value = mid + Math.sin(animationStep * 0.6 + index * 0.5) * range * 0.3;
                                            }
                                            
                                            // ç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
                                            value = Math.max(param.minValue, Math.min(param.maxValue, value));
                                            coreModel.setParameterValueByIndex(param.index, value);
                                        });
                                        
                                        animationStep++;
                                        
                                        if (animationStep > 40) { // çº¦3.2ç§’åŠ¨ç”»
                                            clearInterval(talkAnimation);
                                            // æ¢å¤æ‰€æœ‰å‚æ•°çš„åŸå§‹å€¼
                                            mouthParams.forEach(param => {
                                                coreModel.setParameterValueByIndex(param.index, param.originalValue);
                                            });
                                            console.log('ğŸ”„ è¯´è¯åŠ¨ç”»ç»“æŸï¼Œæ¢å¤åŸå§‹å˜´å½¢');
                                        }
                                    }, 80);
                                }
                            }
                        } catch (e) {
                            console.error('è·å–å‚æ•°æ•°é‡å¤±è´¥:', e);
                        }
                    }
                    
                    if (mouthParams.length === 0) {
                        console.log('âš ï¸ æœªæ‰¾åˆ°å˜´éƒ¨å‚æ•°ï¼Œä½¿ç”¨çœ¨çœ¼æ›¿ä»£åŠ¨ä½œ');
                        // ç®€å•çš„æ›¿ä»£åŠ¨ä½œ - æ’­æ”¾çœ¨çœ¼åŠ¨ä½œ
                        this.playMotion('', 4); // æ’­æ”¾çœ¨çœ¼åŠ¨ä½œ
                        return { success: true, message: 'æ’­æ”¾è¯´è¯åŠ¨ä½œ(çœ¨çœ¼æ›¿ä»£)', action: 'talk' };
                    }
                    
                    return { success: true, message: 'æ’­æ”¾è¯´è¯åŠ¨ä½œ', action: 'talk' };
                    
                } catch (error) {
                    console.error('ğŸ’¥ è¯´è¯åŠ¨ä½œå®ç°å¤±è´¥:', error);
                    console.error('é”™è¯¯å †æ ˆ:', error.stack);
                    // ä½¿ç”¨å¾…æœºåŠ¨ä½œä½œä¸ºæœ€ç»ˆæ›¿ä»£
                    this.playMotion('', 0);
                    return { success: true, message: 'æ’­æ”¾è¯´è¯åŠ¨ä½œ(é”™è¯¯æ›¿ä»£)', action: 'talk' };
                }
            }

            // è¡¨æƒ…è°ƒç”¨API
            apiPlayLoveEyes() {
                this.playExpression('A1çˆ±å¿ƒçœ¼');
                return { success: true, message: 'æ’­æ”¾çˆ±å¿ƒçœ¼è¡¨æƒ…', expression: 'love_eyes' };
            }

            apiPlayAngryFace() {
                this.playExpression('A2ç”Ÿæ°”');
                return { success: true, message: 'æ’­æ”¾ç”Ÿæ°”è¡¨æƒ…', expression: 'angry' };
            }

            apiPlayStarEyes() {
                this.playExpression('A3æ˜Ÿæ˜Ÿçœ¼');
                return { success: true, message: 'æ’­æ”¾æ˜Ÿæ˜Ÿçœ¼è¡¨æƒ…', expression: 'star_eyes' };
            }

            apiPlayCrying() {
                this.playExpression('A4å“­å“­');
                return { success: true, message: 'æ’­æ”¾å“­å“­è¡¨æƒ…', expression: 'crying' };
            }

            apiPlayMicrophone() {
                this.playExpression('B1éº¦å…‹é£');
                return { success: true, message: 'æ’­æ”¾éº¦å…‹é£è¡¨æƒ…', expression: 'microphone' };
            }

            apiPlayCoat() {
                this.playExpression('B2å¤–å¥—');
                return { success: true, message: 'æ’­æ”¾å¤–å¥—è¡¨æƒ…', expression: 'coat' };
            }

            apiPlayTongue() {
                this.playExpression('èˆŒå¤´');
                return { success: true, message: 'æ’­æ”¾èˆŒå¤´è¡¨æƒ…', expression: 'tongue' };
            }

            // é€šç”¨APIè°ƒç”¨æ–¹æ³•
            apiCall(type, name) {
                if (!this.isLoaded) {
                    return { success: false, message: 'æ¨¡å‹æœªåŠ è½½å®Œæˆ', error: 'MODEL_NOT_READY' };
                }

                try {
                    if (type === 'action') {
                        switch (name) {
                            case 'idle': return this.apiPlayIdle();
                            case 'jingya': return this.apiPlayJingya();
                            case 'kaixin': return this.apiPlayKaixin();
                            case 'shengqi': return this.apiPlayShengqi();
                            case 'wink': return this.apiPlayWink();
                            case 'yaotou': return this.apiPlayYaotou();
                            case 'talk': return this.apiPlayTalk();
                            default:
                                return { success: false, message: `æœªçŸ¥çŠ¶æ€: ${name}`, error: 'UNKNOWN_ACTION' };
                        }
                    } else if (type === 'expression') {
                        switch (name) {
                            case 'love_eyes': return this.apiPlayLoveEyes();
                            case 'angry': return this.apiPlayAngryFace();
                            case 'star_eyes': return this.apiPlayStarEyes();
                            case 'crying': return this.apiPlayCrying();
                            case 'microphone': return this.apiPlayMicrophone();
                            case 'coat': return this.apiPlayCoat();
                            case 'tongue': return this.apiPlayTongue();
                            default:
                                return { success: false, message: `æœªçŸ¥è¡¨æƒ…: ${name}`, error: 'UNKNOWN_EXPRESSION' };
                        }
                    } else {
                        return { success: false, message: `æœªçŸ¥ç±»å‹: ${type}`, error: 'UNKNOWN_TYPE' };
                    }
                } catch (error) {
                    console.error('APIè°ƒç”¨å¤±è´¥:', error);
                    return { success: false, message: `è°ƒç”¨å¤±è´¥: ${error.message}`, error: 'EXECUTION_FAILED' };
                }
            }

            // è·å–æ‰€æœ‰å¯ç”¨çš„çŠ¶æ€å’Œè¡¨æƒ…åˆ—è¡¨
            apiGetAvailableList() {
                return {
                    success: true,
                    data: {
                        actions: [
                            { id: 'idle', name: 'å¾…æœº', description: 'å›åˆ°å¾…æœºçŠ¶æ€' },
                            { id: 'jingya', name: 'æƒŠè®¶', description: 'è¡¨ç°æƒŠè®¶çš„åŠ¨ä½œ' },
                            { id: 'kaixin', name: 'å¼€å¿ƒ', description: 'è¡¨ç°å¼€å¿ƒçš„åŠ¨ä½œ' },
                            { id: 'shengqi', name: 'ç”Ÿæ°”', description: 'è¡¨ç°ç”Ÿæ°”çš„åŠ¨ä½œ' },
                            { id: 'wink', name: 'çœ¨çœ¼', description: 'çœ¨çœ¼åŠ¨ä½œ' },
                            { id: 'yaotou', name: 'æ‘‡å¤´', description: 'æ‘‡å¤´åŠ¨ä½œ' },
                            { id: 'talk', name: 'è¯´è¯', description: 'è¯´è¯æ—¶çš„å˜´éƒ¨åŠ¨ä½œ' }
                        ],
                        expressions: [
                            { id: 'love_eyes', name: 'çˆ±å¿ƒçœ¼', description: 'çˆ±å¿ƒå½¢çŠ¶çš„çœ¼ç›è¡¨æƒ…' },
                            { id: 'angry', name: 'ç”Ÿæ°”', description: 'ç”Ÿæ°”çš„é¢éƒ¨è¡¨æƒ…' },
                            { id: 'star_eyes', name: 'æ˜Ÿæ˜Ÿçœ¼', description: 'æ˜Ÿæ˜Ÿå½¢çŠ¶çš„çœ¼ç›è¡¨æƒ…' },
                            { id: 'crying', name: 'å“­å“­', description: 'å“­æ³£çš„è¡¨æƒ…' },
                            { id: 'microphone', name: 'éº¦å…‹é£', description: 'æ‰‹æŒéº¦å…‹é£çš„è¡¨æƒ…' },
                            { id: 'coat', name: 'å¤–å¥—', description: 'ç©¿å¤–å¥—çš„è£…æ‰®è¡¨æƒ…' },
                            { id: 'tongue', name: 'èˆŒå¤´', description: 'åèˆŒå¤´çš„è¡¨æƒ…' }
                        ]
                    }
                };
            }

            // åŸæœ‰çš„å…¨å±€æ–¹æ³•ä¿æŒå…¼å®¹
            playTalk() {
                return this.apiPlayTalk();
            }

            playIdle() {
                return this.apiPlayIdle();
            }
        }

        // ========== å°æ™ºAIå®¢æˆ·ç«¯ ==========
        class XiaozhiAIClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.isRecording = false;
                this.sessionId = null;
                
                // éŸ³é¢‘ç›¸å…³
                this.audioContext = null;
                this.processor = null;
                this.mediaStream = null;
                
                // UIå…ƒç´ 
                this.voiceBtn = document.getElementById('voice-btn');
                this.statusDiv = document.getElementById('voice-status');
                this.interruptBtn = document.getElementById('interrupt-btn');
                
                this.bindEvents();
                this.updateDeviceInfo();
            }

            bindEvents() {
                this.voiceBtn.addEventListener('click', () => {
                    if (!this.isConnected) {
                        this.connectToXiaozhi();
                    }
                });

                // é•¿æŒ‰å½•éŸ³
                this.voiceBtn.addEventListener('mousedown', (e) => {
                    if (this.isConnected && !this.isRecording) {
                        e.preventDefault();
                        this.startRecording();
                    }
                });

                this.voiceBtn.addEventListener('mouseup', (e) => {
                    if (this.isRecording) {
                        e.preventDefault();
                        this.stopRecording();
                    }
                });

                // è§¦æ‘¸æ”¯æŒ
                this.voiceBtn.addEventListener('touchstart', (e) => {
                    if (this.isConnected && !this.isRecording) {
                        e.preventDefault();
                        this.startRecording();
                    }
                });

                this.voiceBtn.addEventListener('touchend', (e) => {
                    if (this.isRecording) {
                        e.preventDefault();
                        this.stopRecording();
                    }
                });

                this.interruptBtn.addEventListener('click', () => {
                    this.interrupt();
                });
            }

            updateDeviceInfo() {
                const deviceInfo = document.getElementById('device-info');
                deviceInfo.textContent = `è®¾å¤‡: ${XIAOZHI_CONFIG.deviceId}`;
            }

            async connectToXiaozhi() {
                if (this.isConnected) return;

                try {
                    this.updateStatus('æ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...');
                    this.voiceBtn.className = 'btn connecting';
                    
                    // è·å–è®¿é—®ä»¤ç‰Œ
                    const token = await this.getAccessToken();
                    this.accessToken = token;
                    
                    this.updateStatus('æ­£åœ¨è¿æ¥å°æ™ºAI...');
                    
                    // ç”Ÿæˆä¼šè¯ID
                    this.sessionId = this.generateSessionId();
                    
                    // è¿æ¥WebSocket
                    await this.connectWebSocket(token);
                    
                } catch (error) {
                    console.error('è¿æ¥å¤±è´¥:', error);
                    this.updateStatus(`è¿æ¥å¤±è´¥: ${error.message}`);
                    this.voiceBtn.className = 'btn';
                    showError('è¿æ¥å°æ™ºAIå¤±è´¥: ' + error.message);
                }
            }

            async getAccessToken() {
                try {
                    const response = await fetch(XIAOZHI_CONFIG.otaUrl, {
                        method: 'POST',
                        headers: {
                            'Device-Id': XIAOZHI_CONFIG.deviceId,
                            'Client-Id': XIAOZHI_CONFIG.clientId,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Live2D-Client/1.0.0',
                            'Accept-Language': 'zh-CN',
                            'Activation-Version': '1.0.0'
                        },
                        body: JSON.stringify({
                            application: {
                                version: '1.0.0',
                                elf_sha256: XIAOZHI_CONFIG.hmacKey
                            },
                            board: {
                                type: 'live2d-client',
                                name: 'live2d-client',
                                ip: '127.0.0.1',
                                mac: XIAOZHI_CONFIG.deviceId
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`OTAè¯·æ±‚å¤±è´¥: HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('OTAå“åº”:', data);

                    if (!data.websocket || !data.websocket.token) {
                        throw new Error('OTAå“åº”ä¸­ç¼ºå°‘WebSocketä»¤ç‰Œ');
                    }

                    return data.websocket.token;
                } catch (error) {
                    console.error('è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥:', error);
                    throw new Error('æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ: ' + error.message);
                }
            }

            generateSessionId() {
                return 'live2d_' + Date.now() + '_' + Math.random().toString(36).substring(2);
            }

            async connectWebSocket(token) {
                return new Promise((resolve, reject) => {
                    // å°è¯•ä¸åŒçš„URLæ ¼å¼
                    const wsUrl = `${XIAOZHI_CONFIG.websocketUrl}`;
                    console.log('è¿æ¥WebSocket:', wsUrl);
                    console.log('ä½¿ç”¨token:', token);
                    console.log('è®¾å¤‡ID:', XIAOZHI_CONFIG.deviceId);
                    console.log('å®¢æˆ·ç«¯ID:', XIAOZHI_CONFIG.clientId);

                    this.ws = new WebSocket(wsUrl);

                    const timeout = setTimeout(() => {
                        if (this.ws.readyState !== WebSocket.OPEN) {
                            this.ws.close();
                            reject(new Error('WebSocketè¿æ¥è¶…æ—¶'));
                        }
                    }, 10000);

                    this.ws.onopen = () => {
                        clearTimeout(timeout);
                        console.log('âœ“ WebSocketè¿æ¥æˆåŠŸ');
                        this.sendHelloMessage();
                    };

                    this.ws.onmessage = (event) => {
                        this.handleMessage(event);
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocketè¿æ¥å…³é—­:', event.code, event.reason);
                        this.isConnected = false;
                        this.updateStatus('è¿æ¥å·²æ–­å¼€');
                        this.voiceBtn.className = 'btn';
                        this.voiceBtn.textContent = 'é‡æ–°è¿æ¥';
                        this.interruptBtn.disabled = true;
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        clearTimeout(timeout);
                        reject(new Error('WebSocketè¿æ¥é”™è¯¯'));
                    };

                    // ç­‰å¾…helloå“åº”
                    const originalOnMessage = this.ws.onmessage;
                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            if (message.type === 'hello_response') {
                                console.log('âœ“ æ”¶åˆ°helloå“åº”:', message);
                                this.isConnected = true;
                                this.updateStatus('å·²è¿æ¥ - é•¿æŒ‰è¯´è¯');
                                this.voiceBtn.className = 'btn';
                                this.voiceBtn.textContent = 'é•¿æŒ‰è¯´è¯';
                                this.interruptBtn.disabled = false;
                                this.ws.onmessage = originalOnMessage;
                                resolve();
                            }
                        } catch (e) {
                            // å¿½ç•¥éJSONæ¶ˆæ¯
                        }
                    };
                });
            }

            sendHelloMessage() {
                // å…ˆå‘é€è®¤è¯ä¿¡æ¯
                const authMessage = {
                    authorization: `Bearer ${this.accessToken}`,
                    protocol_version: '1',
                    device_id: XIAOZHI_CONFIG.deviceId,
                    client_id: XIAOZHI_CONFIG.clientId
                };
                
                console.log('å‘é€è®¤è¯æ¶ˆæ¯:', authMessage);
                this.ws.send(JSON.stringify(authMessage));
                
                // ç„¶åå‘é€helloæ¶ˆæ¯
                const helloMessage = {
                    type: 'hello',
                    version: 1,
                    features: { mcp: true },
                    transport: 'websocket',
                    audio_params: {
                        format: 'opus',
                        sample_rate: XIAOZHI_CONFIG.audio.sampleRate,
                        channels: XIAOZHI_CONFIG.audio.channels,
                        frame_duration: 60
                    }
                };
                
                console.log('å‘é€helloæ¶ˆæ¯:', helloMessage);
                setTimeout(() => {
                    this.ws.send(JSON.stringify(helloMessage));
                }, 100);
            }

            handleMessage(event) {
                try {
                    // å°è¯•è§£æJSONæ¶ˆæ¯
                    let message;
                    try {
                        message = JSON.parse(event.data);
                    } catch {
                        // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯äºŒè¿›åˆ¶æ•°æ®
                        console.log('æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®:', event.data.length, 'bytes');
                        return;
                    }

                    console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

                    switch (message.type) {
                        case 'stt':
                            this.handleSTTResult(message);
                            break;
                        case 'llm':
                            this.handleLLMResponse(message);
                            break;
                        case 'tts':
                            this.handleTTSMessage(message);
                            break;
                        case 'error':
                            console.error('æœåŠ¡å™¨é”™è¯¯:', message);
                            showError('æœåŠ¡å™¨é”™è¯¯: ' + (message.message || 'æœªçŸ¥é”™è¯¯'));
                            break;
                        default:
                            console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
                    }
                } catch (error) {
                    console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
                }
            }

            handleSTTResult(message) {
                console.log('STTç»“æœ:', message.text);
                this.updateStatus(`å¬åˆ°: ${message.text}`);
                
                if (live2dManager.isLoaded) {
                    live2dManager.playIdle();
                }
            }

            handleLLMResponse(message) {
                console.log('LLMå“åº”:', message.text);
                this.updateStatus(`å°æ™º: ${message.text.substring(0, 30)}...`);
                
                if (live2dManager.isLoaded) {
                    live2dManager.playTalk();
                }
            }

            handleTTSMessage(message) {
                console.log('TTSæ¶ˆæ¯:', message);
                
                if (message.state === 'start') {
                    this.updateStatus('å°æ™ºæ­£åœ¨è¯´è¯...');
                    if (live2dManager.isLoaded) {
                        live2dManager.playTalk();
                    }
                } else if (message.state === 'stop') {
                    this.updateStatus('å·²è¿æ¥ - é•¿æŒ‰è¯´è¯');
                    if (live2dManager.isLoaded) {
                        live2dManager.playIdle();
                    }
                }
            }

            async startRecording() {
                if (!this.isConnected || this.isRecording) return;

                try {
                    this.isRecording = true;
                    this.voiceBtn.className = 'btn recording';
                    this.updateStatus('æ­£åœ¨å½•éŸ³...');

                    // è°ƒç”¨HTTP APIå¼€å§‹ç›‘å¬çŠ¶æ€ - ä¿®å¤æ¶æ„ä¸åŒ¹é…é—®é¢˜
                    try {
                        const response = await fetch('/api/start_listening', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        if (!response.ok) {
                            console.warn('å¯åŠ¨ç›‘å¬çŠ¶æ€å¤±è´¥:', response.statusText);
                        } else {
                            console.log('âœ“ ç›‘å¬çŠ¶æ€å·²å¯åŠ¨');
                        }
                    } catch (error) {
                        console.warn('è°ƒç”¨start_listening APIå¤±è´¥:', error);
                    }

                    // è·å–éº¦å…‹é£æƒé™
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: XIAOZHI_CONFIG.audio.sampleRate,
                            channelCount: XIAOZHI_CONFIG.audio.channels,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });

                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: XIAOZHI_CONFIG.audio.sampleRate
                    });

                    const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                    
                    // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
                    this.processor = this.audioContext.createScriptProcessor(XIAOZHI_CONFIG.audio.frameSize, 1, 1);
                    
                    this.processor.onaudioprocess = (event) => {
                        const inputData = event.inputBuffer.getChannelData(0);
                        const pcmData = new Int16Array(inputData.length);
                        
                        // è½¬æ¢ä¸º16ä½PCM
                        for (let i = 0; i < inputData.length; i++) {
                            pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                        }
                        
                        // å‘é€éŸ³é¢‘æ•°æ®
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(pcmData.buffer);
                        }
                    };

                    source.connect(this.processor);
                    this.processor.connect(this.audioContext.destination);

                    console.log('âœ“ å¼€å§‹å½•éŸ³');

                } catch (error) {
                    console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
                    this.stopRecording();
                    showError('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                }
            }

            stopRecording() {
                if (!this.isRecording) return;

                this.isRecording = false;
                this.voiceBtn.className = 'btn';
                this.updateStatus('å¤„ç†ä¸­...');

                // æ¸…ç†éŸ³é¢‘èµ„æº
                if (this.processor) {
                    this.processor.disconnect();
                    this.processor = null;
                }

                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                    this.mediaStream = null;
                }

                // å‘é€å½•éŸ³ç»“æŸä¿¡å·
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'audio_end', session_id: this.sessionId }));
                }

                // è°ƒç”¨HTTP APIåœæ­¢ç›‘å¬çŠ¶æ€ - ä¿®å¤æ¶æ„ä¸åŒ¹é…é—®é¢˜
                try {
                    fetch('/api/stop_listening', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    }).then(response => {
                        if (!response.ok) {
                            console.warn('åœæ­¢ç›‘å¬çŠ¶æ€å¤±è´¥:', response.statusText);
                        } else {
                            console.log('âœ“ ç›‘å¬çŠ¶æ€å·²åœæ­¢');
                        }
                    }).catch(error => {
                        console.warn('è°ƒç”¨stop_listening APIå¤±è´¥:', error);
                    });
                } catch (error) {
                    console.warn('åœæ­¢ç›‘å¬çŠ¶æ€APIè°ƒç”¨å¼‚å¸¸:', error);
                }

                console.log('âœ“ å½•éŸ³ç»“æŸ');
            }

            interrupt() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'interrupt', session_id: this.sessionId }));
                    this.updateStatus('å·²ä¸­æ–­');
                    console.log('âœ“ å‘é€ä¸­æ–­ä¿¡å·');
                }
            }

            updateStatus(message) {
                this.statusDiv.textContent = message;
                
                // æ›´æ–°çŠ¶æ€æ ·å¼
                this.statusDiv.className = 'status';
                if (message.includes('å·²è¿æ¥') || message.includes('æˆåŠŸ')) {
                    this.statusDiv.className += ' connected';
                } else if (message.includes('å¤±è´¥') || message.includes('é”™è¯¯')) {
                    this.statusDiv.className += ' error';
                }
            }
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function showError(message) {
            const errorBar = document.getElementById('error-bar');
            errorBar.textContent = message;
            errorBar.className = 'error-bar show';
            
            setTimeout(() => {
                errorBar.className = 'error-bar';
            }, 5000);
        }

        // ========== å…¨å±€APIæ¥å£ ==========
        
        // è°ƒç”¨çŠ¶æ€æˆ–è¡¨æƒ…API
        window.Live2DAPI = {
            // é€šç”¨è°ƒç”¨æ–¹æ³•
            call: function(type, name) {
                if (live2dManager && live2dManager.isLoaded) {
                    return live2dManager.apiCall(type, name);
                } else {
                    return { success: false, message: 'Live2Dç³»ç»Ÿæœªåˆå§‹åŒ–', error: 'SYSTEM_NOT_READY' };
                }
            },

            // çŠ¶æ€è°ƒç”¨æ–¹æ³•
            action: {
                idle: () => Live2DAPI.call('action', 'idle'),
                jingya: () => Live2DAPI.call('action', 'jingya'),
                kaixin: () => Live2DAPI.call('action', 'kaixin'),
                shengqi: () => Live2DAPI.call('action', 'shengqi'),
                wink: () => Live2DAPI.call('action', 'wink'),
                yaotou: () => Live2DAPI.call('action', 'yaotou'),
                talk: () => Live2DAPI.call('action', 'talk')
            },

            // è¡¨æƒ…è°ƒç”¨æ–¹æ³•
            expression: {
                love_eyes: () => Live2DAPI.call('expression', 'love_eyes'),
                angry: () => Live2DAPI.call('expression', 'angry'),
                star_eyes: () => Live2DAPI.call('expression', 'star_eyes'),
                crying: () => Live2DAPI.call('expression', 'crying'),
                microphone: () => Live2DAPI.call('expression', 'microphone'),
                coat: () => Live2DAPI.call('expression', 'coat'),
                tongue: () => Live2DAPI.call('expression', 'tongue')
            },

            // è·å–å¯ç”¨åˆ—è¡¨
            getAvailableList: function() {
                if (live2dManager && live2dManager.isLoaded) {
                    return live2dManager.apiGetAvailableList();
                } else {
                    return { success: false, message: 'Live2Dç³»ç»Ÿæœªåˆå§‹åŒ–', error: 'SYSTEM_NOT_READY' };
                }
            },

            // è·å–ç³»ç»ŸçŠ¶æ€
            getStatus: function() {
                return {
                    success: true,
                    data: {
                        isLoaded: live2dManager ? live2dManager.isLoaded : false,
                        version: '2.0.0',
                        timestamp: Date.now()
                    }
                };
            }
        };

        // ========== Pythonåç«¯é€šä¿¡æ¥å£ ==========
        
        class Live2DAPIServer {
            constructor() {
                this.setupMessageListener();
                this.setupHTTPEndpoint();
                this.commandHistory = [];
                this.maxHistorySize = 100;
                
                console.log('[Live2D API Server] å·²å¯åŠ¨ï¼Œç­‰å¾…Pythonåç«¯è¿æ¥...');
            }
            
            setupMessageListener() {
                // ç›‘å¬æ¥è‡ªPythonåç«¯çš„postMessage
                window.addEventListener('message', (event) => {
                    this.handleMessage(event.data);
                });
                
                // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶ï¼ˆç”¨äºè·¨çª—å£é€šä¿¡ï¼‰
                window.addEventListener('live2d-control', (event) => {
                    this.handleMessage(event.detail);
                });
            }
            
            setupHTTPEndpoint() {
                // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬æ— æ³•åˆ›å»ºçœŸæ­£çš„HTTPæœåŠ¡å™¨
                // ä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡è½®è¯¢æ£€æŸ¥å…¨å±€å˜é‡çš„æ–¹å¼æ¥æ¨¡æ‹ŸHTTPæ¥å£
                window.Live2DControlQueue = window.Live2DControlQueue || [];
                
                // æ¯100msæ£€æŸ¥ä¸€æ¬¡æ§åˆ¶é˜Ÿåˆ—
                setInterval(() => {
                    if (window.Live2DControlQueue.length > 0) {
                        const command = window.Live2DControlQueue.shift();
                        this.handleMessage(command);
                    }
                }, 100);
            }
            
            handleMessage(data) {
                if (!data || typeof data !== 'object') {
                    return;
                }
                
                console.log('[Live2D API Server] æ”¶åˆ°å‘½ä»¤:', data);
                
                // æ£€æŸ¥å‘½ä»¤ç±»å‹
                if (data.type === 'live2d_control') {
                    this.processLive2DCommand(data);
                } else if (data.type === 'chat_message') {
                    this.processChatMessage(data);
                } else {
                    console.warn('[Live2D API Server] æœªçŸ¥å‘½ä»¤ç±»å‹:', data.type);
                }
            }
            
            processLive2DCommand(command) {
                let result = { success: false, message: 'æœªçŸ¥é”™è¯¯' };
                
                try {
                    // æ£€æŸ¥Live2Dç³»ç»ŸçŠ¶æ€
                    if (!window.Live2DAPI) {
                        result = { success: false, message: 'Live2DAPIæœªåˆå§‹åŒ–', error: 'API_NOT_READY' };
                        this.logCommand(command, result);
                        return;
                    }
                    
                    // å¤„ç†åŠ¨ä½œå‘½ä»¤
                    if (command.action) {
                        const actionResult = window.Live2DAPI.call('action', command.action);
                        if (actionResult.success) {
                            console.log(`[Live2D API Server] âœ… æ‰§è¡ŒåŠ¨ä½œ: ${command.action}`);
                        } else {
                            console.error(`[Live2D API Server] âŒ åŠ¨ä½œæ‰§è¡Œå¤±è´¥: ${command.action}`, actionResult);
                        }
                        result = actionResult;
                    }
                    
                    // å¤„ç†è¡¨æƒ…å‘½ä»¤  
                    if (command.expression) {
                        const expressionResult = window.Live2DAPI.call('expression', command.expression);
                        if (expressionResult.success) {
                            console.log(`[Live2D API Server] âœ… æ‰§è¡Œè¡¨æƒ…: ${command.expression}`);
                        } else {
                            console.error(`[Live2D API Server] âŒ è¡¨æƒ…æ‰§è¡Œå¤±è´¥: ${command.expression}`, expressionResult);
                        }
                        
                        // å¦‚æœåŒæ—¶æœ‰åŠ¨ä½œå’Œè¡¨æƒ…ï¼Œåˆå¹¶ç»“æœ
                        if (command.action) {
                            result.expressionResult = expressionResult;
                        } else {
                            result = expressionResult;
                        }
                    }
                    
                    // è®°å½•æˆåŠŸçš„å‘½ä»¤
                    this.logCommand(command, result);
                    
                } catch (error) {
                    result = { 
                        success: false, 
                        message: `å‘½ä»¤æ‰§è¡Œå¼‚å¸¸: ${error.message}`,
                        error: 'EXECUTION_EXCEPTION'
                    };
                    console.error('[Live2D API Server] å‘½ä»¤æ‰§è¡Œå¼‚å¸¸:', error);
                    this.logCommand(command, result);
                }
            }
            
            processChatMessage(message) {
                try {
                    console.log('[Live2D API Server] æ”¶åˆ°èŠå¤©æ¶ˆæ¯:', message);
                    
                    // éªŒè¯æ¶ˆæ¯æ ¼å¼
                    if (!message.text || typeof message.text !== 'string') {
                        console.error('[Live2D API Server] èŠå¤©æ¶ˆæ¯æ ¼å¼é”™è¯¯: ç¼ºå°‘æ–‡æœ¬å†…å®¹');
                        return;
                    }
                    
                    // ç¡®å®šå‘é€è€…ç±»å‹
                    const sender = message.sender === 'user' ? 'user' : 'ai';
                    
                    // è°ƒç”¨å‰ç«¯èŠå¤©ç•Œé¢å‡½æ•°
                    if (typeof window.addChatMessage === 'function') {
                        window.addChatMessage(message.text, sender);
                        console.log(`[Live2D API Server] âœ… èŠå¤©æ¶ˆæ¯æ˜¾ç¤ºæˆåŠŸ: ${sender}`);
                    } else {
                        console.error('[Live2D API Server] âŒ addChatMessageå‡½æ•°æœªæ‰¾åˆ°');
                    }
                    
                    // è®°å½•èŠå¤©æ¶ˆæ¯ç»Ÿè®¡
                    this.stats = this.stats || {};
                    this.stats.chatMessages = (this.stats.chatMessages || 0) + 1;
                    this.stats[`${sender}Messages`] = (this.stats[`${sender}Messages`] || 0) + 1;
                    
                } catch (error) {
                    console.error('[Live2D API Server] èŠå¤©æ¶ˆæ¯å¤„ç†å¼‚å¸¸:', error);
                }
            }
            
            logCommand(command, result) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    command: command,
                    result: result,
                    success: result.success
                };
                
                this.commandHistory.push(logEntry);
                
                // ä¿æŒå†å²è®°å½•å¤§å°é™åˆ¶
                if (this.commandHistory.length > this.maxHistorySize) {
                    this.commandHistory.shift();
                }
            }
            
            getCommandHistory() {
                return this.commandHistory;
            }
            
            getStats() {
                const total = this.commandHistory.length;
                const successful = this.commandHistory.filter(entry => entry.success).length;
                const failed = total - successful;
                
                return {
                    total_commands: total,
                    successful_commands: successful,
                    failed_commands: failed,
                    success_rate: total > 0 ? (successful / total * 100).toFixed(2) + '%' : '0%',
                    chat_messages: this.stats?.chatMessages || 0,
                    ai_messages: this.stats?.aiMessages || 0,
                    user_messages: this.stats?.userMessages || 0
                };
            }
        }
        
        // å¯åŠ¨Live2D APIæœåŠ¡å™¨
        let live2dAPIServer;
        
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨APIæœåŠ¡å™¨
        document.addEventListener('DOMContentLoaded', () => {
            live2dAPIServer = new Live2DAPIServer();

            // å°†APIæœåŠ¡å™¨æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä¾›è°ƒè¯•ä½¿ç”¨
            window.Live2DAPIServer = live2dAPIServer;

            // å¯åŠ¨Live2Då‘½ä»¤è½®è¯¢
            startLive2DCommandPolling();

            // åˆå§‹åŒ–AudioBridgeéŸ³é¢‘æ¡¥æ¥ç³»ç»Ÿ
            window.audioBridge = new AudioBridgeTest();
        });
        
        // Live2Då‘½ä»¤è½®è¯¢ç³»ç»Ÿ
        function startLive2DCommandPolling() {
            console.log('ğŸ”„ å¯åŠ¨Live2Då‘½ä»¤è½®è¯¢...');

            const pollLive2DCommands = async () => {
                try {
                    const response = await fetch('/api/poll_live2d');
                    if (response.ok) {
                        const result = await response.json();

                        if (result.has_command && result.command) {
                            console.log('ğŸ­ æ”¶åˆ°Live2Då‘½ä»¤:', result.command);

                            // ä½¿ç”¨Live2DAPIServerå¤„ç†å‘½ä»¤
                            if (live2dAPIServer) {
                                live2dAPIServer.handleMessage(result.command);
                            } else {
                                console.error('[Live2D Poll] APIæœåŠ¡å™¨æœªåˆå§‹åŒ–');
                            }
                        }
                    }
                } catch (error) {
                    console.error('âŒ Live2Då‘½ä»¤è½®è¯¢é”™è¯¯:', error);
                }

                // ç»§ç»­è½®è¯¢ (æ¯500msè½®è¯¢ä¸€æ¬¡)
                setTimeout(pollLive2DCommands, 500);
            };

            // å¼€å§‹è½®è¯¢
            setTimeout(pollLive2DCommands, 1000);
        }

        // ä¸ºPythonåç«¯æä¾›çš„ä¾¿æ·æ¥å£
        window.sendLive2DCommand = function(command) {
            if (live2dAPIServer) {
                live2dAPIServer.handleMessage({
                    type: 'live2d_control',
                    ...command
                });
                return true;
            } else {
                console.error('[Live2D] APIæœåŠ¡å™¨æœªåˆå§‹åŒ–');
                return false;
            }
        };

        // å…¼å®¹åŸæœ‰çš„å…¨å±€æ–¹æ³•
        function playTalk() {
            if (live2dManager.isLoaded) {
                return live2dManager.playTalk();
            }
        }

        function playIdle() {
            if (live2dManager.isLoaded) {
                return live2dManager.playIdle();
            }
        }

        // æ‰“å¼€åŠ¨ä½œæ’­æ”¾å™¨ï¼ˆè‡ªåŠ¨è¿æ¥ç‰ˆæœ¬ï¼‰
        function openMotionPlayer() {
            // æ‰“å¼€æ–°çª—å£å¹¶ä¼ é€’è¿æ¥ä¿¡æ¯
            const playerWindow = window.open('motion-player.html', 'MotionPlayer', 'width=1200,height=800');
            
            // ç­‰å¾…æ–°çª—å£åŠ è½½å®Œæˆåè‡ªåŠ¨å»ºç«‹è¿æ¥
            if (playerWindow) {
                playerWindow.addEventListener('load', () => {
                    // ç›´æ¥ä¼ é€’live2dAppå¼•ç”¨ç»™æ–°çª—å£
                    if (live2dManager && live2dManager.isLoaded) {
                        playerWindow.live2dApp = live2dManager;
                        console.log('âœ“ åŠ¨ä½œæ’­æ”¾å™¨è‡ªåŠ¨è¿æ¥æˆåŠŸ');
                    }
                });
                
                // ç¡®ä¿è¿æ¥æˆåŠŸçš„å¤‡ç”¨æ–¹æ³•
                setTimeout(() => {
                    if (playerWindow && !playerWindow.closed && live2dManager) {
                        playerWindow.live2dApp = live2dManager;
                        if (playerWindow.updateStatus) {
                            playerWindow.updateStatus('å·²è‡ªåŠ¨è¿æ¥åˆ°Live2D');
                        }
                    }
                }, 1000);
                
                console.log('åŠ¨ä½œæ’­æ”¾å™¨çª—å£å·²æ‰“å¼€');
            } else {
                alert('æ— æ³•æ‰“å¼€åŠ¨ä½œæ’­æ”¾å™¨çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
            }
        }

        // ========== åº”ç”¨åˆå§‹åŒ– ==========
        let live2dManager;
        let xiaozhiClient;

        window.addEventListener('load', async () => {
            try {
                console.log('ğŸš€ å°æ™ºLive2D - ç”Ÿäº§ç¯å¢ƒå¯åŠ¨');
                
                // åˆå§‹åŒ–Live2D
                live2dManager = new Live2DManager();
                await live2dManager.init();
                
                // å°†Live2Dç®¡ç†å™¨æš´éœ²åˆ°å…¨å±€ï¼Œä¾›åŠ¨ä½œæ’­æ”¾å™¨è„šæœ¬ä½¿ç”¨
                window.live2dApp = live2dManager;
                
                // è®¾ç½®localStorageæ ‡è®°ï¼Œè¡¨ç¤ºLive2Då·²å‡†å¤‡å°±ç»ª
                try {
                    localStorage.setItem('live2d_status', 'ready');
                } catch (e) {
                    console.warn('æ— æ³•è®¾ç½®localStorageæ ‡è®°');
                }
                
                // åˆå§‹åŒ–å°æ™ºAIå®¢æˆ·ç«¯
                xiaozhiClient = new XiaozhiAIClient();

                // æ™ºèƒ½è½®è¯¢ç³»ç»Ÿä¼šåœ¨ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨å¯åŠ¨
                console.log('ğŸ§  æ™ºèƒ½è½®è¯¢ç³»ç»Ÿå·²å°±ç»ªï¼Œç­‰å¾…ç”¨æˆ·æ¶ˆæ¯æ¿€æ´»');

                console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                
                // å¯ç”¨æ¼”ç¤ºèŠå¤©æ¶ˆæ¯ (å¯é€‰ - ç”¨äºå±•ç¤ºæ•ˆæœ)
                // addDemoMessages();
                
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åº”ç”¨å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            showError('å‘ç”Ÿé”™è¯¯: ' + event.error.message);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            showError('å¼‚æ­¥æ“ä½œå¤±è´¥: ' + event.reason.message);
        });
    </script>

    <!-- å›ºå®šå¬å”¤æŒ‰é’® (å½“èœå•æŠ˜å æ—¶æ˜¾ç¤º) -->
    <button class="summon-btn show" id="summon-btn" onclick="toggleControlPanel()" title="æ‰“å¼€èœå•">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
        </svg>
    </button>

    <!-- èŠå¤©æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="chat-area" id="chat-area">
        <div class="chat-messages" id="chat-messages">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="message ai">
                <div class="bubble">
                    ä½ å¥½ï¼æˆ‘æ˜¯å°æ™ºï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼ ğŸ˜Š
                </div>
            </div>
        </div>
        
        <!-- æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
        <div class="typing-indicator" id="typing-indicator">
            <div class="bubble">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
    <div class="input-area" id="input-area">
        <!-- è¯­éŸ³æŒ‰é’®åŒºåŸŸ -->
        <div class="voice-section">
            <button class="voice-input-btn" id="voice-input-btn" onclick="toggleVoiceInput()" title="ç‚¹å‡»å¼€å§‹è¯­éŸ³è¾“å…¥">
                <!-- éº¦å…‹é£å›¾æ ‡ SVG -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" id="mic-icon">
                    <path d="M12 1c-1.66 0-3 1.34-3 3v8c0 1.66 1.34 3 3 3s3-1.34 3-3V4c0-1.66-1.34-3-3-3zm0 18c-2.76 0-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V23h2v-2.08c3.39-.49 6-3.39 6-6.92h-2c0 2.76-2.24 5-5 5z"/>
                </svg>
                <!-- å½•éŸ³å›¾æ ‡ SVG (éšè—) -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" id="recording-icon" style="display: none;">
                    <circle cx="12" cy="12" r="8"/>
                </svg>
            </button>
        </div>
        
        <!-- æ–‡å­—è¾“å…¥åŒºåŸŸ -->
        <div class="text-section">
            <input type="text" class="text-input" id="text-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." 
                   onkeypress="handleTextInput(event)">
        </div>
        
        <!-- å‘é€æŒ‰é’® -->
        <button class="send-btn" id="send-btn" onclick="sendTextMessage()" title="å‘é€æ¶ˆæ¯">
            <!-- å‘é€å›¾æ ‡ SVG -->
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </button>
    </div>

    <!-- å¾…æœºçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="standby-status" id="standby-status" style="display: block;">
        <div class="status-content">
            <div class="status-icon">ğŸ’¤</div>
            <span class="status-text">çŠ¶æ€ï¼šå¾…æœºä¸­</span>
            <button class="activate-btn" id="activate-btn" onclick="activateSystem()">æ¿€æ´»</button>
        </div>
    </div>

    <!-- AudioBridgeçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="audio-bridge-status" id="audio-bridge-status">
        <div style="font-weight: bold; margin-bottom: 10px;">ğŸ™ï¸ éŸ³é¢‘æ¡¥æ¥çŠ¶æ€</div>
        <div class="status-item">
            <span class="status-label">æ¡¥æ¥è¿æ¥:</span>
            <span class="status-value" id="bridge-status">æœªè¿æ¥</span>
        </div>
        <div class="status-item">
            <span class="status-label">Zoev3çŠ¶æ€:</span>
            <span class="status-value" id="zoev3-status">æ£€æµ‹ä¸­</span>
        </div>
        <div class="status-item">
            <span class="status-label">å½•éŸ³çŠ¶æ€:</span>
            <span class="status-value" id="recording-status">å¾…æœº</span>
        </div>
        <div class="status-item">
            <span class="status-label">OPUSåŒ…æ•°:</span>
            <span class="status-value" id="opus-count">0</span>
        </div>
        <div class="status-item">
            <span class="status-label">æ³¨å…¥æˆåŠŸ:</span>
            <span class="status-value" id="injection-count">0</span>
        </div>
    </div>

    <!-- AudioBridgeæ—¥å¿—åŒºåŸŸ -->
    <div class="log-area" id="log-area">
        <div class="log-entry log-info">[å¯åŠ¨] æ­£åœ¨åˆå§‹åŒ–éŸ³é¢‘æ¡¥æ¥...</div>
    </div>
</body>
</html>