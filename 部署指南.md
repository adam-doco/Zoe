# Live2Då°æ™ºAIç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
3. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
4. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
5. [å®‰è£…éƒ¨ç½²](#å®‰è£…éƒ¨ç½²)
6. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
7. [å¯åŠ¨è¿è¡Œ](#å¯åŠ¨è¿è¡Œ)
8. [åŠŸèƒ½éªŒè¯](#åŠŸèƒ½éªŒè¯)
9. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)
10. [APIæ¥å£æ–‡æ¡£](#APIæ¥å£æ–‡æ¡£)
11. [ç»´æŠ¤æŒ‡å—](#ç»´æŠ¤æŒ‡å—)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

Live2Då°æ™ºAIç³»ç»Ÿæ˜¯ä¸€ä¸ªé›†æˆäº†Live2Dæ¨¡å‹åŠ¨ç”»ã€å°æ™ºAIå¯¹è¯ã€è¯­éŸ³è¯†åˆ«å’Œæƒ…æ„Ÿæ˜ å°„çš„äº¤äº’å¼Webåº”ç”¨ã€‚ç³»ç»Ÿé‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œæ”¯æŒå®æ—¶å¯¹è¯ã€è¯­éŸ³è¾“å…¥ã€æƒ…æ„Ÿè¡¨è¾¾å’ŒLive2Dæ¨¡å‹åŠ¨ä½œåŒæ­¥ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- ğŸ­ **Live2Dæ¨¡å‹æ§åˆ¶**: æ”¯æŒ32+ç§æƒ…æ„Ÿè¡¨æƒ…å’ŒåŠ¨ä½œæ˜ å°„
- ğŸ¤– **å°æ™ºAIå¯¹è¯**: WebSocketè¿æ¥å°æ™ºAIæœåŠ¡ï¼Œæ”¯æŒæ™ºèƒ½å¯¹è¯
- ğŸ¤ **è¯­éŸ³è¯†åˆ«**: åŸºäºWeb Speech APIçš„å®æ—¶è¯­éŸ³è¾“å…¥
- ğŸ˜Š **æƒ…æ„Ÿæ˜ å°„**: æ™ºèƒ½æƒ…æ„Ÿåˆ†æå¹¶åŒæ­¥åˆ°Live2Dè¡¨æƒ…
- ğŸ”„ **å®æ—¶é€šä¿¡**: åŸºäºè½®è¯¢æœºåˆ¶çš„å‰åç«¯æ•°æ®åŒæ­¥
- ğŸ“± **å“åº”å¼ç•Œé¢**: æ”¯æŒå¤šè®¾å¤‡è®¿é—®çš„ç°ä»£åŒ–Webç•Œé¢

### ç³»ç»Ÿæ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP/WS     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç•Œé¢      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚   FlaskæœåŠ¡å™¨    â”‚
â”‚  (index.html)   â”‚                â”‚   (server.py)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                   â”‚
         â”‚ è½®è¯¢API                            â”‚ é˜Ÿåˆ—é€šä¿¡
         â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Live2Dæ§åˆ¶     â”‚                â”‚   æ¶ˆæ¯å¤„ç†å™¨     â”‚
â”‚ æƒ…æ„Ÿæ˜ å°„ç³»ç»Ÿ    â”‚                â”‚(message_handler) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â”‚ WebSocket
                                           â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚   å°æ™ºAIæœåŠ¡     â”‚
                                  â”‚  (api.tenclass)  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚

### æ“ä½œç³»ç»Ÿæ”¯æŒ
- âœ… **macOS** 10.14+ (æ¨è)
- âœ… **Windows** 10/11
- âœ… **Linux** Ubuntu 18.04+/CentOS 7+

### Pythonç¯å¢ƒ
- **Pythonç‰ˆæœ¬**: 3.8+ (æ¨èPython 3.9æˆ–3.10)
- **åŒ…ç®¡ç†å·¥å…·**: pip (é€šå¸¸éšPythonå®‰è£…)

### æµè§ˆå™¨æ”¯æŒ
- âœ… **Chrome** 80+ (æ¨èï¼Œæœ€ä½³å…¼å®¹æ€§)
- âœ… **Firefox** 75+
- âœ… **Safari** 13+ (macOS)
- âœ… **Edge** 80+
- âŒ Internet Explorer (ä¸æ”¯æŒ)

> **æ³¨æ„**: è¯­éŸ³è¯†åˆ«åŠŸèƒ½éœ€è¦æµè§ˆå™¨æ”¯æŒWeb Speech APIï¼Œæ¨èä½¿ç”¨Chromeæµè§ˆå™¨

### ç¡¬ä»¶è¦æ±‚
- **CPU**: åŒæ ¸2.0GHzä»¥ä¸Š
- **å†…å­˜**: 4GBä»¥ä¸Šå¯ç”¨RAM
- **å­˜å‚¨**: 500MBå¯ç”¨ç£ç›˜ç©ºé—´
- **ç½‘ç»œ**: ç¨³å®šçš„äº’è”ç½‘è¿æ¥ï¼ˆç”¨äºå°æ™ºAIé€šä¿¡ï¼‰

### ç½‘ç»œè¦æ±‚
- **å‡ºç«™è¿æ¥**: è®¿é—® `api.tenclass.net` (å°æ™ºAIæœåŠ¡)
- **æœ¬åœ°ç«¯å£**: 3000ç«¯å£å¯ç”¨ï¼ˆå¯é…ç½®ï¼‰
- **é˜²ç«å¢™**: å…è®¸Pythonç¨‹åºç½‘ç»œè®¿é—®

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
Zoe/                              # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ éƒ¨ç½²æŒ‡å—.md                   # æœ¬æ–‡æ¡£
â”œâ”€â”€ server.py                     # Flask WebæœåŠ¡å™¨ (ä¸»è¦æœåŠ¡)
â”œâ”€â”€ simple_message_handler.py     # æ¶ˆæ¯å¤„ç†å™¨ (æ ¸å¿ƒé€šä¿¡æ¨¡å—)
â”œâ”€â”€ robust_message_handler.py     # å¢å¼ºç‰ˆæ¶ˆæ¯å¤„ç†å™¨
â”œâ”€â”€ shared_queues.py              # è·¨è¿›ç¨‹é€šä¿¡é˜Ÿåˆ—
â”œâ”€â”€ emotion_mapping.py            # æƒ…æ„Ÿæ˜ å°„é…ç½®
â”œâ”€â”€ xiaozhi_device.json           # è®¾å¤‡é…ç½®æ–‡ä»¶ (é‡è¦)
â”œâ”€â”€ index.html                    # ä¸»é¡µé¢ (å‰ç«¯ç•Œé¢)
â”œâ”€â”€ test_emotions.html            # æƒ…æ„Ÿæµ‹è¯•é¡µé¢
â”œâ”€â”€ start_robust_system.py        # ç³»ç»Ÿå¯åŠ¨è„šæœ¬
â”‚
â”œâ”€â”€ Mould/                        # Live2Dæ¨¡å‹èµ„æº
â”‚   â”œâ”€â”€ Z.model3.json            # æ¨¡å‹å®šä¹‰æ–‡ä»¶
â”‚   â”œâ”€â”€ Z.cdi3.json              # æ¨¡å‹é…ç½®
â”‚   â”œâ”€â”€ Z.physics3.json          # ç‰©ç†å¼•æ“é…ç½®
â”‚   â”œâ”€â”€ motions/                 # åŠ¨ä½œæ–‡ä»¶ç›®å½•
â”‚   â”‚   â”œâ”€â”€ Idle.motion3.json    # å¾…æœºåŠ¨ä½œ
â”‚   â”‚   â”œâ”€â”€ kaixin.motion3.json  # å¼€å¿ƒåŠ¨ä½œ
â”‚   â”‚   â”œâ”€â”€ shengqi.motion3.json # ç”Ÿæ°”åŠ¨ä½œ
â”‚   â”‚   â”œâ”€â”€ jingya.motion3.json  # æƒŠè®¶åŠ¨ä½œ
â”‚   â”‚   â”œâ”€â”€ wink.motion3.json    # çœ¨çœ¼åŠ¨ä½œ
â”‚   â”‚   â””â”€â”€ yaotou.motion3.json  # æ‘‡å¤´åŠ¨ä½œ
â”‚   â””â”€â”€ textures/                # è´´å›¾èµ„æº
â”‚
â””â”€â”€ libs/                        # ç¬¬ä¸‰æ–¹åº“
    â””â”€â”€ live2dcubismcore.min.js  # Live2Dæ ¸å¿ƒåº“
```

### å…³é”®æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶å | ä½œç”¨ | é‡è¦ç¨‹åº¦ |
|--------|------|----------|
| `server.py` | WebæœåŠ¡å™¨,æä¾›HTTP APIå’Œé™æ€æ–‡ä»¶æœåŠ¡ | â­â­â­â­â­ |
| `simple_message_handler.py` | å¤„ç†ä¸å°æ™ºAIçš„WebSocketé€šä¿¡ | â­â­â­â­â­ |
| `xiaozhi_device.json` | å°æ™ºAIè®¾å¤‡è®¤è¯é…ç½® | â­â­â­â­â­ |
| `index.html` | ä¸»ç•Œé¢,åŒ…å«Live2Då’Œè¯­éŸ³æ§åˆ¶ | â­â­â­â­ |
| `emotion_mapping.py` | æƒ…æ„Ÿåˆ°Live2DåŠ¨ä½œçš„æ˜ å°„è§„åˆ™ | â­â­â­ |
| `shared_queues.py` | è¿›ç¨‹é—´é€šä¿¡é˜Ÿåˆ— | â­â­â­ |

---

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### 1. Pythonç¯å¢ƒæ£€æŸ¥
```bash
# æ£€æŸ¥Pythonç‰ˆæœ¬ (éœ€è¦3.8+)
python3 --version
# æˆ–è€…
python --version

# æ£€æŸ¥pipç‰ˆæœ¬
pip3 --version
# æˆ–è€…
pip --version
```

### 2. å®‰è£…Pythonä¾èµ–
é¡¹ç›®æ‰€éœ€çš„PythonåŒ…:
```bash
# æ ¸å¿ƒä¾èµ–
pip3 install websockets aiohttp requests

# å¯é€‰ï¼šå¦‚æœéœ€è¦éŸ³é¢‘å¤„ç†
pip3 install pyaudio pydub

# HTTPæœåŠ¡å™¨ (Pythonå†…ç½®ï¼Œæ— éœ€é¢å¤–å®‰è£…)
# - http.server
# - socketserver
# - json
# - queue
# - threading
```

å®Œæ•´å®‰è£…å‘½ä»¤:
```bash
pip3 install websockets aiohttp requests
```

### 3. ç³»ç»Ÿæƒé™è®¾ç½®

#### macOSç³»ç»Ÿ
```bash
# ç¡®ä¿Pythonæœ‰ç½‘ç»œè®¿é—®æƒé™
# é¦–æ¬¡è¿è¡Œæ—¶ç³»ç»Ÿä¼šå¼¹å‡ºæƒé™è¯·æ±‚å¯¹è¯æ¡†ï¼Œéœ€è¦å…è®¸

# å¦‚æœéœ€è¦éº¦å…‹é£æƒé™ï¼ˆè¯­éŸ³åŠŸèƒ½ï¼‰
# åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ > éšç§ > éº¦å…‹é£"ä¸­
# å‹¾é€‰æµè§ˆå™¨åº”ç”¨ï¼ˆChrome/Safariç­‰ï¼‰
```

#### Windowsç³»ç»Ÿ
```cmd
:: ç¡®ä¿é˜²ç«å¢™å…è®¸Pythonç¨‹åº
:: é¦–æ¬¡è¿è¡Œæ—¶Windows Defenderä¼šè¯¢é—®ç½‘ç»œè®¿é—®æƒé™ï¼Œé€‰æ‹©"å…è®¸"

:: å¦‚æœé‡åˆ°ç«¯å£å ç”¨ï¼Œå¯ä»¥æ£€æŸ¥ç«¯å£ä½¿ç”¨æƒ…å†µ:
netstat -ano | findstr 3000
```

#### Linuxç³»ç»Ÿ
```bash
# å®‰è£…éŸ³é¢‘ç³»ç»Ÿä¾èµ–ï¼ˆå¦‚æœéœ€è¦è¯­éŸ³åŠŸèƒ½ï¼‰
sudo apt-get update
sudo apt-get install pulseaudio alsa-utils

# æ£€æŸ¥ç«¯å£ä½¿ç”¨æƒ…å†µ
netstat -tulpn | grep 3000
```

---

## ğŸš€ å®‰è£…éƒ¨ç½²

### æ­¥éª¤1: è·å–é¡¹ç›®æ–‡ä»¶

```bash
# æ–¹æ³•1: ä»Gitä»“åº“å…‹éš† (å¦‚æœæœ‰çš„è¯)
git clone [ä»“åº“åœ°å€]
cd Zoe

# æ–¹æ³•2: ç›´æ¥ä¸‹è½½é¡¹ç›®åŒ…
# å°†æ‰€æœ‰æ–‡ä»¶è§£å‹åˆ°ç›®æ ‡ç›®å½•
# ç¡®ä¿ç›®å½•ç»“æ„ä¸ä¸Šè¿°"é¡¹ç›®ç»“æ„"ä¸€è‡´
```

### æ­¥éª¤2: éªŒè¯é¡¹ç›®å®Œæ•´æ€§

```bash
cd /path/to/Zoe

# æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la server.py simple_message_handler.py xiaozhi_device.json index.html

# æ£€æŸ¥Live2Dæ¨¡å‹æ–‡ä»¶
ls -la Mould/Z.model3.json Mould/motions/ libs/live2dcubismcore.min.js

# é¢„æœŸè¾“å‡ºåº”è¯¥æ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶éƒ½å­˜åœ¨
```

### æ­¥éª¤3: é…ç½®è®¾å¤‡æ–‡ä»¶

ç¼–è¾‘ `xiaozhi_device.json` æ–‡ä»¶:
```json
{
  "device_id": "02:00:00:00:b7:aa",
  "client_id": "a853e63d-798f-4564-8098-58f913efc510",
  "serial": "SN-2FDFDDDD-02000000B7AA",
  "hmac_key": "b24706e52bfed846bcf9b4116fdb7a2f6c7382c69204e10ea",
  "activated": "true",
  "websocket_url": "wss://api.tenclass.net/xiaozhi/v1/",
  "websocket_token": "test-token"
}
```

> **é‡è¦**: è¿™äº›é…ç½®å‚æ•°å¯¹äºå°æ™ºAIè¿æ¥è‡³å…³é‡è¦ï¼Œè¯·ç¡®ä¿å‚æ•°æ­£ç¡®

### æ­¥éª¤4: æµ‹è¯•Pythonä¾èµ–

```bash
cd /path/to/Zoe

# æµ‹è¯•å¯¼å…¥æ ¸å¿ƒæ¨¡å—
python3 -c "import websockets, aiohttp, requests, json, threading, queue; print('âœ… æ‰€æœ‰ä¾èµ–æ­£å¸¸')"

# æµ‹è¯•é¡¹ç›®æ¨¡å—å¯¼å…¥
python3 -c "import shared_queues, emotion_mapping; print('âœ… é¡¹ç›®æ¨¡å—æ­£å¸¸')"
```

### æ­¥éª¤5: ç½‘ç»œè¿æ¥æµ‹è¯•

```bash
# æµ‹è¯•å°æ™ºAIæœåŠ¡å™¨è¿é€šæ€§
ping api.tenclass.net

# æµ‹è¯•WebSocketè¿æ¥ (å¯é€‰)
curl -I https://api.tenclass.net/

# æ£€æŸ¥æœ¬åœ°ç«¯å£3000æ˜¯å¦è¢«å ç”¨
netstat -tulpn | grep 3000  # Linux/macOS
netstat -ano | findstr 3000  # Windows
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### 1. æœåŠ¡å™¨é…ç½® (server.py)

ä¸»è¦é…ç½®é¡¹ä½äºæ–‡ä»¶åº•éƒ¨:
```python
if __name__ == "__main__":
    port = 3000                           # HTTPæœåŠ¡ç«¯å£
    directory = "/Users/good/Desktop/Zoe" # é¡¹ç›®æ ¹ç›®å½•è·¯å¾„

    # å¯é€šè¿‡å‘½ä»¤è¡Œå‚æ•°è¦†ç›–:
    # python3 server.py [ç«¯å£] [ç›®å½•è·¯å¾„]
```

### 2. å°æ™ºAIé…ç½® (xiaozhi_device.json)

| å‚æ•° | è¯´æ˜ | æ˜¯å¦å¯ä¿®æ”¹ |
|------|------|-----------|
| `device_id` | è®¾å¤‡MACåœ°å€æ ‡è¯† | âŒ è¯·å‹¿ä¿®æ”¹ |
| `client_id` | å®¢æˆ·ç«¯UUID | âŒ è¯·å‹¿ä¿®æ”¹ |
| `serial` | è®¾å¤‡åºåˆ—å· | âŒ è¯·å‹¿ä¿®æ”¹ |
| `hmac_key` | è®¤è¯å¯†é’¥ | âŒ è¯·å‹¿ä¿®æ”¹ |
| `activated` | æ¿€æ´»çŠ¶æ€ | âœ… å¯ä¿®æ”¹ä¸º"true"/"false" |
| `websocket_url` | å°æ™ºAIæœåŠ¡åœ°å€ | âš ï¸ ä»…åœ¨æœåŠ¡å™¨å˜æ›´æ—¶ä¿®æ”¹ |
| `websocket_token` | è®¤è¯ä»¤ç‰Œ | âš ï¸ ä»…åœ¨ä»¤ç‰Œæ›´æ–°æ—¶ä¿®æ”¹ |

### 3. æƒ…æ„Ÿæ˜ å°„é…ç½® (emotion_mapping.py)

æ”¯æŒçš„Live2DåŠ¨ä½œ:
```python
available_actions = [
    "idle",      # å¾…æœºçŠ¶æ€
    "jingya",    # æƒŠè®¶
    "kaixin",    # å¼€å¿ƒ
    "shengqi",   # ç”Ÿæ°”
    "wink",      # çœ¨çœ¼/ä¿çš®
    "yaotou",    # æ‘‡å¤´/å›°æƒ‘
    "talk"       # è¯´è¯ (å·²ç¦ç”¨ï¼Œç”±TTSæ§åˆ¶)
]
```

æ”¯æŒçš„Live2Dè¡¨æƒ…:
```python
available_expressions = [
    "love_eyes",    # çˆ±å¿ƒçœ¼
    "angry",        # æ„¤æ€’
    "star_eyes",    # æ˜Ÿæ˜Ÿçœ¼
    "crying",       # å“­æ³£
    "microphone",   # éº¦å…‹é£
    "coat",         # å¤–å¥—
    "tongue"        # åèˆŒå¤´
]
```

### 4. é˜Ÿåˆ—é…ç½® (shared_queues.py)

ç³»ç»Ÿä½¿ç”¨åŸºäºæ–‡ä»¶çš„é˜Ÿåˆ—è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼Œé˜Ÿåˆ—æ–‡ä»¶å­˜å‚¨ä½ç½®:
```python
queue_dir = "/tmp/xiaozhi_queues/"  # é˜Ÿåˆ—æ–‡ä»¶ç›®å½•

# é˜Ÿåˆ—ç±»å‹:
message_queue     # å‰ç«¯æ¶ˆæ¯ â†’ æ¶ˆæ¯å¤„ç†å™¨
ai_reply_queue    # AIå›å¤ â†’ å‰ç«¯
emotion_queue     # æƒ…æ„Ÿæ•°æ® â†’ Live2Dæ§åˆ¶
live2d_commands   # Live2Dæ§åˆ¶å‘½ä»¤
```

---

## ğŸƒ å¯åŠ¨è¿è¡Œ

### æ–¹æ³•1: æ‰‹åŠ¨åˆ†æ­¥å¯åŠ¨ (æ¨èç”¨äºè°ƒè¯•)

#### æ­¥éª¤1: å¯åŠ¨æ¶ˆæ¯å¤„ç†å™¨
```bash
cd /path/to/Zoe

# å¯åŠ¨å°æ™ºAIæ¶ˆæ¯å¤„ç†å™¨
python3 simple_message_handler.py

# é¢„æœŸè¾“å‡º:
# ğŸ”„ åˆå§‹åŒ–æ¶ˆæ¯å¤„ç†å™¨...
# ğŸ“¡ è¿æ¥å°æ™ºAIæœåŠ¡å™¨...
# âœ… WebSocketè¿æ¥æˆåŠŸ
# ğŸ¯ æ¶ˆæ¯å¤„ç†å™¨å¯åŠ¨å®Œæˆï¼Œç­‰å¾…æ¶ˆæ¯...
```

#### æ­¥éª¤2: å¯åŠ¨WebæœåŠ¡å™¨
```bash
# æ–°å¼€ä¸€ä¸ªç»ˆç«¯çª—å£
cd /path/to/Zoe

# å¯åŠ¨Flask WebæœåŠ¡å™¨
python3 server.py

# é¢„æœŸè¾“å‡º:
# ğŸŒ Live2DæœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
# ğŸ“ åœ°å€: http://127.0.0.1:3000
# ğŸ“ ç›®å½•: /path/to/Zoe
# âœ… æ”¯æŒPOST APIè°ƒç”¨
# ==================================================
```

### æ–¹æ³•2: ä½¿ç”¨å¯åŠ¨è„šæœ¬ (æ¨èç”¨äºç”Ÿäº§)

```bash
cd /path/to/Zoe

# ä½¿ç”¨ç³»ç»Ÿå¯åŠ¨è„šæœ¬
python3 start_robust_system.py

# è„šæœ¬ä¼šä¾æ¬¡å¯åŠ¨:
# 1. æ¸…ç©ºæ¶ˆæ¯é˜Ÿåˆ—
# 2. å¯åŠ¨æ¶ˆæ¯å¤„ç†å™¨ (åå°)
# 3. å¯åŠ¨WebæœåŠ¡å™¨ (å‰å°)
```

### æ–¹æ³•3: è‡ªå®šä¹‰å¯åŠ¨

```bash
# æŒ‡å®šç«¯å£å¯åŠ¨
python3 server.py 8080

# æŒ‡å®šç«¯å£å’Œç›®å½•
python3 server.py 8080 /custom/path/to/project
```

### å¯åŠ¨æˆåŠŸéªŒè¯

1. **æ£€æŸ¥æœåŠ¡çŠ¶æ€**:
   ```bash
   # æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«ç›‘å¬
   netstat -tulpn | grep 3000

   # é¢„æœŸçœ‹åˆ°:
   # tcp 127.0.0.1:3000 LISTEN
   ```

2. **è®¿é—®Webç•Œé¢**:
   ```
   æµè§ˆå™¨è®¿é—®: http://127.0.0.1:3000
   ```

3. **æ£€æŸ¥åå°è¿›ç¨‹**:
   ```bash
   # macOS/Linux
   ps aux | grep python | grep message_handler
   ps aux | grep python | grep server

   # Windows
   tasklist | findstr python
   ```

---

## âœ… åŠŸèƒ½éªŒè¯

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•

#### Webç•Œé¢è®¿é—®æµ‹è¯•
1. æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://127.0.0.1:3000`
2. åº”è¯¥çœ‹åˆ°Live2Dæ¨¡å‹åŠ è½½
3. ç•Œé¢åŒ…å«èŠå¤©è¾“å…¥æ¡†å’Œè¯­éŸ³æŒ‰é’®

#### Live2Dæ¨¡å‹æµ‹è¯•
1. è®¿é—®æµ‹è¯•é¡µé¢: `http://127.0.0.1:3000/test_emotions.html`
2. ç‚¹å‡»ä¸åŒæƒ…æ„ŸæŒ‰é’®æµ‹è¯•Live2DåŠ¨ä½œ
3. è§‚å¯Ÿæ¨¡å‹æ˜¯å¦æ­£ç¡®æ’­æ”¾å¯¹åº”åŠ¨ä½œå’Œè¡¨æƒ…

#### APIè¿é€šæ€§æµ‹è¯•
```bash
# æµ‹è¯•ç³»ç»ŸçŠ¶æ€API
curl http://127.0.0.1:3000/api/system_status

# é¢„æœŸå“åº”:
# {"status": "success", "system_status": {...}, "timestamp": ...}

# æµ‹è¯•Live2Dæ§åˆ¶API
curl -X POST http://127.0.0.1:3000/api/live2d \
  -H "Content-Type: application/json" \
  -d '{"type":"action","name":"kaixin","source":"test"}'

# é¢„æœŸå“åº”:
# {"status": "success", "message": "Live2Då‘½ä»¤æ‰§è¡Œ: action.kaixin", ...}
```

### 2. èŠå¤©åŠŸèƒ½æµ‹è¯•

#### æ–‡æœ¬èŠå¤©æµ‹è¯•
1. åœ¨èŠå¤©è¾“å…¥æ¡†ä¸­è¾“å…¥: "ä½ å¥½"
2. ç‚¹å‡»å‘é€æˆ–æŒ‰å›è½¦
3. ç­‰å¾…3-5ç§’è§‚å¯ŸAIå›å¤
4. æ£€æŸ¥Live2Dæ¨¡å‹æ˜¯å¦æœ‰æƒ…æ„Ÿååº”

#### è¯­éŸ³è¾“å…¥æµ‹è¯•
1. ç‚¹å‡»éº¦å…‹é£æŒ‰é’®ğŸ¤
2. æµè§ˆå™¨ä¼šè¯·æ±‚éº¦å…‹é£æƒé™,ç‚¹å‡»"å…è®¸"
3. å¯¹ç€éº¦å…‹é£è¯´è¯,è§‚å¯Ÿè¯­éŸ³è¯†åˆ«æ–‡å­—
4. è¯­éŸ³ç»“æŸåè‡ªåŠ¨å‘é€ç»™AI
5. æ£€æŸ¥å›å¤å’ŒLive2Dååº”

### 3. æƒ…æ„Ÿæ˜ å°„æµ‹è¯•

æµ‹è¯•ä¸åŒç±»å‹çš„å¯¹è¯,è§‚å¯ŸLive2Dæ¨¡å‹ååº”:

| å¯¹è¯å†…å®¹ | é¢„æœŸæƒ…æ„Ÿ | é¢„æœŸåŠ¨ä½œ | é¢„æœŸè¡¨æƒ… |
|---------|---------|---------|----------|
| "æˆ‘å¾ˆå¼€å¿ƒ!" | happy | kaixin | love_eyes |
| "æˆ‘ç”Ÿæ°”äº†!" | angry | shengqi | angry |
| "çœŸæ˜¯å¤ªæƒŠè®¶äº†!" | surprised | jingya | star_eyes |
| "æˆ‘å¾ˆéš¾è¿‡" | sad | idle | crying |
| "ä½ å¥½å—?" | neutral | idle | None |

### 4. ç³»ç»Ÿç¨³å®šæ€§æµ‹è¯•

#### è¿ç»­å¯¹è¯æµ‹è¯•
1. è¿ç»­å‘é€10æ¡ä»¥ä¸Šæ¶ˆæ¯
2. è§‚å¯Ÿç³»ç»Ÿæ˜¯å¦æœ‰å»¶è¿Ÿæˆ–å¡é¡¿
3. æ£€æŸ¥å†…å­˜ä½¿ç”¨æ˜¯å¦æ­£å¸¸å¢é•¿

#### é•¿æ—¶é—´è¿è¡Œæµ‹è¯•
1. è®©ç³»ç»Ÿè¿è¡Œ1å°æ—¶ä»¥ä¸Š
2. å®šæœŸå‘é€æ¶ˆæ¯æµ‹è¯•å“åº”é€Ÿåº¦
3. è§‚å¯Ÿæ˜¯å¦æœ‰å†…å­˜æ³„æ¼æˆ–è¿æ¥æ–­å¼€

---

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1: æ— æ³•è®¿é—® http://127.0.0.1:3000
**ç—‡çŠ¶**: æµè§ˆå™¨æ˜¾ç¤º"æ— æ³•è¿æ¥"æˆ–"è¿æ¥è¢«æ‹’ç»"

**å¯èƒ½åŸå› **:
- WebæœåŠ¡å™¨æœªå¯åŠ¨
- ç«¯å£3000è¢«å…¶ä»–ç¨‹åºå ç”¨
- é˜²ç«å¢™é˜»æ‹¦

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨
ps aux | grep "server.py"

# 2. æ£€æŸ¥ç«¯å£å ç”¨
netstat -tulpn | grep 3000
# å¦‚æœç«¯å£è¢«å ç”¨ï¼Œkillå¯¹åº”è¿›ç¨‹æˆ–æ›´æ¢ç«¯å£

# 3. é‡æ–°å¯åŠ¨æœåŠ¡å™¨
python3 server.py

# 4. ä½¿ç”¨å…¶ä»–ç«¯å£
python3 server.py 8080
```

#### é—®é¢˜2: Live2Dæ¨¡å‹ä¸æ˜¾ç¤º
**ç—‡çŠ¶**: ç½‘é¡µåŠ è½½ä½†çœ‹ä¸åˆ°Live2Dæ¨¡å‹

**å¯èƒ½åŸå› **:
- Live2Dèµ„æºæ–‡ä»¶ç¼ºå¤±
- JavaScriptåŠ è½½é”™è¯¯
- æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æ¨¡å‹æ–‡ä»¶
ls -la Mould/Z.model3.json
ls -la libs/live2dcubismcore.min.js

# 2. æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·
# F12 â†’ Console æŸ¥çœ‹JavaScripté”™è¯¯

# 3. å°è¯•ä½¿ç”¨Chromeæµè§ˆå™¨ (æœ€ä½³å…¼å®¹æ€§)

# 4. æ£€æŸ¥æ–‡ä»¶æƒé™
chmod 644 Mould/*.json
chmod 644 libs/*.js
```

#### é—®é¢˜3: å°æ™ºAIæ— å›å¤
**ç—‡çŠ¶**: å‘é€æ¶ˆæ¯åæ²¡æœ‰AIå›å¤

**å¯èƒ½åŸå› **:
- æ¶ˆæ¯å¤„ç†å™¨æœªå¯åŠ¨
- WebSocketè¿æ¥å¤±è´¥
- xiaozhi_device.jsoné…ç½®é”™è¯¯
- ç½‘ç»œè¿æ¥é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ£€æŸ¥æ¶ˆæ¯å¤„ç†å™¨è¿›ç¨‹
ps aux | grep "message_handler"

# 2. æ£€æŸ¥xiaozhi_device.jsonæ–‡ä»¶
cat xiaozhi_device.json
# ç¡®ä¿æ‰€æœ‰å‚æ•°æ­£ç¡®ï¼Œç‰¹åˆ«æ˜¯device_idå’Œhmac_key

# 3. é‡å¯æ¶ˆæ¯å¤„ç†å™¨
killall -f simple_message_handler.py
python3 simple_message_handler.py

# 4. æ£€æŸ¥ç½‘ç»œè¿æ¥
ping api.tenclass.net

# 5. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
python3 simple_message_handler.py  # è§‚å¯Ÿè¾“å‡ºçš„é”™è¯¯ä¿¡æ¯
```

#### é—®é¢˜4: è¯­éŸ³è¯†åˆ«ä¸å·¥ä½œ
**ç—‡çŠ¶**: ç‚¹å‡»éº¦å…‹é£æŒ‰é’®æ— ååº”æˆ–æ— æ³•è¯†åˆ«è¯­éŸ³

**å¯èƒ½åŸå› **:
- æµè§ˆå™¨ä¸æ”¯æŒWeb Speech API
- éº¦å…‹é£æƒé™æœªæˆäºˆ
- ç½‘ç»œé—®é¢˜å½±å“è¯­éŸ³æœåŠ¡

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. ä½¿ç”¨Chromeæµè§ˆå™¨ (æœ€ä½³æ”¯æŒ)

# 2. æ£€æŸ¥æµè§ˆå™¨éº¦å…‹é£æƒé™
# Chrome: è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ ç½‘ç«™è®¾ç½® â†’ éº¦å…‹é£
# ç¡®ä¿localhostè¢«å…è®¸ä½¿ç”¨éº¦å…‹é£

# 3. æ£€æŸ¥ç³»ç»Ÿéº¦å…‹é£æƒé™ (macOS)
# ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ éšç§ â†’ éº¦å…‹é£
# ç¡®ä¿Chromeè¢«æˆæƒ

# 4. æµ‹è¯•éº¦å…‹é£ç¡¬ä»¶
# åœ¨å…¶ä»–åº”ç”¨ä¸­æµ‹è¯•éº¦å…‹é£æ˜¯å¦æ­£å¸¸å·¥ä½œ
```

#### é—®é¢˜5: Live2Dè¡¨æƒ…ä¸åŒæ­¥
**ç—‡çŠ¶**: AIæœ‰å›å¤ä½†Live2Dæ¨¡å‹è¡¨æƒ…ä¸å˜åŒ–

**å¯èƒ½åŸå› **:
- æƒ…æ„Ÿæ˜ å°„æ¨¡å—å¼‚å¸¸
- é˜Ÿåˆ—é€šä¿¡æ•…éšœ
- è½®è¯¢æœºåˆ¶å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æµ‹è¯•æƒ…æ„Ÿæ˜ å°„
python3 emotion_mapping.py

# 2. æ£€æŸ¥é˜Ÿåˆ—çŠ¶æ€
python3 shared_queues.py

# 3. æ¸…ç©ºé˜Ÿåˆ—é‡è¯•
python3 -c "from shared_queues import clear_all_queues; clear_all_queues()"

# 4. ä½¿ç”¨æµ‹è¯•é¡µé¢
# è®¿é—® http://127.0.0.1:3000/test_emotions.html
# æ‰‹åŠ¨æµ‹è¯•Live2Dæ§åˆ¶æ˜¯å¦æ­£å¸¸
```

#### é—®é¢˜6: å†…å­˜ä½¿ç”¨è¿‡é«˜
**ç—‡çŠ¶**: ç³»ç»Ÿè¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜å ç”¨å¾ˆå¤§

**å¯èƒ½åŸå› **:
- é˜Ÿåˆ—æ–‡ä»¶å †ç§¯
- æœªæ¸…ç†çš„WebSocketè¿æ¥
- éŸ³é¢‘ç¼“å­˜å †ç§¯

**è§£å†³æ–¹æ¡ˆ**:
```bash
# 1. æ¸…ç©ºé˜Ÿåˆ—æ–‡ä»¶
rm -rf /tmp/xiaozhi_queues/*

# 2. é‡å¯æ‰€æœ‰æœåŠ¡
killall -f simple_message_handler.py
killall -f server.py
python3 start_robust_system.py

# 3. ç›‘æ§å†…å­˜ä½¿ç”¨
# macOS: Activity Monitor
# Linux: htop æˆ– free -h
# Windows: Task Manager
```

### æ—¥å¿—åˆ†æ

#### æ¶ˆæ¯å¤„ç†å™¨æ—¥å¿—
```bash
# æ­£å¸¸è¿æ¥æ—¥å¿—:
# âœ… WebSocketè¿æ¥æˆåŠŸ
# ğŸ”„ å¿ƒè·³åŒ…å‘é€æˆåŠŸ
# ğŸ“¨ æ”¶åˆ°AIå›å¤: [æ¶ˆæ¯å†…å®¹]

# å¼‚å¸¸è¿æ¥æ—¥å¿—:
# âŒ WebSocketè¿æ¥å¤±è´¥
# âš ï¸ è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿...
# âŒ è®¤è¯å¤±è´¥ï¼Œæ£€æŸ¥è®¾å¤‡é…ç½®
```

#### WebæœåŠ¡å™¨æ—¥å¿—
```bash
# æ­£å¸¸APIè°ƒç”¨:
# [CHAT] æ”¶åˆ°æ¶ˆæ¯: user - ä½ å¥½
# [POLL] è·å–AIå›å¤: æ‚¨å¥½...
# [Live2D] å‘½ä»¤å·²åŠ å…¥é˜Ÿåˆ—: {"type": "live2d_control", ...}

# å¼‚å¸¸APIè°ƒç”¨:
# [CHAT] èŠå¤©APIé”™è¯¯: [é”™è¯¯è¯¦æƒ…]
# [POLL] è½®è¯¢å›å¤é”™è¯¯: [é”™è¯¯è¯¦æƒ…]
```

### ç´§æ€¥æ¢å¤æ­¥éª¤

å¦‚æœç³»ç»Ÿå®Œå…¨æ— æ³•å·¥ä½œ,æŒ‰ä»¥ä¸‹æ­¥éª¤æ¢å¤:

```bash
# 1. åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
killall -f python3
killall -f simple_message_handler.py
killall -f server.py

# 2. æ¸…ç©ºä¸´æ—¶æ–‡ä»¶
rm -rf /tmp/xiaozhi_queues/
rm -rf /tmp/xiaozhi_activation_request

# 3. æ£€æŸ¥é¡¹ç›®å®Œæ•´æ€§
cd /path/to/Zoe
ls -la server.py simple_message_handler.py xiaozhi_device.json

# 4. é‡æ–°å®‰è£…ä¾èµ–
pip3 install --upgrade websockets aiohttp requests

# 5. ä»æœ€å°é…ç½®é‡å¯
python3 simple_message_handler.py &
sleep 3
python3 server.py

# 6. éªŒè¯åŸºç¡€åŠŸèƒ½
curl http://127.0.0.1:3000/api/system_status
```

---

## ğŸ“š APIæ¥å£æ–‡æ¡£

### HTTP APIæ¥å£

æ‰€æœ‰APIæ¥å£å‡æ”¯æŒCORSè·¨åŸŸè®¿é—®ï¼ŒBase URL: `http://127.0.0.1:3000`

#### 1. èŠå¤©æ¶ˆæ¯æ¥å£

**POST** `/api/chat`

å‘é€èŠå¤©æ¶ˆæ¯ç»™AIã€‚

**è¯·æ±‚ä½“**:
```json
{
  "type": "user_message",
  "text": "ä½ å¥½ä¸–ç•Œ",
  "sender": "user"
}
```

**å“åº”**:
```json
{
  "status": "success",
  "message": "Message received and queued for processing",
  "timestamp": 1694123456.789
}
```

#### 2. AIå›å¤è½®è¯¢æ¥å£

**GET** `/api/poll_reply`

è½®è¯¢è·å–AIå›å¤æ¶ˆæ¯ã€‚å‰ç«¯åº”è¯¥æ¯1-2ç§’è°ƒç”¨ä¸€æ¬¡ã€‚

**å“åº” (æœ‰å›å¤)**:
```json
{
  "status": "success",
  "has_reply": true,
  "replies": [
    {
      "text": "æ‚¨å¥½ï¼æˆ‘æ˜¯å°æ™ºï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼",
      "timestamp": 1694123456.789,
      "emotion": "happy",
      "source": "xiaozhi_ai"
    }
  ],
  "count": 1,
  "timestamp": 1694123456.789
}
```

**å“åº” (æ— å›å¤)**:
```json
{
  "status": "success",
  "has_reply": false,
  "timestamp": 1694123456.789
}
```

#### 3. Live2Dæ§åˆ¶æ¥å£

**POST** `/api/live2d`

æ§åˆ¶Live2Dæ¨¡å‹åŠ¨ä½œå’Œè¡¨æƒ…ã€‚

**è¯·æ±‚ä½“ (æ–°æ ¼å¼)**:
```json
{
  "type": "action",        // "action" æˆ– "expression"
  "name": "kaixin",        // åŠ¨ä½œ/è¡¨æƒ…åç§°
  "source": "emotion_controller"
}
```

**è¯·æ±‚ä½“ (æ—§æ ¼å¼ï¼Œå…¼å®¹)**:
```json
{
  "action": "kaixin",
  "expression": "love_eyes"
}
```

**å“åº”**:
```json
{
  "status": "success",
  "message": "Live2Då‘½ä»¤æ‰§è¡Œ: action.kaixin",
  "timestamp": 1694123456.789
}
```

#### 4. Live2Då‘½ä»¤è½®è¯¢æ¥å£

**GET** `/api/poll_live2d`

è½®è¯¢è·å–Live2Dæ§åˆ¶å‘½ä»¤ã€‚å‰ç«¯Live2Dæ§åˆ¶å™¨åº”è¯¥æŒç»­è°ƒç”¨ã€‚

**å“åº” (æœ‰å‘½ä»¤)**:
```json
{
  "status": "success",
  "has_command": true,
  "command": {
    "type": "live2d_control",
    "action": "kaixin",
    "expression": "love_eyes",
    "timestamp": 1694123456.789,
    "source": "emotion_controller"
  },
  "timestamp": 1694123456.789
}
```

#### 5. ç³»ç»ŸçŠ¶æ€æ¥å£

**GET** `/api/system_status`

è·å–ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ä¿¡æ¯ã€‚

**å“åº”**:
```json
{
  "status": "success",
  "system_status": {
    "websocket_connected": true,
    "last_heartbeat": 1694123456.789,
    "message_count": 42,
    "connection_status": "connected",
    "device_activated": true
  },
  "timestamp": 1694123456.789
}
```

#### 6. æ¿€æ´»é‡è¿æ¥å£

**POST** `/api/activate`

è§¦å‘å°æ™ºAIè¿æ¥é‡æ–°æ¿€æ´»ã€‚

**å“åº”**:
```json
{
  "status": "success",
  "message": "æ¿€æ´»è¯·æ±‚å·²å‘é€",
  "timestamp": 1694123456.789
}
```

#### 7. JavaScriptæ‰§è¡Œæ¥å£

**POST** `/execute-js`

æ‰§è¡Œå‰ç«¯JavaScriptä»£ç ï¼ˆä¸»è¦ç”¨äºè°ƒè¯•ï¼‰ã€‚

**è¯·æ±‚ä½“**:
```json
{
  "code": "console.log('Hello World');"
}
```

**å“åº”**:
```json
{
  "status": "success",
  "message": "JavaScript executed",
  "timestamp": 1694123456.789
}
```

### JavaScriptå‰ç«¯API

#### Live2Dæ§åˆ¶å‡½æ•°

```javascript
// æ’­æ”¾åŠ¨ä½œ
function playAction(actionName) {
    // actionName: "idle", "kaixin", "jingya", "shengqi", "wink", "yaotou"
}

// è®¾ç½®è¡¨æƒ…
function setExpression(expressionName) {
    // expressionName: "love_eyes", "angry", "star_eyes", "crying", "tongue"
}

// ç»¼åˆæ§åˆ¶
function applyEmotionMapping(emotion) {
    // emotion: "happy", "sad", "angry", "surprised", etc.
}
```

#### èŠå¤©åŠŸèƒ½å‡½æ•°

```javascript
// å‘é€æ¶ˆæ¯
function sendMessage(text) {
    // å‘é€æ–‡æœ¬æ¶ˆæ¯ç»™AI
}

// å¼€å§‹è¯­éŸ³è¯†åˆ«
function startVoiceRecognition() {
    // å¼€å§‹Web Speech APIè¯­éŸ³è¯†åˆ«
}

// åœæ­¢è¯­éŸ³è¯†åˆ«
function stopVoiceRecognition() {
    // åœæ­¢è¯­éŸ³è¯†åˆ«
}
```

#### è½®è¯¢æ§åˆ¶å‡½æ•°

```javascript
// å¯åŠ¨å›å¤è½®è¯¢
function startReplyPolling() {
    // å¼€å§‹è½®è¯¢AIå›å¤ï¼Œé—´éš”1000ms
}

// å¯åŠ¨Live2Dè½®è¯¢
function startLive2DPolling() {
    // å¼€å§‹è½®è¯¢Live2Då‘½ä»¤ï¼Œé—´éš”500ms
}
```

### é”™è¯¯ä»£ç è¯´æ˜

| HTTPçŠ¶æ€ç  | é”™è¯¯ç±»å‹ | è¯´æ˜ |
|-----------|---------|------|
| 200 | æˆåŠŸ | è¯·æ±‚å¤„ç†æˆåŠŸ |
| 404 | æ¥å£ä¸å­˜åœ¨ | API endpoint not found |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ | è¯¦ç»†é”™è¯¯ä¿¡æ¯åœ¨å“åº”ä½“ä¸­ |

---

## ğŸ”§ ç»´æŠ¤æŒ‡å—

### æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡

#### 1. ç³»ç»Ÿç›‘æ§

**æ£€æŸ¥ç³»ç»ŸçŠ¶æ€** (æ¯å¤©):
```bash
# æ£€æŸ¥æœåŠ¡è¿›ç¨‹çŠ¶æ€
ps aux | grep -E "(server\.py|message_handler\.py)"

# æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
netstat -tulpn | grep 3000

# æ£€æŸ¥ç³»ç»ŸçŠ¶æ€API
curl -s http://127.0.0.1:3000/api/system_status | python3 -m json.tool
```

**ç›‘æ§ç³»ç»Ÿèµ„æº** (æ¯å‘¨):
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
free -h  # Linux
vm_stat # macOS

# æ£€æŸ¥ç£ç›˜ä½¿ç”¨
df -h

# æ£€æŸ¥é˜Ÿåˆ—æ–‡ä»¶å¤§å°
du -sh /tmp/xiaozhi_queues/
```

#### 2. æ—¥å¿—ç®¡ç†

**æ—¥å¿—è½®è½¬è®¾ç½®**:
```bash
# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# é‡å®šå‘æ—¥å¿—è¾“å‡º
python3 server.py > logs/server.log 2>&1 &
python3 simple_message_handler.py > logs/message_handler.log 2>&1 &

# è®¾ç½®æ—¥å¿—è½®è½¬ (Linux)
# ç¼–è¾‘ /etc/logrotate.d/xiaozhi
/path/to/Zoe/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

#### 3. é˜Ÿåˆ—æ¸…ç†

**è‡ªåŠ¨æ¸…ç†è„šæœ¬** (`cleanup.py`):
```python
#!/usr/bin/env python3
import os
import time
from shared_queues import clear_all_queues, get_queue_status

def cleanup_queues():
    """æ¸…ç†è¿‡æœŸé˜Ÿåˆ—æ•°æ®"""
    status = get_queue_status()
    total_size = sum(status.values())

    if total_size > 100:  # é˜Ÿåˆ—é¡¹ç›®è¶…è¿‡100ä¸ªæ—¶æ¸…ç†
        print(f"ğŸ§¹ é˜Ÿåˆ—å¤§å°: {total_size}, å¼€å§‹æ¸…ç†...")
        clear_all_queues()
        print("âœ… é˜Ÿåˆ—æ¸…ç†å®Œæˆ")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    temp_files = [
        "/tmp/xiaozhi_activation_request",
    ]

    for file_path in temp_files:
        if os.path.exists(file_path):
            os.remove(file_path)
            print(f"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶: {file_path}")

if __name__ == "__main__":
    cleanup_queues()
```

**å®šæœŸæ‰§è¡Œæ¸…ç†** (crontab):
```bash
# ç¼–è¾‘å®šæ—¶ä»»åŠ¡
crontab -e

# æ·»åŠ æ¯å°æ—¶æ¸…ç†ä»»åŠ¡
0 * * * * cd /path/to/Zoe && python3 cleanup.py
```

### æ€§èƒ½ä¼˜åŒ–

#### 1. å†…å­˜ä¼˜åŒ–

**é˜Ÿåˆ—å¤§å°é™åˆ¶**:
```python
# åœ¨shared_queues.pyä¸­æ·»åŠ é˜Ÿåˆ—å¤§å°é™åˆ¶
MAX_QUEUE_SIZE = 50

def put_with_limit(queue, item):
    if queue.qsize() > MAX_QUEUE_SIZE:
        # ç§»é™¤æœ€æ—§çš„é¡¹ç›®
        try:
            queue.get_nowait()
        except:
            pass
    queue.put(item)
```

**è¿æ¥æ± é…ç½®**:
```python
# åœ¨message_handlerä¸­é™åˆ¶è¿æ¥æ•°
import aiohttp
connector = aiohttp.TCPConnector(
    limit=100,           # æ€»è¿æ¥æ•°é™åˆ¶
    limit_per_host=30,   # å•åŸŸåè¿æ¥æ•°é™åˆ¶
    ttl_dns_cache=300,   # DNSç¼“å­˜æ—¶é—´
    use_dns_cache=True,  # å¯ç”¨DNSç¼“å­˜
)
```

#### 2. ç½‘ç»œä¼˜åŒ–

**WebSocketå¿ƒè·³ä¼˜åŒ–**:
```python
# è°ƒæ•´å¿ƒè·³é—´éš”
HEARTBEAT_INTERVAL = 30  # 30ç§’å¿ƒè·³ï¼Œå‡å°‘ç½‘ç»œå¼€é”€

# å¯ç”¨WebSocketå‹ç¼©
websocket = await websockets.connect(
    url,
    compression="deflate",  # å¯ç”¨å‹ç¼©
    max_size=1024*1024     # 1MBæ¶ˆæ¯å¤§å°é™åˆ¶
)
```

**HTTPè¯·æ±‚ç¼“å­˜**:
```javascript
// åœ¨å‰ç«¯æ·»åŠ è¯·æ±‚ç¼“å­˜
const cache = new Map();

function cachedFetch(url, options = {}) {
    const key = url + JSON.stringify(options);
    const cached = cache.get(key);

    if (cached && Date.now() - cached.timestamp < 5000) { // 5ç§’ç¼“å­˜
        return Promise.resolve(cached.response);
    }

    return fetch(url, options).then(response => {
        cache.set(key, {
            response: response.clone(),
            timestamp: Date.now()
        });
        return response;
    });
}
```

### å®‰å…¨åŠ å›º

#### 1. ç½‘ç»œå®‰å…¨

**HTTPå®‰å…¨å¤´**:
```python
# åœ¨server.pyä¸­æ·»åŠ å®‰å…¨å¤´
def end_headers(self):
    self.send_header('X-Content-Type-Options', 'nosniff')
    self.send_header('X-Frame-Options', 'DENY')
    self.send_header('X-XSS-Protection', '1; mode=block')
    self.send_header('Referrer-Policy', 'strict-origin-when-cross-origin')
    super().end_headers()
```

**è¯·æ±‚é™åˆ¶**:
```python
# æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶
import time
from collections import defaultdict

request_counts = defaultdict(list)
RATE_LIMIT = 100  # æ¯åˆ†é’Ÿ100è¯·æ±‚

def check_rate_limit(client_ip):
    now = time.time()
    minute_ago = now - 60

    # æ¸…ç†è¿‡æœŸè®°å½•
    request_counts[client_ip] = [
        req_time for req_time in request_counts[client_ip]
        if req_time > minute_ago
    ]

    # æ£€æŸ¥é¢‘ç‡é™åˆ¶
    if len(request_counts[client_ip]) >= RATE_LIMIT:
        return False

    request_counts[client_ip].append(now)
    return True
```

#### 2. é…ç½®å®‰å…¨

**æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**:
```bash
# è®¾ç½®é…ç½®æ–‡ä»¶æƒé™
chmod 600 xiaozhi_device.json

# ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨æ•æ„Ÿä¿¡æ¯
export XIAOZHI_HMAC_KEY="your_hmac_key_here"
export XIAOZHI_CLIENT_ID="your_client_id_here"
```

**é˜²æ­¢é…ç½®æ³„æ¼**:
```python
# åœ¨ä»£ç ä¸­é¿å…æ‰“å°æ•æ„Ÿä¿¡æ¯
import json
import re

def safe_print_config(config):
    """å®‰å…¨æ‰“å°é…ç½®ï¼Œéšè—æ•æ„Ÿä¿¡æ¯"""
    safe_config = config.copy()

    # éšè—æ•æ„Ÿå­—æ®µ
    sensitive_fields = ['hmac_key', 'client_id', 'websocket_token']
    for field in sensitive_fields:
        if field in safe_config:
            safe_config[field] = safe_config[field][:8] + "***"

    print("ğŸ”§ é…ç½®ä¿¡æ¯:", json.dumps(safe_config, indent=2))
```

### å‡çº§æŒ‡å—

#### 1. å¤‡ä»½æ•°æ®

**åˆ›å»ºå¤‡ä»½è„šæœ¬** (`backup.sh`):
```bash
#!/bin/bash
BACKUP_DIR="/path/to/backups"
PROJECT_DIR="/path/to/Zoe"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½é¡¹ç›®æ–‡ä»¶
tar -czf "$BACKUP_DIR/zoe_backup_$DATE.tar.gz" \
    -C "$(dirname $PROJECT_DIR)" "$(basename $PROJECT_DIR)" \
    --exclude="__pycache__" \
    --exclude=".git" \
    --exclude="logs" \
    --exclude="/tmp/xiaozhi_queues"

echo "âœ… å¤‡ä»½å®Œæˆ: zoe_backup_$DATE.tar.gz"
```

#### 2. æ›´æ–°æµç¨‹

**å®‰å…¨æ›´æ–°æ­¥éª¤**:
```bash
# 1. å¤‡ä»½å½“å‰ç³»ç»Ÿ
./backup.sh

# 2. åœæ­¢æœåŠ¡
killall -f simple_message_handler.py
killall -f server.py

# 3. æ›´æ–°ä»£ç 
git pull origin main
# æˆ–è€…æ‰‹åŠ¨æ›¿æ¢æ–‡ä»¶

# 4. æ£€æŸ¥é…ç½®å…¼å®¹æ€§
python3 -c "import json; json.load(open('xiaozhi_device.json'))"

# 5. æµ‹è¯•æ–°ç‰ˆæœ¬
python3 simple_message_handler.py &
sleep 3
python3 server.py &

# 6. éªŒè¯åŠŸèƒ½
curl http://127.0.0.1:3000/api/system_status

# 7. å¦‚æœæœ‰é—®é¢˜ï¼Œå›æ»š
# tar -xzf /path/to/backups/zoe_backup_XXXXXX.tar.gz
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è·å–å¸®åŠ©

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–æ”¯æŒ:

1. **æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶**: é¦–å…ˆæ£€æŸ¥ç³»ç»Ÿæ—¥å¿—ï¼Œå¤§å¤šæ•°é—®é¢˜éƒ½ä¼šæœ‰ç›¸åº”çš„é”™è¯¯ä¿¡æ¯
2. **ä½¿ç”¨æµ‹è¯•é¡µé¢**: è®¿é—® `test_emotions.html` è¿›è¡ŒåŠŸèƒ½æµ‹è¯•
3. **æ£€æŸ¥ç½‘ç»œè¿æ¥**: ç¡®è®¤åˆ° `api.tenclass.net` çš„ç½‘ç»œè¿é€šæ€§
4. **é‡å¯æœåŠ¡**: æŒ‰ç…§æ•…éšœæ’é™¤éƒ¨åˆ†çš„æ­¥éª¤é‡å¯ç›¸å…³æœåŠ¡

### ç³»ç»Ÿä¿¡æ¯æ”¶é›†

åœ¨æŠ¥å‘Šé—®é¢˜æ—¶ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯:

```bash
# ç³»ç»Ÿä¿¡æ¯
uname -a                    # æ“ä½œç³»ç»Ÿä¿¡æ¯
python3 --version           # Pythonç‰ˆæœ¬
pip3 list | grep -E "(websockets|aiohttp|requests)"  # å…³é”®ä¾èµ–ç‰ˆæœ¬

# æœåŠ¡çŠ¶æ€
ps aux | grep -E "(server\.py|message_handler\.py)"  # è¿›ç¨‹çŠ¶æ€
netstat -tulpn | grep 3000  # ç«¯å£çŠ¶æ€
curl -s http://127.0.0.1:3000/api/system_status     # ç³»ç»ŸçŠ¶æ€

# é”™è¯¯æ—¥å¿— (æœ€è¿‘50è¡Œ)
tail -50 logs/server.log
tail -50 logs/message_handler.log
```

---

## ğŸ“„ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†Live2Då°æ™ºAIç³»ç»Ÿçš„å®Œæ•´éƒ¨ç½²æŒ‡å—ï¼ŒåŒ…å«:

âœ… **å®Œæ•´çš„ç³»ç»Ÿè¦æ±‚å’Œç¯å¢ƒå‡†å¤‡è¯´æ˜**
âœ… **è¯¦ç»†çš„å®‰è£…éƒ¨ç½²æ­¥éª¤**
âœ… **å…¨é¢çš„é…ç½®å‚æ•°è¯´æ˜**
âœ… **å¤šç§å¯åŠ¨æ–¹å¼å’Œè¿è¡ŒæŒ‡å¯¼**
âœ… **å®Œæ•´çš„åŠŸèƒ½éªŒè¯æµç¨‹**
âœ… **è¯¦å°½çš„æ•…éšœæ’é™¤æŒ‡å—**
âœ… **å®Œæ•´çš„APIæ¥å£æ–‡æ¡£**
âœ… **ç³»ç»Ÿç»´æŠ¤å’Œä¼˜åŒ–æŒ‡å¯¼**

æŒ‰ç…§æœ¬æ–‡æ¡£çš„æ­¥éª¤æ“ä½œï¼Œæ‚¨åº”è¯¥èƒ½å¤ŸæˆåŠŸéƒ¨ç½²å¹¶è¿è¡ŒLive2Då°æ™ºAIç³»ç»Ÿã€‚å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒæ•…éšœæ’é™¤éƒ¨åˆ†æˆ–æŒ‰ç…§æŠ€æœ¯æ”¯æŒéƒ¨åˆ†çš„æŒ‡å¯¼æ”¶é›†ç›¸å…³ä¿¡æ¯ã€‚

> **é‡è¦æé†’**: è¯·å®šæœŸå¤‡ä»½é…ç½®æ–‡ä»¶å’Œé‡è¦æ•°æ®ï¼Œç‰¹åˆ«æ˜¯ `xiaozhi_device.json` æ–‡ä»¶ï¼Œä»¥é˜²ä¸¢å¤±å½±å“ç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*æœ€åæ›´æ–°: 2024å¹´9æœˆ*
*é€‚ç”¨ç³»ç»Ÿ: Live2Då°æ™ºAIç³»ç»Ÿ v1.0*