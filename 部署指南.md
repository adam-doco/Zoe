# Live2D小智AI系统部署指南

## 📋 目录
1. [系统概述](#系统概述)
2. [系统要求](#系统要求)
3. [项目结构](#项目结构)
4. [环境准备](#环境准备)
5. [安装部署](#安装部署)
6. [配置说明](#配置说明)
7. [启动运行](#启动运行)
8. [功能验证](#功能验证)
9. [故障排除](#故障排除)
10. [API接口文档](#API接口文档)
11. [维护指南](#维护指南)

---

## 🎯 系统概述

Live2D小智AI系统是一个集成了Live2D模型动画、小智AI对话、语音识别和情感映射的交互式Web应用。系统采用前后端分离架构，支持实时对话、语音输入、情感表达和Live2D模型动作同步。

### 核心功能
- 🎭 **Live2D模型控制**: 支持32+种情感表情和动作映射
- 🤖 **小智AI对话**: WebSocket连接小智AI服务，支持智能对话
- 🎤 **语音识别**: 基于Web Speech API的实时语音输入
- 😊 **情感映射**: 智能情感分析并同步到Live2D表情
- 🔄 **实时通信**: 基于轮询机制的前后端数据同步
- 📱 **响应式界面**: 支持多设备访问的现代化Web界面

### 系统架构
```
┌─────────────────┐    HTTP/WS     ┌──────────────────┐
│   前端界面      │ ──────────────→│   Flask服务器    │
│  (index.html)   │                │   (server.py)    │
└─────────────────┘                └──────────────────┘
         │                                   │
         │ 轮询API                            │ 队列通信
         ▼                                   ▼
┌─────────────────┐                ┌──────────────────┐
│  Live2D控制     │                │   消息处理器     │
│ 情感映射系统    │                │(message_handler) │
└─────────────────┘                └──────────────────┘
                                           │
                                           │ WebSocket
                                           ▼
                                  ┌──────────────────┐
                                  │   小智AI服务     │
                                  │  (api.tenclass)  │
                                  └──────────────────┘
```

---

## 🖥️ 系统要求

### 操作系统支持
- ✅ **macOS** 10.14+ (推荐)
- ✅ **Windows** 10/11
- ✅ **Linux** Ubuntu 18.04+/CentOS 7+

### Python环境
- **Python版本**: 3.8+ (推荐Python 3.9或3.10)
- **包管理工具**: pip (通常随Python安装)

### 浏览器支持
- ✅ **Chrome** 80+ (推荐，最佳兼容性)
- ✅ **Firefox** 75+
- ✅ **Safari** 13+ (macOS)
- ✅ **Edge** 80+
- ❌ Internet Explorer (不支持)

> **注意**: 语音识别功能需要浏览器支持Web Speech API，推荐使用Chrome浏览器

### 硬件要求
- **CPU**: 双核2.0GHz以上
- **内存**: 4GB以上可用RAM
- **存储**: 500MB可用磁盘空间
- **网络**: 稳定的互联网连接（用于小智AI通信）

### 网络要求
- **出站连接**: 访问 `api.tenclass.net` (小智AI服务)
- **本地端口**: 3000端口可用（可配置）
- **防火墙**: 允许Python程序网络访问

---

## 📁 项目结构

```
Zoe/                              # 项目根目录
├── 部署指南.md                   # 本文档
├── server.py                     # Flask Web服务器 (主要服务)
├── simple_message_handler.py     # 消息处理器 (核心通信模块)
├── robust_message_handler.py     # 增强版消息处理器
├── shared_queues.py              # 跨进程通信队列
├── emotion_mapping.py            # 情感映射配置
├── xiaozhi_device.json           # 设备配置文件 (重要)
├── index.html                    # 主页面 (前端界面)
├── test_emotions.html            # 情感测试页面
├── start_robust_system.py        # 系统启动脚本
│
├── Mould/                        # Live2D模型资源
│   ├── Z.model3.json            # 模型定义文件
│   ├── Z.cdi3.json              # 模型配置
│   ├── Z.physics3.json          # 物理引擎配置
│   ├── motions/                 # 动作文件目录
│   │   ├── Idle.motion3.json    # 待机动作
│   │   ├── kaixin.motion3.json  # 开心动作
│   │   ├── shengqi.motion3.json # 生气动作
│   │   ├── jingya.motion3.json  # 惊讶动作
│   │   ├── wink.motion3.json    # 眨眼动作
│   │   └── yaotou.motion3.json  # 摇头动作
│   └── textures/                # 贴图资源
│
└── libs/                        # 第三方库
    └── live2dcubismcore.min.js  # Live2D核心库
```

### 关键文件说明

| 文件名 | 作用 | 重要程度 |
|--------|------|----------|
| `server.py` | Web服务器,提供HTTP API和静态文件服务 | ⭐⭐⭐⭐⭐ |
| `simple_message_handler.py` | 处理与小智AI的WebSocket通信 | ⭐⭐⭐⭐⭐ |
| `xiaozhi_device.json` | 小智AI设备认证配置 | ⭐⭐⭐⭐⭐ |
| `index.html` | 主界面,包含Live2D和语音控制 | ⭐⭐⭐⭐ |
| `emotion_mapping.py` | 情感到Live2D动作的映射规则 | ⭐⭐⭐ |
| `shared_queues.py` | 进程间通信队列 | ⭐⭐⭐ |

---

## 🛠️ 环境准备

### 1. Python环境检查
```bash
# 检查Python版本 (需要3.8+)
python3 --version
# 或者
python --version

# 检查pip版本
pip3 --version
# 或者
pip --version
```

### 2. 安装Python依赖
项目所需的Python包:
```bash
# 核心依赖
pip3 install websockets aiohttp requests

# 可选：如果需要音频处理
pip3 install pyaudio pydub

# HTTP服务器 (Python内置，无需额外安装)
# - http.server
# - socketserver
# - json
# - queue
# - threading
```

完整安装命令:
```bash
pip3 install websockets aiohttp requests
```

### 3. 系统权限设置

#### macOS系统
```bash
# 确保Python有网络访问权限
# 首次运行时系统会弹出权限请求对话框，需要允许

# 如果需要麦克风权限（语音功能）
# 在"系统偏好设置 > 安全性与隐私 > 隐私 > 麦克风"中
# 勾选浏览器应用（Chrome/Safari等）
```

#### Windows系统
```cmd
:: 确保防火墙允许Python程序
:: 首次运行时Windows Defender会询问网络访问权限，选择"允许"

:: 如果遇到端口占用，可以检查端口使用情况:
netstat -ano | findstr 3000
```

#### Linux系统
```bash
# 安装音频系统依赖（如果需要语音功能）
sudo apt-get update
sudo apt-get install pulseaudio alsa-utils

# 检查端口使用情况
netstat -tulpn | grep 3000
```

---

## 🚀 安装部署

### 步骤1: 获取项目文件

```bash
# 方法1: 从Git仓库克隆 (如果有的话)
git clone [仓库地址]
cd Zoe

# 方法2: 直接下载项目包
# 将所有文件解压到目标目录
# 确保目录结构与上述"项目结构"一致
```

### 步骤2: 验证项目完整性

```bash
cd /path/to/Zoe

# 检查关键文件是否存在
ls -la server.py simple_message_handler.py xiaozhi_device.json index.html

# 检查Live2D模型文件
ls -la Mould/Z.model3.json Mould/motions/ libs/live2dcubismcore.min.js

# 预期输出应该显示所有文件都存在
```

### 步骤3: 配置设备文件

编辑 `xiaozhi_device.json` 文件:
```json
{
  "device_id": "02:00:00:00:b7:aa",
  "client_id": "a853e63d-798f-4564-8098-58f913efc510",
  "serial": "SN-2FDFDDDD-02000000B7AA",
  "hmac_key": "b24706e52bfed846bcf9b4116fdb7a2f6c7382c69204e10ea",
  "activated": "true",
  "websocket_url": "wss://api.tenclass.net/xiaozhi/v1/",
  "websocket_token": "test-token"
}
```

> **重要**: 这些配置参数对于小智AI连接至关重要，请确保参数正确

### 步骤4: 测试Python依赖

```bash
cd /path/to/Zoe

# 测试导入核心模块
python3 -c "import websockets, aiohttp, requests, json, threading, queue; print('✅ 所有依赖正常')"

# 测试项目模块导入
python3 -c "import shared_queues, emotion_mapping; print('✅ 项目模块正常')"
```

### 步骤5: 网络连接测试

```bash
# 测试小智AI服务器连通性
ping api.tenclass.net

# 测试WebSocket连接 (可选)
curl -I https://api.tenclass.net/

# 检查本地端口3000是否被占用
netstat -tulpn | grep 3000  # Linux/macOS
netstat -ano | findstr 3000  # Windows
```

---

## ⚙️ 配置说明

### 1. 服务器配置 (server.py)

主要配置项位于文件底部:
```python
if __name__ == "__main__":
    port = 3000                           # HTTP服务端口
    directory = "/Users/good/Desktop/Zoe" # 项目根目录路径

    # 可通过命令行参数覆盖:
    # python3 server.py [端口] [目录路径]
```

### 2. 小智AI配置 (xiaozhi_device.json)

| 参数 | 说明 | 是否可修改 |
|------|------|-----------|
| `device_id` | 设备MAC地址标识 | ❌ 请勿修改 |
| `client_id` | 客户端UUID | ❌ 请勿修改 |
| `serial` | 设备序列号 | ❌ 请勿修改 |
| `hmac_key` | 认证密钥 | ❌ 请勿修改 |
| `activated` | 激活状态 | ✅ 可修改为"true"/"false" |
| `websocket_url` | 小智AI服务地址 | ⚠️ 仅在服务器变更时修改 |
| `websocket_token` | 认证令牌 | ⚠️ 仅在令牌更新时修改 |

### 3. 情感映射配置 (emotion_mapping.py)

支持的Live2D动作:
```python
available_actions = [
    "idle",      # 待机状态
    "jingya",    # 惊讶
    "kaixin",    # 开心
    "shengqi",   # 生气
    "wink",      # 眨眼/俏皮
    "yaotou",    # 摇头/困惑
    "talk"       # 说话 (已禁用，由TTS控制)
]
```

支持的Live2D表情:
```python
available_expressions = [
    "love_eyes",    # 爱心眼
    "angry",        # 愤怒
    "star_eyes",    # 星星眼
    "crying",       # 哭泣
    "microphone",   # 麦克风
    "coat",         # 外套
    "tongue"        # 吐舌头
]
```

### 4. 队列配置 (shared_queues.py)

系统使用基于文件的队列进行进程间通信，队列文件存储位置:
```python
queue_dir = "/tmp/xiaozhi_queues/"  # 队列文件目录

# 队列类型:
message_queue     # 前端消息 → 消息处理器
ai_reply_queue    # AI回复 → 前端
emotion_queue     # 情感数据 → Live2D控制
live2d_commands   # Live2D控制命令
```

---

## 🏃 启动运行

### 方法1: 手动分步启动 (推荐用于调试)

#### 步骤1: 启动消息处理器
```bash
cd /path/to/Zoe

# 启动小智AI消息处理器
python3 simple_message_handler.py

# 预期输出:
# 🔄 初始化消息处理器...
# 📡 连接小智AI服务器...
# ✅ WebSocket连接成功
# 🎯 消息处理器启动完成，等待消息...
```

#### 步骤2: 启动Web服务器
```bash
# 新开一个终端窗口
cd /path/to/Zoe

# 启动Flask Web服务器
python3 server.py

# 预期输出:
# 🌐 Live2D服务器启动成功
# 📍 地址: http://127.0.0.1:3000
# 📁 目录: /path/to/Zoe
# ✅ 支持POST API调用
# ==================================================
```

### 方法2: 使用启动脚本 (推荐用于生产)

```bash
cd /path/to/Zoe

# 使用系统启动脚本
python3 start_robust_system.py

# 脚本会依次启动:
# 1. 清空消息队列
# 2. 启动消息处理器 (后台)
# 3. 启动Web服务器 (前台)
```

### 方法3: 自定义启动

```bash
# 指定端口启动
python3 server.py 8080

# 指定端口和目录
python3 server.py 8080 /custom/path/to/project
```

### 启动成功验证

1. **检查服务状态**:
   ```bash
   # 检查端口是否被监听
   netstat -tulpn | grep 3000

   # 预期看到:
   # tcp 127.0.0.1:3000 LISTEN
   ```

2. **访问Web界面**:
   ```
   浏览器访问: http://127.0.0.1:3000
   ```

3. **检查后台进程**:
   ```bash
   # macOS/Linux
   ps aux | grep python | grep message_handler
   ps aux | grep python | grep server

   # Windows
   tasklist | findstr python
   ```

---

## ✅ 功能验证

### 1. 基础功能测试

#### Web界面访问测试
1. 打开浏览器访问: `http://127.0.0.1:3000`
2. 应该看到Live2D模型加载
3. 界面包含聊天输入框和语音按钮

#### Live2D模型测试
1. 访问测试页面: `http://127.0.0.1:3000/test_emotions.html`
2. 点击不同情感按钮测试Live2D动作
3. 观察模型是否正确播放对应动作和表情

#### API连通性测试
```bash
# 测试系统状态API
curl http://127.0.0.1:3000/api/system_status

# 预期响应:
# {"status": "success", "system_status": {...}, "timestamp": ...}

# 测试Live2D控制API
curl -X POST http://127.0.0.1:3000/api/live2d \
  -H "Content-Type: application/json" \
  -d '{"type":"action","name":"kaixin","source":"test"}'

# 预期响应:
# {"status": "success", "message": "Live2D命令执行: action.kaixin", ...}
```

### 2. 聊天功能测试

#### 文本聊天测试
1. 在聊天输入框中输入: "你好"
2. 点击发送或按回车
3. 等待3-5秒观察AI回复
4. 检查Live2D模型是否有情感反应

#### 语音输入测试
1. 点击麦克风按钮🎤
2. 浏览器会请求麦克风权限,点击"允许"
3. 对着麦克风说话,观察语音识别文字
4. 语音结束后自动发送给AI
5. 检查回复和Live2D反应

### 3. 情感映射测试

测试不同类型的对话,观察Live2D模型反应:

| 对话内容 | 预期情感 | 预期动作 | 预期表情 |
|---------|---------|---------|----------|
| "我很开心!" | happy | kaixin | love_eyes |
| "我生气了!" | angry | shengqi | angry |
| "真是太惊讶了!" | surprised | jingya | star_eyes |
| "我很难过" | sad | idle | crying |
| "你好吗?" | neutral | idle | None |

### 4. 系统稳定性测试

#### 连续对话测试
1. 连续发送10条以上消息
2. 观察系统是否有延迟或卡顿
3. 检查内存使用是否正常增长

#### 长时间运行测试
1. 让系统运行1小时以上
2. 定期发送消息测试响应速度
3. 观察是否有内存泄漏或连接断开

---

## 🚨 故障排除

### 常见问题及解决方案

#### 问题1: 无法访问 http://127.0.0.1:3000
**症状**: 浏览器显示"无法连接"或"连接被拒绝"

**可能原因**:
- Web服务器未启动
- 端口3000被其他程序占用
- 防火墙阻拦

**解决方案**:
```bash
# 1. 检查服务器是否启动
ps aux | grep "server.py"

# 2. 检查端口占用
netstat -tulpn | grep 3000
# 如果端口被占用，kill对应进程或更换端口

# 3. 重新启动服务器
python3 server.py

# 4. 使用其他端口
python3 server.py 8080
```

#### 问题2: Live2D模型不显示
**症状**: 网页加载但看不到Live2D模型

**可能原因**:
- Live2D资源文件缺失
- JavaScript加载错误
- 浏览器兼容性问题

**解决方案**:
```bash
# 1. 检查模型文件
ls -la Mould/Z.model3.json
ls -la libs/live2dcubismcore.min.js

# 2. 检查浏览器开发者工具
# F12 → Console 查看JavaScript错误

# 3. 尝试使用Chrome浏览器 (最佳兼容性)

# 4. 检查文件权限
chmod 644 Mould/*.json
chmod 644 libs/*.js
```

#### 问题3: 小智AI无回复
**症状**: 发送消息后没有AI回复

**可能原因**:
- 消息处理器未启动
- WebSocket连接失败
- xiaozhi_device.json配置错误
- 网络连接问题

**解决方案**:
```bash
# 1. 检查消息处理器进程
ps aux | grep "message_handler"

# 2. 检查xiaozhi_device.json文件
cat xiaozhi_device.json
# 确保所有参数正确，特别是device_id和hmac_key

# 3. 重启消息处理器
killall -f simple_message_handler.py
python3 simple_message_handler.py

# 4. 检查网络连接
ping api.tenclass.net

# 5. 查看详细错误日志
python3 simple_message_handler.py  # 观察输出的错误信息
```

#### 问题4: 语音识别不工作
**症状**: 点击麦克风按钮无反应或无法识别语音

**可能原因**:
- 浏览器不支持Web Speech API
- 麦克风权限未授予
- 网络问题影响语音服务

**解决方案**:
```bash
# 1. 使用Chrome浏览器 (最佳支持)

# 2. 检查浏览器麦克风权限
# Chrome: 设置 → 隐私和安全 → 网站设置 → 麦克风
# 确保localhost被允许使用麦克风

# 3. 检查系统麦克风权限 (macOS)
# 系统偏好设置 → 安全性与隐私 → 隐私 → 麦克风
# 确保Chrome被授权

# 4. 测试麦克风硬件
# 在其他应用中测试麦克风是否正常工作
```

#### 问题5: Live2D表情不同步
**症状**: AI有回复但Live2D模型表情不变化

**可能原因**:
- 情感映射模块异常
- 队列通信故障
- 轮询机制失效

**解决方案**:
```bash
# 1. 测试情感映射
python3 emotion_mapping.py

# 2. 检查队列状态
python3 shared_queues.py

# 3. 清空队列重试
python3 -c "from shared_queues import clear_all_queues; clear_all_queues()"

# 4. 使用测试页面
# 访问 http://127.0.0.1:3000/test_emotions.html
# 手动测试Live2D控制是否正常
```

#### 问题6: 内存使用过高
**症状**: 系统运行一段时间后内存占用很大

**可能原因**:
- 队列文件堆积
- 未清理的WebSocket连接
- 音频缓存堆积

**解决方案**:
```bash
# 1. 清空队列文件
rm -rf /tmp/xiaozhi_queues/*

# 2. 重启所有服务
killall -f simple_message_handler.py
killall -f server.py
python3 start_robust_system.py

# 3. 监控内存使用
# macOS: Activity Monitor
# Linux: htop 或 free -h
# Windows: Task Manager
```

### 日志分析

#### 消息处理器日志
```bash
# 正常连接日志:
# ✅ WebSocket连接成功
# 🔄 心跳包发送成功
# 📨 收到AI回复: [消息内容]

# 异常连接日志:
# ❌ WebSocket连接失败
# ⚠️ 连接断开，尝试重连...
# ❌ 认证失败，检查设备配置
```

#### Web服务器日志
```bash
# 正常API调用:
# [CHAT] 收到消息: user - 你好
# [POLL] 获取AI回复: 您好...
# [Live2D] 命令已加入队列: {"type": "live2d_control", ...}

# 异常API调用:
# [CHAT] 聊天API错误: [错误详情]
# [POLL] 轮询回复错误: [错误详情]
```

### 紧急恢复步骤

如果系统完全无法工作,按以下步骤恢复:

```bash
# 1. 停止所有相关进程
killall -f python3
killall -f simple_message_handler.py
killall -f server.py

# 2. 清空临时文件
rm -rf /tmp/xiaozhi_queues/
rm -rf /tmp/xiaozhi_activation_request

# 3. 检查项目完整性
cd /path/to/Zoe
ls -la server.py simple_message_handler.py xiaozhi_device.json

# 4. 重新安装依赖
pip3 install --upgrade websockets aiohttp requests

# 5. 从最小配置重启
python3 simple_message_handler.py &
sleep 3
python3 server.py

# 6. 验证基础功能
curl http://127.0.0.1:3000/api/system_status
```

---

## 📚 API接口文档

### HTTP API接口

所有API接口均支持CORS跨域访问，Base URL: `http://127.0.0.1:3000`

#### 1. 聊天消息接口

**POST** `/api/chat`

发送聊天消息给AI。

**请求体**:
```json
{
  "type": "user_message",
  "text": "你好世界",
  "sender": "user"
}
```

**响应**:
```json
{
  "status": "success",
  "message": "Message received and queued for processing",
  "timestamp": 1694123456.789
}
```

#### 2. AI回复轮询接口

**GET** `/api/poll_reply`

轮询获取AI回复消息。前端应该每1-2秒调用一次。

**响应 (有回复)**:
```json
{
  "status": "success",
  "has_reply": true,
  "replies": [
    {
      "text": "您好！我是小智，很高兴为您服务！",
      "timestamp": 1694123456.789,
      "emotion": "happy",
      "source": "xiaozhi_ai"
    }
  ],
  "count": 1,
  "timestamp": 1694123456.789
}
```

**响应 (无回复)**:
```json
{
  "status": "success",
  "has_reply": false,
  "timestamp": 1694123456.789
}
```

#### 3. Live2D控制接口

**POST** `/api/live2d`

控制Live2D模型动作和表情。

**请求体 (新格式)**:
```json
{
  "type": "action",        // "action" 或 "expression"
  "name": "kaixin",        // 动作/表情名称
  "source": "emotion_controller"
}
```

**请求体 (旧格式，兼容)**:
```json
{
  "action": "kaixin",
  "expression": "love_eyes"
}
```

**响应**:
```json
{
  "status": "success",
  "message": "Live2D命令执行: action.kaixin",
  "timestamp": 1694123456.789
}
```

#### 4. Live2D命令轮询接口

**GET** `/api/poll_live2d`

轮询获取Live2D控制命令。前端Live2D控制器应该持续调用。

**响应 (有命令)**:
```json
{
  "status": "success",
  "has_command": true,
  "command": {
    "type": "live2d_control",
    "action": "kaixin",
    "expression": "love_eyes",
    "timestamp": 1694123456.789,
    "source": "emotion_controller"
  },
  "timestamp": 1694123456.789
}
```

#### 5. 系统状态接口

**GET** `/api/system_status`

获取系统运行状态信息。

**响应**:
```json
{
  "status": "success",
  "system_status": {
    "websocket_connected": true,
    "last_heartbeat": 1694123456.789,
    "message_count": 42,
    "connection_status": "connected",
    "device_activated": true
  },
  "timestamp": 1694123456.789
}
```

#### 6. 激活重连接口

**POST** `/api/activate`

触发小智AI连接重新激活。

**响应**:
```json
{
  "status": "success",
  "message": "激活请求已发送",
  "timestamp": 1694123456.789
}
```

#### 7. JavaScript执行接口

**POST** `/execute-js`

执行前端JavaScript代码（主要用于调试）。

**请求体**:
```json
{
  "code": "console.log('Hello World');"
}
```

**响应**:
```json
{
  "status": "success",
  "message": "JavaScript executed",
  "timestamp": 1694123456.789
}
```

### JavaScript前端API

#### Live2D控制函数

```javascript
// 播放动作
function playAction(actionName) {
    // actionName: "idle", "kaixin", "jingya", "shengqi", "wink", "yaotou"
}

// 设置表情
function setExpression(expressionName) {
    // expressionName: "love_eyes", "angry", "star_eyes", "crying", "tongue"
}

// 综合控制
function applyEmotionMapping(emotion) {
    // emotion: "happy", "sad", "angry", "surprised", etc.
}
```

#### 聊天功能函数

```javascript
// 发送消息
function sendMessage(text) {
    // 发送文本消息给AI
}

// 开始语音识别
function startVoiceRecognition() {
    // 开始Web Speech API语音识别
}

// 停止语音识别
function stopVoiceRecognition() {
    // 停止语音识别
}
```

#### 轮询控制函数

```javascript
// 启动回复轮询
function startReplyPolling() {
    // 开始轮询AI回复，间隔1000ms
}

// 启动Live2D轮询
function startLive2DPolling() {
    // 开始轮询Live2D命令，间隔500ms
}
```

### 错误代码说明

| HTTP状态码 | 错误类型 | 说明 |
|-----------|---------|------|
| 200 | 成功 | 请求处理成功 |
| 404 | 接口不存在 | API endpoint not found |
| 500 | 服务器内部错误 | 详细错误信息在响应体中 |

---

## 🔧 维护指南

### 日常维护任务

#### 1. 系统监控

**检查系统状态** (每天):
```bash
# 检查服务进程状态
ps aux | grep -E "(server\.py|message_handler\.py)"

# 检查端口监听状态
netstat -tulpn | grep 3000

# 检查系统状态API
curl -s http://127.0.0.1:3000/api/system_status | python3 -m json.tool
```

**监控系统资源** (每周):
```bash
# 检查内存使用
free -h  # Linux
vm_stat # macOS

# 检查磁盘使用
df -h

# 检查队列文件大小
du -sh /tmp/xiaozhi_queues/
```

#### 2. 日志管理

**日志轮转设置**:
```bash
# 创建日志目录
mkdir -p logs

# 重定向日志输出
python3 server.py > logs/server.log 2>&1 &
python3 simple_message_handler.py > logs/message_handler.log 2>&1 &

# 设置日志轮转 (Linux)
# 编辑 /etc/logrotate.d/xiaozhi
/path/to/Zoe/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    copytruncate
}
```

#### 3. 队列清理

**自动清理脚本** (`cleanup.py`):
```python
#!/usr/bin/env python3
import os
import time
from shared_queues import clear_all_queues, get_queue_status

def cleanup_queues():
    """清理过期队列数据"""
    status = get_queue_status()
    total_size = sum(status.values())

    if total_size > 100:  # 队列项目超过100个时清理
        print(f"🧹 队列大小: {total_size}, 开始清理...")
        clear_all_queues()
        print("✅ 队列清理完成")

    # 清理临时文件
    temp_files = [
        "/tmp/xiaozhi_activation_request",
    ]

    for file_path in temp_files:
        if os.path.exists(file_path):
            os.remove(file_path)
            print(f"🗑️ 清理临时文件: {file_path}")

if __name__ == "__main__":
    cleanup_queues()
```

**定期执行清理** (crontab):
```bash
# 编辑定时任务
crontab -e

# 添加每小时清理任务
0 * * * * cd /path/to/Zoe && python3 cleanup.py
```

### 性能优化

#### 1. 内存优化

**队列大小限制**:
```python
# 在shared_queues.py中添加队列大小限制
MAX_QUEUE_SIZE = 50

def put_with_limit(queue, item):
    if queue.qsize() > MAX_QUEUE_SIZE:
        # 移除最旧的项目
        try:
            queue.get_nowait()
        except:
            pass
    queue.put(item)
```

**连接池配置**:
```python
# 在message_handler中限制连接数
import aiohttp
connector = aiohttp.TCPConnector(
    limit=100,           # 总连接数限制
    limit_per_host=30,   # 单域名连接数限制
    ttl_dns_cache=300,   # DNS缓存时间
    use_dns_cache=True,  # 启用DNS缓存
)
```

#### 2. 网络优化

**WebSocket心跳优化**:
```python
# 调整心跳间隔
HEARTBEAT_INTERVAL = 30  # 30秒心跳，减少网络开销

# 启用WebSocket压缩
websocket = await websockets.connect(
    url,
    compression="deflate",  # 启用压缩
    max_size=1024*1024     # 1MB消息大小限制
)
```

**HTTP请求缓存**:
```javascript
// 在前端添加请求缓存
const cache = new Map();

function cachedFetch(url, options = {}) {
    const key = url + JSON.stringify(options);
    const cached = cache.get(key);

    if (cached && Date.now() - cached.timestamp < 5000) { // 5秒缓存
        return Promise.resolve(cached.response);
    }

    return fetch(url, options).then(response => {
        cache.set(key, {
            response: response.clone(),
            timestamp: Date.now()
        });
        return response;
    });
}
```

### 安全加固

#### 1. 网络安全

**HTTP安全头**:
```python
# 在server.py中添加安全头
def end_headers(self):
    self.send_header('X-Content-Type-Options', 'nosniff')
    self.send_header('X-Frame-Options', 'DENY')
    self.send_header('X-XSS-Protection', '1; mode=block')
    self.send_header('Referrer-Policy', 'strict-origin-when-cross-origin')
    super().end_headers()
```

**请求限制**:
```python
# 添加请求频率限制
import time
from collections import defaultdict

request_counts = defaultdict(list)
RATE_LIMIT = 100  # 每分钟100请求

def check_rate_limit(client_ip):
    now = time.time()
    minute_ago = now - 60

    # 清理过期记录
    request_counts[client_ip] = [
        req_time for req_time in request_counts[client_ip]
        if req_time > minute_ago
    ]

    # 检查频率限制
    if len(request_counts[client_ip]) >= RATE_LIMIT:
        return False

    request_counts[client_ip].append(now)
    return True
```

#### 2. 配置安全

**敏感信息保护**:
```bash
# 设置配置文件权限
chmod 600 xiaozhi_device.json

# 使用环境变量存储敏感信息
export XIAOZHI_HMAC_KEY="your_hmac_key_here"
export XIAOZHI_CLIENT_ID="your_client_id_here"
```

**防止配置泄漏**:
```python
# 在代码中避免打印敏感信息
import json
import re

def safe_print_config(config):
    """安全打印配置，隐藏敏感信息"""
    safe_config = config.copy()

    # 隐藏敏感字段
    sensitive_fields = ['hmac_key', 'client_id', 'websocket_token']
    for field in sensitive_fields:
        if field in safe_config:
            safe_config[field] = safe_config[field][:8] + "***"

    print("🔧 配置信息:", json.dumps(safe_config, indent=2))
```

### 升级指南

#### 1. 备份数据

**创建备份脚本** (`backup.sh`):
```bash
#!/bin/bash
BACKUP_DIR="/path/to/backups"
PROJECT_DIR="/path/to/Zoe"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 备份项目文件
tar -czf "$BACKUP_DIR/zoe_backup_$DATE.tar.gz" \
    -C "$(dirname $PROJECT_DIR)" "$(basename $PROJECT_DIR)" \
    --exclude="__pycache__" \
    --exclude=".git" \
    --exclude="logs" \
    --exclude="/tmp/xiaozhi_queues"

echo "✅ 备份完成: zoe_backup_$DATE.tar.gz"
```

#### 2. 更新流程

**安全更新步骤**:
```bash
# 1. 备份当前系统
./backup.sh

# 2. 停止服务
killall -f simple_message_handler.py
killall -f server.py

# 3. 更新代码
git pull origin main
# 或者手动替换文件

# 4. 检查配置兼容性
python3 -c "import json; json.load(open('xiaozhi_device.json'))"

# 5. 测试新版本
python3 simple_message_handler.py &
sleep 3
python3 server.py &

# 6. 验证功能
curl http://127.0.0.1:3000/api/system_status

# 7. 如果有问题，回滚
# tar -xzf /path/to/backups/zoe_backup_XXXXXX.tar.gz
```

---

## 📞 技术支持

### 获取帮助

如果在部署过程中遇到问题，可以通过以下方式获取支持:

1. **查看日志文件**: 首先检查系统日志，大多数问题都会有相应的错误信息
2. **使用测试页面**: 访问 `test_emotions.html` 进行功能测试
3. **检查网络连接**: 确认到 `api.tenclass.net` 的网络连通性
4. **重启服务**: 按照故障排除部分的步骤重启相关服务

### 系统信息收集

在报告问题时，请提供以下信息:

```bash
# 系统信息
uname -a                    # 操作系统信息
python3 --version           # Python版本
pip3 list | grep -E "(websockets|aiohttp|requests)"  # 关键依赖版本

# 服务状态
ps aux | grep -E "(server\.py|message_handler\.py)"  # 进程状态
netstat -tulpn | grep 3000  # 端口状态
curl -s http://127.0.0.1:3000/api/system_status     # 系统状态

# 错误日志 (最近50行)
tail -50 logs/server.log
tail -50 logs/message_handler.log
```

---

## 📄 总结

本文档提供了Live2D小智AI系统的完整部署指南，包含:

✅ **完整的系统要求和环境准备说明**
✅ **详细的安装部署步骤**
✅ **全面的配置参数说明**
✅ **多种启动方式和运行指导**
✅ **完整的功能验证流程**
✅ **详尽的故障排除指南**
✅ **完整的API接口文档**
✅ **系统维护和优化指导**

按照本文档的步骤操作，您应该能够成功部署并运行Live2D小智AI系统。如果在部署过程中遇到任何问题，请参考故障排除部分或按照技术支持部分的指导收集相关信息。

> **重要提醒**: 请定期备份配置文件和重要数据，特别是 `xiaozhi_device.json` 文件，以防丢失影响系统正常运行。

---

*文档版本: v1.0*
*最后更新: 2024年9月*
*适用系统: Live2D小智AI系统 v1.0*