<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D Zoe - PyQt Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        #live2d-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
            z-index: 10;
        }

        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            font-size: 14px;
            text-align: center;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">æ­£åœ¨åŠ è½½Live2Dæ¨¡å‹...</div>
    <div id="error" class="error" style="display: none;">Live2Dæ¨¡å‹åŠ è½½å¤±è´¥</div>
    <canvas id="live2d-canvas"></canvas>

    <script>
        class Live2DController {
            constructor() {
                this.app = null;
                this.model = null;
                this.isLoaded = false;
                this.loadingElement = document.getElementById('loading');
                this.errorElement = document.getElementById('error');
            }

            async init() {
                try {
                    console.log('å¼€å§‹åˆå§‹åŒ–Live2D...');
                    await this.loadScripts();
                    await this.initPixiApp();
                    await this.loadModel();
                    this.hideLoading();
                    this.isLoaded = true;
                    console.log('âœ“ Live2Dåˆå§‹åŒ–å®Œæˆ');

                    // å¯åŠ¨æƒ…æ„Ÿç›‘å¬
                    this.listenForEmotions();

                    // æš´éœ²æ§åˆ¶å™¨åˆ°å…¨å±€ï¼Œä¾›PyQtè°ƒç”¨
                    window.live2dController = this;
                } catch (error) {
                    console.error('Live2Dåˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError();
                }
            }

            async loadScripts() {
                console.log('å¼€å§‹åŠ è½½Live2Dè„šæœ¬...');
                const scripts = [
                    'https://unpkg.com/pixi.js@7.3.2/dist/pixi.min.js',
                    'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js'
                ];

                for (const src of scripts) {
                    await this.loadScript(src);
                }

                // è®¾ç½®PIXIå…¨å±€å˜é‡
                window.PIXI = PIXI;

                // åŠ è½½Live2Dæ˜¾ç¤ºåº“
                await this.loadScript('https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.min.js');
                console.log('âœ“ æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ');
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    console.log(`æ­£åœ¨åŠ è½½è„šæœ¬: ${src}`);
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        console.log(`âœ“ è„šæœ¬åŠ è½½æˆåŠŸ: ${src}`);
                        resolve();
                    };
                    script.onerror = () => {
                        console.error(`âœ— è„šæœ¬åŠ è½½å¤±è´¥: ${src}`);
                        reject(new Error(`è„šæœ¬åŠ è½½å¤±è´¥: ${src}`));
                    };
                    document.head.appendChild(script);
                });
            }

            async initPixiApp() {
                // åˆå§‹åŒ–PIXIåº”ç”¨ - å‚è€ƒZoev2çš„é…ç½®
                this.app = new PIXI.Application({
                    view: document.getElementById('live2d-canvas'),
                    width: window.innerWidth,
                    height: window.innerHeight,
                    backgroundColor: 0x000000,
                    backgroundAlpha: 0,
                    antialias: true,
                    preserveDrawingBuffer: false,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true
                });

                console.log('âœ“ PIXIåº”ç”¨åˆå§‹åŒ–å®Œæˆ');

                // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                window.addEventListener('resize', () => {
                    this.app.renderer.resize(window.innerWidth, window.innerHeight);
                    if (this.model) {
                        this.positionModel();
                    }
                });
            }

            async loadModel() {
                try {
                    console.log('æ­£åœ¨åŠ è½½Live2Dæ¨¡å‹...');

                    // ä½¿ç”¨ä¸Zoev2ç›¸åŒçš„APIè°ƒç”¨æ–¹å¼
                    this.model = await PIXI.live2d.Live2DModel.from('models/Mould/Z.model3.json');
                    this.app.stage.addChild(this.model);

                    console.log('âœ“ æ¨¡å‹æ·»åŠ åˆ°èˆå°');

                    // è®¾ç½®æ¨¡å‹ä½ç½®å’Œå¤§å°
                    this.positionModel();

                    // å¯åŠ¨é»˜è®¤åŠ¨ä½œ
                    await this.model.motion('Idle');

                    console.log('âœ“ Live2Dæ¨¡å‹åŠ è½½å®Œæˆ');
                } catch (error) {
                    console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', {
                        message: error.message,
                        stack: error.stack,
                        pixiLive2dAvailable: typeof PIXI !== 'undefined' ? typeof PIXI.live2d : 'undefined',
                        modelPath: 'models/Mould/Z.model3.json'
                    });
                    throw error;
                }
            }

            positionModel() {
                if (!this.model) return;

                // ç­‰å¾…æ¨¡å‹å®Œå…¨åŠ è½½å¹¶è·å–æ­£ç¡®å°ºå¯¸ï¼Œæœ€å¤šé‡è¯•5æ¬¡
                if (!this.positionRetryCount) this.positionRetryCount = 0;

                if ((!this.model.width || !this.model.height || this.model.width < 10 || this.model.height < 10) && this.positionRetryCount < 5) {
                    console.log(`ğŸ”„ æ¨¡å‹å°ºå¯¸æœªå‡†å¤‡å¥½ï¼Œå»¶è¿Ÿå®šä½... (ç¬¬${this.positionRetryCount + 1}æ¬¡)`);
                    this.positionRetryCount++;
                    setTimeout(() => this.positionModel(), 200);
                    return;
                }

                // å¦‚æœé‡è¯•5æ¬¡åä»ç„¶æ— æ³•è·å–å°ºå¯¸ï¼Œä½¿ç”¨é»˜è®¤ç¼©æ”¾
                if (!this.model.width || !this.model.height || this.model.width < 10 || this.model.height < 10) {
                    console.log('âš ï¸ æ— æ³•è·å–æ¨¡å‹å°ºå¯¸ï¼Œä½¿ç”¨é»˜è®¤ç¼©æ”¾ 0.5');
                    this.model.scale.set(0.5);
                    this.model.x = window.innerWidth / 2;
                    this.model.y = window.innerHeight / 2;
                    this.positionRetryCount = 0;
                    return;
                }

                // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆå¢åŠ Live2Dæ˜¾ç¤ºåŒºåŸŸåè°ƒæ•´æ¯”ä¾‹ï¼‰
                const scale = Math.min(
                    window.innerWidth / this.model.width,
                    window.innerHeight / this.model.height
                ) * 0.9;

                // é˜²æ­¢å¼‚å¸¸ç¼©æ”¾
                const finalScale = Math.max(0.1, Math.min(2.0, scale));
                console.log(`ğŸ“ æ¨¡å‹å®šä½: çª—å£${window.innerWidth}x${window.innerHeight}, æ¨¡å‹${this.model.width}x${this.model.height}, ç¼©æ”¾${finalScale}`);

                // åº”ç”¨ç¼©æ”¾
                this.model.scale.set(finalScale);

                // å±…ä¸­æ˜¾ç¤º - ç¡®ä¿æ¨¡å‹åœ¨ç”»é¢ä¸­å¿ƒ
                this.model.x = window.innerWidth / 2;
                this.model.y = window.innerHeight / 2;

                // è®¾ç½®é”šç‚¹ä¸ºä¸­å¿ƒ
                this.model.anchor.set(0.5, 0.5);

                this.positionRetryCount = 0;
                console.log(`âœ… æ¨¡å‹å®šä½å®Œæˆ: ä½ç½®(${this.model.x}, ${this.model.y}), ç¼©æ”¾${finalScale}`);
            }

            hideLoading() {
                if (this.loadingElement) {
                    this.loadingElement.style.display = 'none';
                }
            }

            showError() {
                if (this.loadingElement) {
                    this.loadingElement.style.display = 'none';
                }
                if (this.errorElement) {
                    this.errorElement.style.display = 'block';
                }
            }

            // è¡¨æƒ…åˆ‡æ¢æ–¹æ³• - åŸºäºZoev2çš„å®Œæ•´æ˜ å°„ç³»ç»Ÿ
            async changeExpression(emotionName) {
                if (!this.model || !this.isLoaded) {
                    console.warn('æ¨¡å‹æœªåŠ è½½å®Œæˆï¼Œæ— æ³•åˆ‡æ¢è¡¨æƒ…');
                    return;
                }

                console.log('ğŸ­ åˆ‡æ¢è¡¨æƒ…:', emotionName);

                // å®Œæ•´çš„21ä¸ªemojiåˆ°Live2DåŠ¨ä½œ/è¡¨æƒ…æ˜ å°„ï¼ˆæ­£ç¡®çš„ç´¢å¼•è°ƒç”¨æ–¹å¼ï¼‰
                const emotionMapping = {
                    // === å°æ™ºAIæ ‡å‡†21ä¸ªemojiæ˜ å°„åˆ°6ä¸ªåŠ¨ä½œ+7ä¸ªè¡¨æƒ… ===

                    // åŠ¨ä½œç´¢å¼•0: Idle (å¾…æœº) - 5ä¸ªemoji
                    "neutral": { motionIndex: 0, expression: null }, // ğŸ˜¶ ä¸­æ€§
                    "thinking": { motionIndex: 0, expression: null }, // ğŸ¤” æ€è€ƒ
                    "relaxed": { motionIndex: 0, expression: null }, // ğŸ˜Œ æ”¾æ¾
                    "sleepy": { motionIndex: 0, expression: null }, // ğŸ˜´ å›°å€¦
                    "embarrassed": { motionIndex: 0, expression: "A4å“­å“­" }, // ğŸ˜³ å°´å°¬

                    // åŠ¨ä½œç´¢å¼•1: jingya (æƒŠè®¶) - 3ä¸ªemoji
                    "surprised": { motionIndex: 1, expression: "A3æ˜Ÿæ˜Ÿçœ¼" }, // ğŸ˜² æƒŠè®¶
                    "shocked": { motionIndex: 1, expression: "A3æ˜Ÿæ˜Ÿçœ¼" }, // ğŸ˜± éœ‡æƒŠ
                    "cool": { motionIndex: 1, expression: "A3æ˜Ÿæ˜Ÿçœ¼" }, // ğŸ˜ é…·ç‚«

                    // åŠ¨ä½œç´¢å¼•2: kaixin (å¼€å¿ƒ) - 7ä¸ªemoji
                    "happy": { motionIndex: 2, expression: "A1çˆ±å¿ƒçœ¼" }, // ğŸ™‚ å¼€å¿ƒ
                    "laughing": { motionIndex: 2, expression: "A3æ˜Ÿæ˜Ÿçœ¼" }, // ğŸ˜† å¤§ç¬‘
                    "funny": { motionIndex: 2, expression: "èˆŒå¤´" }, // ğŸ˜‚ æç¬‘
                    "loving": { motionIndex: 2, expression: "A1çˆ±å¿ƒçœ¼" }, // ğŸ˜ å–œçˆ±
                    "delicious": { motionIndex: 2, expression: "èˆŒå¤´" }, // ğŸ¤¤ ç¾å‘³
                    "confident": { motionIndex: 2, expression: "A3æ˜Ÿæ˜Ÿçœ¼" }, // ğŸ˜ è‡ªä¿¡
                    "kissy": { motionIndex: 2, expression: "A1çˆ±å¿ƒçœ¼" }, // ğŸ˜˜ é£å»

                    // åŠ¨ä½œç´¢å¼•3: shengqi (ç”Ÿæ°”) - 1ä¸ªemoji
                    "angry": { motionIndex: 3, expression: "A2ç”Ÿæ°”" }, // ğŸ˜  ç”Ÿæ°”

                    // åŠ¨ä½œç´¢å¼•4: wink (çœ¨çœ¼) - 2ä¸ªemoji
                    "winking": { motionIndex: 4, expression: null }, // ğŸ˜‰ çœ¨çœ¼
                    "silly": { motionIndex: 4, expression: "èˆŒå¤´" }, // ğŸ˜œ è°ƒçš®

                    // åŠ¨ä½œç´¢å¼•5: yaotou (æ‘‡å¤´) - 3ä¸ªemoji
                    "sad": { motionIndex: 5, expression: "A4å“­å“­" }, // ğŸ˜” æ‚²ä¼¤
                    "crying": { motionIndex: 5, expression: "A4å“­å“­" }, // ğŸ˜­ å“­æ³£
                    "confused": { motionIndex: 5, expression: null }, // ğŸ™„ å›°æƒ‘

                    // ç‰¹æ®ŠåŠŸèƒ½è¡¨æƒ…
                    "speaking": { motionIndex: 0, expression: "B1éº¦å…‹é£" } // è¯´è¯æ—¶ä½¿ç”¨éº¦å…‹é£è¡¨æƒ…
                };

                // è·å–æ˜ å°„é…ç½®ï¼Œé»˜è®¤ä¸ºIdleå¾…æœº
                const config = emotionMapping[emotionName] || { motionIndex: 0, expression: null };

                try {
                    // æ’­æ”¾åŠ¨ä½œï¼ˆä½¿ç”¨æ­£ç¡®çš„ç´¢å¼•æ–¹å¼ï¼‰
                    console.log(`ğŸ¬ æ’­æ”¾åŠ¨ä½œç´¢å¼•: ${config.motionIndex}`);
                    await this.model.motion("", config.motionIndex);

                    // å¦‚æœæœ‰è¡¨æƒ…ï¼Œæ’­æ”¾è¡¨æƒ…
                    if (config.expression) {
                        console.log(`ğŸ˜Š æ’­æ”¾è¡¨æƒ…: ${config.expression}`);
                        try {
                            await this.model.expression(config.expression);
                            console.log(`âœ… è¡¨æƒ… ${config.expression} æ’­æ”¾æˆåŠŸ`);
                        } catch (expError) {
                            console.error(`âš ï¸ è¡¨æƒ… ${config.expression} æ’­æ”¾å¤±è´¥:`, expError);
                        }
                    }

                    console.log(`âœ… è¡¨æƒ…ç»„åˆ ${emotionName} æ’­æ”¾å®Œæˆï¼ˆåŠ¨ä½œç´¢å¼•${config.motionIndex}ï¼‰`);
                } catch (error) {
                    console.error(`âŒ è¡¨æƒ… ${emotionName} æ’­æ”¾å¤±è´¥:`, error);
                }
            }

            // æ ¹æ®emojiæ’­æ”¾å¯¹åº”è¡¨æƒ…
            playEmotionByEmoji(emoji) {
                const emojiMapping = {
                    "ğŸ˜¶": "neutral",
                    "ğŸ™‚": "happy",
                    "ğŸ˜†": "laughing",
                    "ğŸ˜‚": "funny",
                    "ğŸ˜”": "sad",
                    "ğŸ˜ ": "angry",
                    "ğŸ˜­": "crying",
                    "ğŸ˜": "loving",
                    "ğŸ˜³": "embarrassed",
                    "ğŸ˜²": "surprised",
                    "ğŸ˜±": "shocked",
                    "ğŸ¤”": "thinking",
                    "ğŸ˜‰": "winking",
                    "ğŸ˜": "cool",
                    "ğŸ˜Œ": "relaxed",
                    "ğŸ¤¤": "delicious",
                    "ğŸ˜˜": "kissy",
                    "ğŸ˜": "confident",
                    "ğŸ˜´": "sleepy",
                    "ğŸ˜œ": "silly",
                    "ğŸ™„": "confused"
                };

                const emotionName = emojiMapping[emoji];
                if (emotionName) {
                    console.log(`ğŸ¯ Emoji ${emoji} â†’ ${emotionName}`);
                    this.changeExpression(emotionName);
                } else {
                    console.warn(`âš ï¸ æœªçŸ¥emoji: ${emoji}`);
                }
            }

            // ç›‘å¬å°æ™ºAIçš„æƒ…æ„Ÿæ•°æ®
            listenForEmotions() {
                console.log('ğŸ§ å¼€å§‹ç›‘å¬å°æ™ºAIæƒ…æ„Ÿæ•°æ®...');

                // ç›‘å¬æ¥è‡ªPyQtçš„æƒ…æ„Ÿæ¶ˆæ¯
                window.addEventListener('message', (event) => {
                    if (event.data && event.data.type === 'emotion') {
                        console.log('ğŸ“¨ æ”¶åˆ°æƒ…æ„Ÿæ•°æ®:', event.data);

                        if (event.data.emoji) {
                            this.playEmotionByEmoji(event.data.emoji);
                        } else if (event.data.emotion) {
                            this.changeExpression(event.data.emotion);
                        }
                    }
                });

                // ä¹Ÿå¯ä»¥é€šè¿‡å…¨å±€å‡½æ•°è¢«PyQtè°ƒç”¨
                window.playEmotion = (emotion) => {
                    console.log('ğŸª å¤–éƒ¨è°ƒç”¨æ’­æ”¾è¡¨æƒ…:', emotion);
                    this.changeExpression(emotion);
                };

                window.playEmoji = (emoji) => {
                    console.log('ğŸª å¤–éƒ¨è°ƒç”¨æ’­æ”¾emoji:', emoji);
                    this.playEmotionByEmoji(emoji);
                };
            }

            // å˜´éƒ¨åŠ¨ä½œæ§åˆ¶
            startSpeaking() {
                if (!this.model || !this.isLoaded) {
                    console.warn('æ¨¡å‹æœªåŠ è½½å®Œæˆï¼Œæ— æ³•å¯åŠ¨å˜´éƒ¨åŠ¨ä½œ');
                    return;
                }

                console.log('ğŸ—£ï¸ å¼€å§‹å˜´éƒ¨è¯´è¯åŠ¨ä½œ');

                // åœæ­¢ä¹‹å‰çš„å˜´éƒ¨åŠ¨ä½œ
                this.stopSpeaking();

                // åˆ›å»ºå˜´éƒ¨åŠ¨ä½œå¾ªç¯
                this.speakingInterval = setInterval(() => {
                    try {
                        // éšæœºå˜´éƒ¨å¼ å¼€ç¨‹åº¦ï¼Œæ¨¡æ‹Ÿè¯´è¯
                        const mouthOpen = 0.3 + Math.random() * 0.4; // 0.3-0.7ä¹‹é—´
                        const mouthForm = (Math.random() - 0.5) * 0.6; // -0.3åˆ°0.3ä¹‹é—´

                        // ä½¿ç”¨Live2D APIè®¾ç½®å˜´éƒ¨å‚æ•°
                        // æ£€æŸ¥æ¨¡å‹æ˜¯å¦æœ‰å‚æ•°è®¾ç½®æ–¹æ³•
                        if (this.model.internalModel && this.model.internalModel.coreModel) {
                            const model = this.model.internalModel.coreModel;
                            // ä½¿ç”¨Live2D Coreçš„å‚æ•°è®¾ç½®æ–¹æ³•
                            const mouthOpenIndex = model.getParameterIndex('ParamMouthOpenY');
                            const mouthFormIndex = model.getParameterIndex('ParamMouthForm');

                            if (mouthOpenIndex >= 0) {
                                model.setParameterValueByIndex(mouthOpenIndex, mouthOpen);
                            }
                            if (mouthFormIndex >= 0) {
                                model.setParameterValueByIndex(mouthFormIndex, mouthForm);
                            }
                        } else {
                            console.warn('æ— æ³•è®¿é—®Live2Dæ ¸å¿ƒæ¨¡å‹å‚æ•°');
                        }

                    } catch (error) {
                        console.error('è®¾ç½®å˜´éƒ¨å‚æ•°å¤±è´¥:', error);
                    }
                }, 100); // æ¯100msæ›´æ–°ä¸€æ¬¡å˜´éƒ¨çŠ¶æ€

                console.log('âœ… å˜´éƒ¨è¯´è¯åŠ¨ä½œå·²å¯åŠ¨');
            }

            stopSpeaking() {
                if (this.speakingInterval) {
                    clearInterval(this.speakingInterval);
                    this.speakingInterval = null;
                    console.log('ğŸ¤ åœæ­¢å˜´éƒ¨è¯´è¯åŠ¨ä½œ');
                }

                // æ¢å¤å˜´éƒ¨åˆ°é»˜è®¤çŠ¶æ€
                if (this.model && this.isLoaded) {
                    try {
                        // æ£€æŸ¥æ¨¡å‹æ˜¯å¦æœ‰å‚æ•°è®¾ç½®æ–¹æ³•
                        if (this.model.internalModel && this.model.internalModel.coreModel) {
                            const model = this.model.internalModel.coreModel;
                            // ä½¿ç”¨Live2D Coreçš„å‚æ•°è®¾ç½®æ–¹æ³•
                            const mouthOpenIndex = model.getParameterIndex('ParamMouthOpenY');
                            const mouthFormIndex = model.getParameterIndex('ParamMouthForm');

                            if (mouthOpenIndex >= 0) {
                                model.setParameterValueByIndex(mouthOpenIndex, 0);
                            }
                            if (mouthFormIndex >= 0) {
                                model.setParameterValueByIndex(mouthFormIndex, 0);
                            }
                            console.log('âœ… å˜´éƒ¨å·²æ¢å¤é»˜è®¤çŠ¶æ€');
                        } else {
                            console.warn('æ— æ³•è®¿é—®Live2Dæ ¸å¿ƒæ¨¡å‹å‚æ•°è¿›è¡Œé‡ç½®');
                        }
                    } catch (error) {
                        console.error('æ¢å¤å˜´éƒ¨é»˜è®¤çŠ¶æ€å¤±è´¥:', error);
                    }
                }
            }

            // æ£€æŸ¥æ¨¡å‹æ˜¯å¦åŠ è½½å®Œæˆ
            isModelLoaded() {
                return this.isLoaded;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆ›å»ºLive2Dæ§åˆ¶å™¨...');
            try {
                const controller = new Live2DController();
                console.log('âœ“ Live2Dæ§åˆ¶å™¨åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹åˆå§‹åŒ–...');
                controller.init().then(() => {
                    console.log('ğŸ‰ Live2Då®Œå…¨åˆå§‹åŒ–æˆåŠŸ');
                }).catch((error) => {
                    console.error('âŒ Live2Dåˆå§‹åŒ–Promiseå¤±è´¥:', error);
                });
            } catch (error) {
                console.error('âŒ Live2Dæ§åˆ¶å™¨åˆ›å»ºå¤±è´¥:', error);
            }
        });
    </script>
</body>
</html>