# Live2D小智AI系统云部署指南

## 🌐 云部署概述

本指南将帮助你将Live2D小智AI系统部署到云服务器，实现稳定的生产环境运行。

## 📋 目录
1. [云服务器选择](#云服务器选择)
2. [服务器配置要求](#服务器配置要求)
3. [部署架构设计](#部署架构设计)
4. [环境准备](#环境准备)
5. [部署步骤](#部署步骤)
6. [Nginx配置](#nginx配置)
7. [系统服务配置](#系统服务配置)
8. [SSL证书配置](#ssl证书配置)
9. [监控与日志](#监控与日志)
10. [安全配置](#安全配置)
11. [性能优化](#性能优化)
12. [备份策略](#备份策略)

---

## 🌐 云服务器选择

### 推荐云服务商

**国内部署 (推荐)**:
| 服务商 | 优势 | 适用场景 | 参考价格 |
|--------|------|----------|----------|
| 阿里云ECS | 网络稳定，CDN覆盖好 | 国内用户访问 | ¥200-600/月 |
| 腾讯云CVM | 性价比高，集成度好 | 中小型项目 | ¥180-500/月 |
| 华为云ECS | 企业级稳定性 | 企业用户 | ¥220-650/月 |

**海外部署**:
| 服务商 | 优势 | 适用场景 | 参考价格 |
|--------|------|----------|----------|
| AWS EC2 | 全球覆盖，服务丰富 | 国际化项目 | $20-80/月 |
| DigitalOcean | 简单易用，价格透明 | 个人开发者 | $10-40/月 |

### 地域选择建议

**国内用户**:
- 首选：华东1(杭州)、华北2(北京)、华南1(深圳)
- 原因：距离小智AI服务器近，延迟低

**海外用户**:
- 亚太：新加坡、东京
- 欧美：弗吉尼亚、法兰克福

---

## 💻 服务器配置要求

### 基础配置 (适合个人/测试)
```yaml
规格配置:
  CPU: 2核心
  内存: 4GB
  存储: 40GB SSD
  带宽: 3Mbps

操作系统: Ubuntu 20.04 LTS
预计费用: ¥200-300/月
并发用户: 10-50人
```

### 生产配置 (推荐)
```yaml
规格配置:
  CPU: 4核心
  内存: 8GB
  存储: 80GB SSD
  带宽: 5-10Mbps

操作系统: Ubuntu 20.04 LTS
预计费用: ¥400-600/月
并发用户: 100-500人
```

### 高性能配置 (大型项目)
```yaml
规格配置:
  CPU: 8核心
  内存: 16GB
  存储: 200GB SSD
  带宽: 10-20Mbps

操作系统: Ubuntu 20.04 LTS
预计费用: ¥800-1200/月
并发用户: 500-2000人
```

---

## 🏗️ 部署架构设计

### 推荐架构图

```
[用户浏览器]
     │ HTTPS/WSS
     ▼
[CDN/负载均衡器] (可选)
     │
     ▼
[Nginx 反向代理] :80/443
     │ HTTP
     ▼
[Gunicorn WSGI服务器] :3000
     │ 本地通信
     ▼
[Flask应用 (server.py)]
     │ 队列通信
     ▼
[消息处理器 (message_handler.py)]
     │ WebSocket
     ▼
[小智AI服务 (api.tenclass.net)]
```

### 端口规划

| 服务 | 端口 | 说明 |
|------|------|------|
| Nginx | 80, 443 | HTTP/HTTPS入口 |
| Flask App | 3000 | 应用服务端口 |
| SSH | 22 | 服务器管理 |
| 防火墙 | - | 仅开放必要端口 |

---

## 🛠️ 环境准备

### 1. 服务器初始化

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git vim htop net-tools

# 安装Python环境
sudo apt install -y python3 python3-pip python3-venv

# 安装系统服务
sudo apt install -y nginx supervisor ufw fail2ban

# 创建应用用户
sudo useradd -m -s /bin/bash xiaozhi
sudo usermod -aG sudo xiaozhi
```

### 2. 防火墙配置

```bash
# 配置防火墙
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw --force enable

# 检查防火墙状态
sudo ufw status
```

### 3. Python环境配置

```bash
# 切换到应用用户
sudo su - xiaozhi

# 创建虚拟环境
python3 -m venv ~/xiaozhi-env
source ~/xiaozhi-env/bin/activate

# 安装Python依赖
pip install --upgrade pip
pip install websockets aiohttp requests gunicorn
```

---

## 🚀 部署步骤

### 1. 上传项目文件

```bash
# 在本地打包项目 (排除不必要文件)
tar --exclude='__pycache__' \
    --exclude='.git' \
    --exclude='logs' \
    --exclude='/tmp/xiaozhi_queues' \
    -czf xiaozhi-project.tar.gz -C /Users/good/Desktop Zoe

# 上传到服务器
scp xiaozhi-project.tar.gz xiaozhi@your-server-ip:~/

# 在服务器上解压
ssh xiaozhi@your-server-ip
cd ~/
tar -xzf xiaozhi-project.tar.gz
mv Zoe xiaozhi-app
cd xiaozhi-app
```

### 2. 配置项目环境

```bash
# 激活虚拟环境
source ~/xiaozhi-env/bin/activate

# 安装项目依赖
pip install -r requirements.txt  # 如果有的话

# 创建必要目录
mkdir -p ~/xiaozhi-app/logs
mkdir -p /tmp/xiaozhi-queues

# 设置文件权限
chmod +x ~/xiaozhi-app/server.py
chmod +x ~/xiaozhi-app/simple_message_handler.py
chmod 600 ~/xiaozhi-app/xiaozhi_device.json
```

### 3. 修改配置文件

编辑 `server.py`，修改监听地址：

```python
# 修改启动配置，允许外部访问
if __name__ == "__main__":
    port = 3000
    directory = "/home/xiaozhi/xiaozhi-app"

    # 修改服务器地址绑定
    with socketserver.TCPServer(("0.0.0.0", port), handler) as httpd:
        print(f"🌐 Live2D服务器启动成功")
        print(f"📍 地址: http://0.0.0.0:{port}")
        # ...
```

---

## ⚙️ Nginx配置

### 1. 创建Nginx配置文件

```bash
sudo vim /etc/nginx/sites-available/xiaozhi
```

### 2. Nginx配置内容

```nginx
# Nginx配置文件
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;

    # HTTP重定向到HTTPS (生产环境)
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;

    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;

    # 安全头
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # 静态文件处理
    location /Mould/ {
        alias /home/xiaozhi/xiaozhi-app/Mould/;
        expires 1d;
        add_header Cache-Control "public, immutable";
        gzip on;
        gzip_types application/json;
    }

    location /libs/ {
        alias /home/xiaozhi/xiaozhi-app/libs/;
        expires 1d;
        add_header Cache-Control "public, immutable";
        gzip on;
    }

    # API接口代理
    location /api/ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 主页面
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 日志配置
    access_log /var/log/nginx/xiaozhi_access.log;
    error_log /var/log/nginx/xiaozhi_error.log;

    # 限制请求大小
    client_max_body_size 10M;
}
```

### 3. 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/xiaozhi /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

---

## 🔧 系统服务配置

### 1. 创建Systemd服务文件

**消息处理器服务**:
```bash
sudo vim /etc/systemd/system/xiaozhi-handler.service
```

```ini
[Unit]
Description=XiaoZhi AI Message Handler
After=network.target

[Service]
Type=simple
User=xiaozhi
WorkingDirectory=/home/xiaozhi/xiaozhi-app
Environment=PATH=/home/xiaozhi/xiaozhi-env/bin
ExecStart=/home/xiaozhi/xiaozhi-env/bin/python simple_message_handler.py
Restart=always
RestartSec=10
StandardOutput=file:/home/xiaozhi/xiaozhi-app/logs/handler.log
StandardError=file:/home/xiaozhi/xiaozhi-app/logs/handler_error.log

[Install]
WantedBy=multi-user.target
```

**Flask应用服务**:
```bash
sudo vim /etc/systemd/system/xiaozhi-app.service
```

```ini
[Unit]
Description=XiaoZhi AI Flask Application
After=network.target xiaozhi-handler.service

[Service]
Type=simple
User=xiaozhi
WorkingDirectory=/home/xiaozhi/xiaozhi-app
Environment=PATH=/home/xiaozhi/xiaozhi-env/bin
ExecStart=/home/xiaozhi/xiaozhi-env/bin/gunicorn --bind 127.0.0.1:3000 --workers 4 --timeout 60 server:app
Restart=always
RestartSec=10
StandardOutput=file:/home/xiaozhi/xiaozhi-app/logs/app.log
StandardError=file:/home/xiaozhi/xiaozhi-app/logs/app_error.log

[Install]
WantedBy=multi-user.target
```

### 2. 启动系统服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start xiaozhi-handler
sudo systemctl start xiaozhi-app

# 设置开机自启
sudo systemctl enable xiaozhi-handler
sudo systemctl enable xiaozhi-app

# 检查服务状态
sudo systemctl status xiaozhi-handler
sudo systemctl status xiaozhi-app
```

---

## 🔒 SSL证书配置

### 1. 使用Let's Encrypt (免费证书)

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 申请SSL证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
# 添加以下行:
0 12 * * * /usr/bin/certbot renew --quiet
```

### 2. 验证SSL配置

```bash
# 检查证书状态
sudo certbot certificates

# 测试自动续期
sudo certbot renew --dry-run
```

---

## 📊 监控与日志

### 1. 创建日志轮转配置

```bash
sudo vim /etc/logrotate.d/xiaozhi
```

```
/home/xiaozhi/xiaozhi-app/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0644 xiaozhi xiaozhi
    postrotate
        systemctl reload xiaozhi-handler
        systemctl reload xiaozhi-app
    endscript
}
```

### 2. 系统监控脚本

创建 `monitor.py`:

```python
#!/usr/bin/env python3
"""
系统监控脚本
"""

import psutil
import requests
import time
import json
import logging
from datetime import datetime

# 配置日志
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/home/xiaozhi/xiaozhi-app/logs/monitor.log'),
        logging.StreamHandler()
    ]
)

def check_system_resources():
    """检查系统资源使用情况"""
    cpu_percent = psutil.cpu_percent(interval=1)
    memory = psutil.virtual_memory()
    disk = psutil.disk_usage('/')

    logging.info(f"系统资源: CPU={cpu_percent}%, 内存={memory.percent}%, 磁盘={disk.percent}%")

    # 资源告警
    if cpu_percent > 80:
        logging.warning(f"CPU使用率过高: {cpu_percent}%")
    if memory.percent > 80:
        logging.warning(f"内存使用率过高: {memory.percent}%")
    if disk.percent > 80:
        logging.warning(f"磁盘使用率过高: {disk.percent}%")

def check_service_health():
    """检查服务健康状态"""
    try:
        # 检查应用服务
        response = requests.get('http://127.0.0.1:3000/api/system_status', timeout=10)
        if response.status_code == 200:
            logging.info("应用服务正常")
        else:
            logging.error(f"应用服务异常: HTTP {response.status_code}")

    except Exception as e:
        logging.error(f"应用服务连接失败: {e}")

def main():
    """主监控循环"""
    logging.info("启动系统监控")

    while True:
        try:
            check_system_resources()
            check_service_health()
            time.sleep(60)  # 每分钟检查一次

        except KeyboardInterrupt:
            logging.info("监控停止")
            break
        except Exception as e:
            logging.error(f"监控异常: {e}")
            time.sleep(60)

if __name__ == "__main__":
    main()
```

### 3. 创建监控服务

```bash
sudo vim /etc/systemd/system/xiaozhi-monitor.service
```

```ini
[Unit]
Description=XiaoZhi AI System Monitor
After=network.target

[Service]
Type=simple
User=xiaozhi
WorkingDirectory=/home/xiaozhi/xiaozhi-app
Environment=PATH=/home/xiaozhi/xiaozhi-env/bin
ExecStart=/home/xiaozhi/xiaozhi-env/bin/python monitor.py
Restart=always
RestartSec=30

[Install]
WantedBy=multi-user.target
```

---

## 🛡️ 安全配置

### 1. fail2ban配置

```bash
sudo vim /etc/fail2ban/jail.d/xiaozhi.conf
```

```ini
[nginx-xiaozhi]
enabled = true
port = http,https
filter = nginx-limit-req
logpath = /var/log/nginx/xiaozhi_error.log
maxretry = 5
bantime = 3600
findtime = 60
```

### 2. 系统安全加固

```bash
# 禁用不必要的服务
sudo systemctl disable telnet
sudo systemctl disable ftp

# 配置SSH安全
sudo vim /etc/ssh/sshd_config
# 修改以下配置:
# Port 2222                    # 更改SSH端口
# PermitRootLogin no           # 禁止root登录
# PasswordAuthentication no    # 禁止密码登录(仅使用密钥)
# MaxAuthTries 3               # 限制认证尝试次数

# 重启SSH服务
sudo systemctl restart sshd
```

### 3. 应用安全配置

创建 `security_config.py`:

```python
"""
安全配置模块
"""

import os
import hashlib
import secrets
from functools import wraps
from flask import request, abort
import time
from collections import defaultdict

# 请求频率限制
REQUEST_LIMITS = defaultdict(list)
RATE_LIMIT_PER_MINUTE = 100

def rate_limit(f):
    """请求频率限制装饰器"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        client_ip = request.environ.get('HTTP_X_REAL_IP', request.remote_addr)
        now = time.time()
        minute_ago = now - 60

        # 清理过期记录
        REQUEST_LIMITS[client_ip] = [
            req_time for req_time in REQUEST_LIMITS[client_ip]
            if req_time > minute_ago
        ]

        # 检查频率限制
        if len(REQUEST_LIMITS[client_ip]) >= RATE_LIMIT_PER_MINUTE:
            abort(429)  # Too Many Requests

        REQUEST_LIMITS[client_ip].append(now)
        return f(*args, **kwargs)

    return decorated_function

def secure_headers(response):
    """添加安全响应头"""
    response.headers['X-Content-Type-Options'] = 'nosniff'
    response.headers['X-Frame-Options'] = 'DENY'
    response.headers['X-XSS-Protection'] = '1; mode=block'
    response.headers['Strict-Transport-Security'] = 'max-age=31536000; includeSubDomains'
    return response
```

---

## ⚡ 性能优化

### 1. Gunicorn优化配置

创建 `gunicorn.conf.py`:

```python
"""
Gunicorn配置文件
"""

import multiprocessing

# 服务器配置
bind = "127.0.0.1:3000"
backlog = 2048

# Worker进程配置
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
timeout = 60
keepalive = 2

# 性能优化
preload_app = True
max_requests = 1000
max_requests_jitter = 100

# 日志配置
accesslog = "/home/xiaozhi/xiaozhi-app/logs/gunicorn_access.log"
errorlog = "/home/xiaozhi/xiaozhi-app/logs/gunicorn_error.log"
loglevel = "info"
access_log_format = '%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s "%(f)s" "%(a)s" %(D)s'

# 进程命名
proc_name = "xiaozhi-app"

# 用户和组
user = "xiaozhi"
group = "xiaozhi"
```

### 2. Redis缓存配置 (可选)

```bash
# 安装Redis
sudo apt install -y redis-server

# 配置Redis
sudo vim /etc/redis/redis.conf
# 修改:
# maxmemory 512mb
# maxmemory-policy allkeys-lru

# 启动Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

### 3. CDN配置建议

**阿里云CDN配置**:
```yaml
源站配置:
  源站类型: IP
  源站地址: your-server-ip
  端口: 443
  协议: HTTPS

缓存配置:
  /Mould/: 缓存1天
  /libs/: 缓存1天
  /api/: 不缓存
  /: 缓存1小时

压缩设置:
  Gzip: 启用
  文件类型: html,css,js,json
```

---

## 💾 备份策略

### 1. 数据备份脚本

创建 `backup.sh`:

```bash
#!/bin/bash
"""
自动备份脚本
"""

BACKUP_DIR="/home/xiaozhi/backups"
PROJECT_DIR="/home/xiaozhi/xiaozhi-app"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="xiaozhi_backup_$DATE"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 停止服务
sudo systemctl stop xiaozhi-app
sudo systemctl stop xiaozhi-handler

# 创建备份
tar -czf "$BACKUP_DIR/$BACKUP_NAME.tar.gz" \
    -C /home/xiaozhi \
    --exclude='xiaozhi-app/logs/*' \
    --exclude='xiaozhi-app/__pycache__' \
    xiaozhi-app

# 备份数据库 (如果有)
# mysqldump -u root -p xiaozhi_db > "$BACKUP_DIR/xiaozhi_db_$DATE.sql"

# 重启服务
sudo systemctl start xiaozhi-handler
sleep 3
sudo systemctl start xiaozhi-app

# 清理旧备份 (保留7天)
find $BACKUP_DIR -name "xiaozhi_backup_*.tar.gz" -mtime +7 -delete

# 上传到云存储 (可选)
# aliyun oss cp "$BACKUP_DIR/$BACKUP_NAME.tar.gz" oss://your-bucket/backups/

echo "✅ 备份完成: $BACKUP_NAME.tar.gz"
```

### 2. 定期备份任务

```bash
# 设置定时备份
crontab -e

# 每天凌晨2点备份
0 2 * * * /home/xiaozhi/xiaozhi-app/backup.sh >> /home/xiaozhi/xiaozhi-app/logs/backup.log 2>&1
```

---

## 🚀 部署验证清单

### 部署完成后检查清单

- [ ] **服务状态**: 所有systemd服务正常运行
- [ ] **端口监听**: 80/443端口正常监听
- [ ] **SSL证书**: HTTPS访问正常，证书有效
- [ ] **Web访问**: 浏览器能正常访问Live2D界面
- [ ] **API功能**: 聊天和Live2D控制API正常
- [ ] **语音功能**: 语音识别功能正常工作
- [ ] **日志记录**: 所有日志文件正常写入
- [ ] **监控告警**: 监控脚本正常运行
- [ ] **备份任务**: 定时备份任务配置正确
- [ ] **防火墙**: 安全策略配置正确

### 性能基准测试

```bash
# 使用ab进行简单压力测试
sudo apt install apache2-utils

# 测试主页响应
ab -n 100 -c 10 https://your-domain.com/

# 测试API接口
ab -n 100 -c 10 -p post_data.json -T application/json https://your-domain.com/api/system_status
```

---

## 🎯 总结

这份云部署指南提供了:

✅ **完整的云服务器选择建议**
✅ **详细的部署架构设计**
✅ **生产级别的Nginx和系统服务配置**
✅ **全面的安全和性能优化方案**
✅ **自动化的监控和备份策略**

按照本指南部署后，你将获得一个:
- 🚀 **高性能**: Gunicorn + Nginx 架构
- 🛡️ **高安全**: SSL + 防火墙 + fail2ban
- 📊 **可监控**: 完整的日志和监控体系
- 💾 **可备份**: 自动化备份和恢复机制
- ⚡ **高可用**: systemd 自动重启机制

的生产环境Live2D小智AI系统！

---

*更新时间: 2024年9月*
*适用版本: Live2D小智AI系统 v1.0*