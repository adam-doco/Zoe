<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live2D åŠ¨ä½œè‡ªåŠ¨æ’­æ”¾å™¨</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        .player-section {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .left-panel {
            flex: 1;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .right-panel {
            flex: 2;
            background: rgba(118, 75, 162, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .section-title {
            color: #333;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .control-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .control-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .sequence-editor {
            margin-bottom: 20px;
        }

        .sequence-list {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 10px;
        }

        .sequence-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 8px 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sequence-item:last-child {
            margin-bottom: 0;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .status-display {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .motion-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .motion-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .motion-btn:hover {
            transform: scale(1.05);
        }

        textarea {
            width: 100%;
            height: 150px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            font-family: monospace;
            resize: vertical;
        }

        .documentation {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .doc-section {
            margin-bottom: 20px;
        }

        .doc-section h3 {
            color: #667eea;
            border-bottom: 1px solid #667eea;
            padding-bottom: 5px;
        }

        code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ­ Live2D åŠ¨ä½œè‡ªåŠ¨æ’­æ”¾å™¨</h1>
        
        <div class="player-section">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="left-panel">
                <div class="section-title">æ’­æ”¾æ§åˆ¶</div>
                
                <div class="status-display">
                    <div><strong>çŠ¶æ€ï¼š</strong><span id="player-status">å°±ç»ª</span></div>
                    <div><strong>å½“å‰åŠ¨ä½œï¼š</strong><span id="current-motion">æ— </span></div>
                    <div><strong>è¿›åº¦ï¼š</strong><span id="progress-text">0/0</span></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                </div>

                <button class="control-button" id="start-btn" onclick="startSequence()">â–¶ï¸ å¼€å§‹æ’­æ”¾</button>
                <button class="control-button" id="pause-btn" onclick="pauseSequence()" disabled>â¸ï¸ æš‚åœ</button>
                <button class="control-button" id="stop-btn" onclick="stopSequence()" disabled>â¹ï¸ åœæ­¢</button>
                <button class="control-button" onclick="clearSequence()">ğŸ—‘ï¸ æ¸…ç©ºåºåˆ—</button>
                <button class="control-button" onclick="manualConnect()" id="connect-btn">ğŸ”— æ‰‹åŠ¨è¿æ¥</button>

                <div style="margin-top: 20px;">
                    <div class="section-title">æ’­æ”¾è®¾ç½®</div>
                    <label>æ’­æ”¾é—´éš”æ—¶é—´ (ç§’):</label>
                    <input type="number" id="interval-input" value="4" min="2" max="60" step="0.5" style="width: 100%; margin: 5px 0;">
                    <small style="color: #666; font-size: 11px;">æ¯ä¸ªçŠ¶æ€/è¡¨æƒ…çš„æ’­æ”¾æŒç»­æ—¶é—´</small>
                    <label>
                        <input type="checkbox" id="loop-checkbox"> å¾ªç¯æ’­æ”¾
                    </label>
                </div>
            </div>

            <!-- å³ä¾§ç¼–è¾‘é¢æ¿ -->
            <div class="right-panel">
                <div class="section-title">åŠ¨ä½œåºåˆ—ç¼–è¾‘å™¨</div>
                
                <div style="margin-bottom: 15px;">
                    <h4 style="color: #667eea; margin-bottom: 8px;">ğŸ’ƒ çŠ¶æ€æ§åˆ¶</h4>
                    <div class="motion-grid" id="motion-grid">
                        <!-- çŠ¶æ€æŒ‰é’®å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <h4 style="color: #764ba2; margin-bottom: 8px;">ğŸ˜Š è¡¨æƒ…æ§åˆ¶</h4>
                    <div class="motion-grid" id="expression-grid">
                        <!-- è¡¨æƒ…æŒ‰é’®å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>

                <div class="sequence-editor">
                    <div><strong>å½“å‰åŠ¨ä½œåºåˆ—ï¼š</strong></div>
                    <div class="sequence-list" id="sequence-list">
                        <div style="color: #666; text-align: center; padding: 20px;">æš‚æ— åŠ¨ä½œï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>
                    </div>
                </div>

                <div class="section-title">JSON é…ç½®ç¼–è¾‘</div>
                <textarea id="json-editor" placeholder="åœ¨æ­¤ç¼–è¾‘JSONæ ¼å¼çš„åŠ¨ä½œåºåˆ—é…ç½®..."></textarea>
                <button class="control-button" onclick="loadFromJSON()">ğŸ“¥ ä»JSONåŠ è½½</button>
                <button class="control-button" onclick="exportToJSON()">ğŸ“¤ å¯¼å‡ºä¸ºJSON</button>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜æ–‡æ¡£ -->
        <div class="documentation">
            <div class="section-title">ğŸ“– ä½¿ç”¨è¯´æ˜</div>
            
            <div class="doc-section">
                <h3>1. å¿«é€Ÿå¼€å§‹</h3>
                <p>1. ç‚¹å‡»ä¸Šæ–¹çš„åŠ¨ä½œæŒ‰é’®å°†åŠ¨ä½œæ·»åŠ åˆ°åºåˆ—ä¸­</p>
                <p>2. è°ƒæ•´æ’­æ”¾é—´éš”æ—¶é—´</p>
                <p>3. ç‚¹å‡»"å¼€å§‹æ’­æ”¾"æŒ‰é’®</p>
                <p>4. è§‚å¯ŸLive2Dæ¨¡å‹æŒ‰åºåˆ—æ’­æ”¾åŠ¨ä½œ</p>
            </div>

            <div class="doc-section">
                <h3>2. åŠ¨ä½œåºåˆ—ç¼–è¾‘</h3>
                <p><strong>æ·»åŠ åŠ¨ä½œï¼š</strong>ç‚¹å‡»åŠ¨ä½œæŒ‰é’®ï¼ŒåŠ¨ä½œä¼šè‡ªåŠ¨æ·»åŠ åˆ°åºåˆ—æœ«å°¾</p>
                <p><strong>åˆ é™¤åŠ¨ä½œï¼š</strong>ç‚¹å‡»åºåˆ—ä¸­åŠ¨ä½œé¡¹å³ä¾§çš„åˆ é™¤æŒ‰é’®</p>
                <p><strong>æ¸…ç©ºåºåˆ—ï¼š</strong>ç‚¹å‡»"æ¸…ç©ºåºåˆ—"æŒ‰é’®</p>
            </div>

            <div class="doc-section">
                <h3>3. JSON é…ç½®æ ¼å¼</h3>
                <p>ä½ å¯ä»¥ä½¿ç”¨JSONæ ¼å¼æ¥æ‰¹é‡ç¼–è¾‘åŠ¨ä½œåºåˆ—ï¼š</p>
                <pre id="json-example"></pre>
            </div>

            <div class="doc-section">
                <h3>4. æ’­æ”¾æ§åˆ¶</h3>
                <p><strong>å¼€å§‹æ’­æ”¾ï¼š</strong>æŒ‰ç…§åºåˆ—é¡ºåºæ’­æ”¾åŠ¨ä½œ</p>
                <p><strong>æš‚åœï¼š</strong>æš‚åœå½“å‰æ’­æ”¾ï¼Œå¯ä»¥ç»§ç»­</p>
                <p><strong>åœæ­¢ï¼š</strong>åœæ­¢æ’­æ”¾å¹¶é‡ç½®åˆ°å¼€å§‹ä½ç½®</p>
                <p><strong>å¾ªç¯æ’­æ”¾ï¼š</strong>å‹¾é€‰åä¼šæ— é™å¾ªç¯æ’­æ”¾åºåˆ—</p>
            </div>

            <div class="doc-section">
                <h3>5. å¯ç”¨çŠ¶æ€å’Œè¡¨æƒ…åˆ—è¡¨</h3>
                <h4>ğŸ’ƒ çŠ¶æ€æ§åˆ¶ (motionç±»å‹)</h4>
                <ul>
                    <li><code>å¾…æœº</code> - é»˜è®¤å¾…æœºçŠ¶æ€</li>
                    <li><code>æƒŠè®¶</code> - è¡¨ç°æƒŠè®¶çŠ¶æ€</li>
                    <li><code>å¼€å¿ƒ</code> - è¡¨ç°å¼€å¿ƒçŠ¶æ€</li>
                    <li><code>ç”Ÿæ°”</code> - è¡¨ç°ç”Ÿæ°”çŠ¶æ€</li>
                    <li><code>çœ¨çœ¼</code> - çœ¨çœ¼çŠ¶æ€</li>
                    <li><code>æ‘‡å¤´</code> - æ‘‡å¤´çŠ¶æ€</li>
                </ul>
                <h4>ğŸ˜Š è¡¨æƒ…æ§åˆ¶ (expressionç±»å‹)</h4>
                <ul>
                    <li><code>çˆ±å¿ƒçœ¼</code> - çˆ±å¿ƒå½¢çŠ¶çš„çœ¼ç›è¡¨æƒ…</li>
                    <li><code>ç”Ÿæ°”</code> - ç”Ÿæ°”è¡¨æƒ…</li>
                    <li><code>æ˜Ÿæ˜Ÿçœ¼</code> - æ˜Ÿæ˜Ÿå½¢çŠ¶çš„çœ¼ç›è¡¨æƒ…</li>
                    <li><code>å“­å“­</code> - å“­æ³£è¡¨æƒ…</li>
                    <li><code>éº¦å…‹é£</code> - æ‰‹æŒéº¦å…‹é£è¡¨æƒ…</li>
                    <li><code>å¤–å¥—</code> - å¤–å¥—è£…æ‰®è¡¨æƒ…</li>
                    <li><code>èˆŒå¤´</code> - åèˆŒå¤´è¡¨æƒ…</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // çŠ¶æ€é…ç½®ï¼ˆå¯¹åº”æ¨¡å‹çš„Motionsï¼‰
        const MOTIONS = [
            { name: 'å¾…æœº', group: '', index: 0 },      // Idle.motion3.json
            { name: 'æƒŠè®¶', group: '', index: 1 },      // jingya.motion3.json
            { name: 'å¼€å¿ƒ', group: '', index: 2 },      // kaixin.motion3.json
            { name: 'ç”Ÿæ°”', group: '', index: 3 },      // shengqi.motion3.json
            { name: 'çœ¨çœ¼', group: '', index: 4 },      // wink.motion3.json
            { name: 'æ‘‡å¤´', group: '', index: 5 }       // yaotou.motion3.json
        ];

        // è¡¨æƒ…é…ç½®ï¼ˆå¯¹åº”æ¨¡å‹çš„Expressionsï¼‰
        const EXPRESSIONS = [
            { name: 'çˆ±å¿ƒçœ¼', file: 'A1çˆ±å¿ƒçœ¼' },       // A1çˆ±å¿ƒçœ¼.exp3.json
            { name: 'ç”Ÿæ°”', file: 'A2ç”Ÿæ°”' },           // A2ç”Ÿæ°”.exp3.json
            { name: 'æ˜Ÿæ˜Ÿçœ¼', file: 'A3æ˜Ÿæ˜Ÿçœ¼' },       // A3æ˜Ÿæ˜Ÿçœ¼.exp3.json
            { name: 'å“­å“­', file: 'A4å“­å“­' },           // A4å“­å“­.exp3.json
            { name: 'éº¦å…‹é£', file: 'B1éº¦å…‹é£' },       // B1éº¦å…‹é£.exp3.json
            { name: 'å¤–å¥—', file: 'B2å¤–å¥—' },           // B2å¤–å¥—.exp3.json
            { name: 'èˆŒå¤´', file: 'èˆŒå¤´' }              // èˆŒå¤´.exp3.json
        ];

        // å…¨å±€å˜é‡
        let motionSequence = [];
        let isPlaying = false;
        let isPaused = false;
        let currentIndex = 0;
        let playTimer = null;
        let live2dApp = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeMotionGrid();
            updateSequenceDisplay();
            updateJsonExample();
            
            // å»¶è¿Ÿè¿æ¥ï¼Œç¡®ä¿ä»çˆ¶çª—å£æ¥æ”¶åˆ°æ•°æ®
            setTimeout(() => {
                connectToLive2D();
            }, 500);
        });

        // é¡µé¢åŠ è½½å®Œæˆåå†æ¬¡å°è¯•è¿æ¥
        window.addEventListener('load', function() {
            setTimeout(() => {
                if (!live2dApp) {
                    connectToLive2D();
                }
            }, 1000);
        });

        // åˆå§‹åŒ–åŠ¨ä½œå’Œè¡¨æƒ…æŒ‰é’®ç½‘æ ¼
        function initializeMotionGrid() {
            // åˆå§‹åŒ–åŠ¨ä½œæŒ‰é’®
            const motionGrid = document.getElementById('motion-grid');
            MOTIONS.forEach(motion => {
                const btn = document.createElement('button');
                btn.className = 'motion-btn';
                btn.textContent = motion.name;
                btn.onclick = () => addToSequence('motion', motion);
                motionGrid.appendChild(btn);
            });

            // åˆå§‹åŒ–è¡¨æƒ…æŒ‰é’®
            const expressionGrid = document.getElementById('expression-grid');
            EXPRESSIONS.forEach(expression => {
                const btn = document.createElement('button');
                btn.className = 'motion-btn';
                btn.style.background = 'linear-gradient(45deg, #e91e63, #ff6ec7)';
                btn.textContent = expression.name;
                btn.onclick = () => addToSequence('expression', expression);
                expressionGrid.appendChild(btn);
            });
        }

        // è¿æ¥åˆ°Live2Dåº”ç”¨
        function connectToLive2D() {
            // å°è¯•å¤šç§æ–¹å¼è¿æ¥Live2Då®ä¾‹
            let connected = false;
            
            try {
                // æ–¹å¼1: ä»openerçª—å£è·å–
                if (window.opener && window.opener.live2dApp) {
                    live2dApp = window.opener.live2dApp;
                    connected = true;
                }
                // æ–¹å¼2: ä»parentçª—å£è·å–  
                else if (window.parent && window.parent.live2dApp) {
                    live2dApp = window.parent.live2dApp;
                    connected = true;
                }
                // æ–¹å¼3: ä»å½“å‰çª—å£è·å–ï¼ˆåŒåŸŸæƒ…å†µï¼‰
                else if (window.live2dApp) {
                    live2dApp = window.live2dApp;
                    connected = true;
                }
                // æ–¹å¼4: æ£€æŸ¥æ˜¯å¦é€šè¿‡openMotionPlayerå‡½æ•°æ‰“å¼€ï¼ˆè‡ªåŠ¨è¿æ¥ï¼‰
                else if (window.name === 'MotionPlayer' && window.opener && window.opener.live2dManager) {
                    live2dApp = window.opener.live2dManager;
                    connected = true;
                }
                // æ–¹å¼4: å°è¯•é€šè¿‡fetchæ£€æµ‹åŒæºLive2Dé¡µé¢
                else {
                    // å‘¨æœŸæ€§æ£€æµ‹Live2Dæ˜¯å¦å¯ç”¨
                    const checkInterval = setInterval(() => {
                        if (window.opener && window.opener.live2dApp) {
                            live2dApp = window.opener.live2dApp;
                            updateStatus('å·²è¿æ¥åˆ°Live2D');
                            clearInterval(checkInterval);
                        } else {
                            // å°è¯•é€šè¿‡localStorageé€šä¿¡ï¼ˆå¦‚æœåŒåŸŸï¼‰
                            try {
                                const live2dStatus = localStorage.getItem('live2d_status');
                                if (live2dStatus === 'ready' && window.opener) {
                                    live2dApp = window.opener.live2dApp;
                                    updateStatus('å·²è¿æ¥åˆ°Live2D');
                                    clearInterval(checkInterval);
                                }
                            } catch (e) {
                                // localStorageä¸å¯ç”¨ï¼Œç»§ç»­ç­‰å¾…
                            }
                        }
                    }, 1000);
                    
                    // 5ç§’ååœæ­¢æ£€æµ‹
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        if (!live2dApp) {
                            updateStatus('æœªæ£€æµ‹åˆ°Live2D - è¯·ç¡®ä¿Live2Dé¡µé¢å·²æ‰“å¼€');
                        }
                    }, 5000);
                }
                
                if (connected) {
                    updateStatus('å·²è¿æ¥åˆ°Live2D');
                    console.log('âœ“ Live2Dè¿æ¥æˆåŠŸ');
                } else {
                    updateStatus('æ­£åœ¨æŸ¥æ‰¾Live2Dè¿æ¥...');
                    console.log('æç¤ºï¼šè¯·ç¡®ä¿Live2Dç”Ÿäº§é¡µé¢å·²æ‰“å¼€å¹¶åŠ è½½å®Œæˆ');
                }
                
            } catch (error) {
                updateStatus('è¿æ¥Live2Då¤±è´¥');
                console.error('è¿æ¥é”™è¯¯:', error);
            }
        }

        // æ·»åŠ åŠ¨ä½œæˆ–è¡¨æƒ…åˆ°åºåˆ—
        function addToSequence(type, item) {
            const duration = parseFloat(document.getElementById('interval-input').value) || 3;
            
            if (type === 'motion') {
                motionSequence.push({
                    type: 'motion',
                    name: item.name,
                    group: item.group,
                    index: item.index,
                    duration: duration
                });
            } else if (type === 'expression') {
                motionSequence.push({
                    type: 'expression',
                    name: item.name,
                    file: item.file,
                    duration: duration
                });
            }
            
            updateSequenceDisplay();
            updateJSONEditor();
        }

        // æ›´æ–°åºåˆ—æ˜¾ç¤º
        function updateSequenceDisplay() {
            const container = document.getElementById('sequence-list');
            if (motionSequence.length === 0) {
                container.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">æš‚æ— åŠ¨ä½œï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
                return;
            }

            container.innerHTML = motionSequence.map((item, index) => {
                const typeIcon = item.type === 'motion' ? 'ğŸ’ƒ' : 'ğŸ˜Š';
                const typeColor = item.type === 'motion' ? '#667eea' : '#e91e63';
                const typeName = item.type === 'motion' ? 'çŠ¶æ€' : 'è¡¨æƒ…';
                return `
                    <div class="sequence-item ${index === currentIndex && isPlaying ? 'current' : ''}">
                        <span style="color: ${typeColor}">${typeIcon} ${index + 1}. ${item.name} [${typeName}] (${item.duration}ç§’)</span>
                        <button class="remove-btn" onclick="removeMotion(${index})">åˆ é™¤</button>
                    </div>
                `;
            }).join('');
        }

        // åˆ é™¤åŠ¨ä½œ
        function removeMotion(index) {
            motionSequence.splice(index, 1);
            if (currentIndex >= index && currentIndex > 0) {
                currentIndex--;
            }
            updateSequenceDisplay();
            updateJSONEditor();
        }

        // æ¸…ç©ºåºåˆ—
        function clearSequence() {
            motionSequence = [];
            currentIndex = 0;
            updateSequenceDisplay();
            updateJSONEditor();
        }

        // å¼€å§‹æ’­æ”¾åºåˆ—
        function startSequence() {
            if (motionSequence.length === 0) {
                alert('è¯·å…ˆæ·»åŠ åŠ¨ä½œåˆ°åºåˆ—ä¸­ï¼');
                return;
            }

            if (!live2dApp || !live2dApp.model) {
                alert('æœªæ£€æµ‹åˆ°Live2Dæ¨¡å‹ï¼è¯·ç¡®ä¿åœ¨Live2Dé¡µé¢ä¸­æ‰“å¼€æ­¤è„šæœ¬ã€‚');
                return;
            }

            // ç¦ç”¨Live2Dé¡µé¢çš„è‡ªåŠ¨å›å½’åŠŸèƒ½
            if (live2dApp.idleReturnTimer) {
                clearTimeout(live2dApp.idleReturnTimer);
                live2dApp.idleReturnTimer = null;
                console.log('å·²ç¦ç”¨Live2Dé¡µé¢çš„è‡ªåŠ¨å›å½’åŠŸèƒ½');
            }

            if (isPaused) {
                // ç»§ç»­æ’­æ”¾
                isPaused = false;
                playNextMotion();
            } else {
                // é‡æ–°å¼€å§‹
                currentIndex = 0;
                isPlaying = true;
                playNextMotion();
            }

            updatePlaybackControls();
            updateStatus('æ’­æ”¾ä¸­...');
        }

        // æ’­æ”¾ä¸‹ä¸€ä¸ªçŠ¶æ€æˆ–è¡¨æƒ…
        async function playNextMotion() {
            if (!isPlaying || isPaused) {
                console.log('æ’­æ”¾å·²åœæ­¢æˆ–æš‚åœ');
                return;
            }

            if (currentIndex >= motionSequence.length) {
                console.log('åºåˆ—æ’­æ”¾å®Œæ¯•');
                // åºåˆ—æ’­æ”¾å®Œæ¯•
                const shouldLoop = document.getElementById('loop-checkbox').checked;
                if (shouldLoop) {
                    currentIndex = 0;
                    console.log('å¾ªç¯æ’­æ”¾ï¼Œé‡æ–°å¼€å§‹');
                    playNextMotion();
                } else {
                    await stopSequence();
                    // æ’­æ”¾å®Œæˆåå›å½’å¾…æœºçŠ¶æ€å’Œé»˜è®¤è¡¨æƒ…
                    setTimeout(() => {
                        try {
                            // ä¸å†é‡ç½®è¡¨æƒ…ï¼Œåªæ’­æ”¾å¾…æœºçŠ¶æ€
                            console.log('åºåˆ—æ’­æ”¾å®Œæˆï¼Œä¸é‡ç½®è¡¨æƒ…çŠ¶æ€');
                            
                            // å»¶è¿Ÿä¸€ç‚¹æ’­æ”¾å¾…æœºçŠ¶æ€
                            setTimeout(() => {
                                live2dApp.playMotion('', 0, false); // æ’­æ”¾å¾…æœºçŠ¶æ€ï¼Œæ¢å¤è‡ªåŠ¨å›å½’
                                console.log('åºåˆ—æ’­æ”¾å®Œæˆï¼Œå›å½’å¾…æœºçŠ¶æ€');
                                updateStatus('æ’­æ”¾å®Œæˆ - å·²å›å½’å¾…æœº');
                            }, 200);
                        } catch (error) {
                            console.error('å›å½’å¾…æœºçŠ¶æ€å¤±è´¥:', error);
                        }
                    }, 800);
                }
                return;
            }

            const item = motionSequence[currentIndex];
            console.log(`å‡†å¤‡æ’­æ”¾ç¬¬${currentIndex + 1}é¡¹: ${item.name} (${item.type})`);
            
            updateCurrentMotion(item.name);
            updateProgress();
            updateSequenceDisplay();

            // æ’­æ”¾çŠ¶æ€æˆ–è¡¨æƒ…
            try {
                if (item.type === 'motion') {
                    // è°ƒç”¨æ—¶è·³è¿‡è‡ªåŠ¨å›å½’ï¼Œç”±æ’­æ”¾å™¨æ§åˆ¶
                    live2dApp.playMotion(item.group, item.index, true);
                    console.log(`âœ“ æ’­æ”¾çŠ¶æ€: ${item.name}`);
                } else if (item.type === 'expression') {
                    live2dApp.playExpression(item.file);
                    console.log(`âœ“ æ’­æ”¾è¡¨æƒ…: ${item.name}`);
                    
                    // æ‰‹åŠ¨æ¸…é™¤è¡¨æƒ…æ’­æ”¾å¯èƒ½è§¦å‘çš„å®šæ—¶å™¨
                    if (live2dApp.idleReturnTimer) {
                        clearTimeout(live2dApp.idleReturnTimer);
                        live2dApp.idleReturnTimer = null;
                    }
                }
            } catch (error) {
                console.error(`æ’­æ”¾${item.type === 'motion' ? 'çŠ¶æ€' : 'è¡¨æƒ…'}å¤±è´¥:`, error);
            }

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (playTimer) {
                clearTimeout(playTimer);
                playTimer = null;
            }

            // è®¾ç½®å®šæ—¶å™¨æ’­æ”¾ä¸‹ä¸€ä¸ªé¡¹ç›®
            playTimer = setTimeout(() => {
                console.log(`${item.name} æ’­æ”¾å®Œæˆï¼Œå‡†å¤‡ä¸‹ä¸€ä¸ª`);
                currentIndex++;
                
                // æ£€æŸ¥åˆšæ’­æ”¾å®Œçš„é¡¹ç›®æ˜¯å¦ä¸ºéå¾…æœºå†…å®¹
                const currentItem = motionSequence[currentIndex - 1];
                const isCurrentNonIdle = currentItem && (currentItem.type === 'expression' || 
                    (currentItem.type === 'motion' && !(currentItem.group === '' && currentItem.index === 0)));
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰åç»­çš„éå¾…æœºå†…å®¹éœ€è¦æ’­æ”¾
                const hasMoreNonIdleStates = hasNonIdleStatesAfter(currentIndex);
                
                if (isCurrentNonIdle && !hasMoreNonIdleStates) {
                    // åˆšæ’­æ”¾çš„æ˜¯éå¾…æœºå†…å®¹ï¼Œä¸”åé¢æ²¡æœ‰æ›´å¤šéå¾…æœºå†…å®¹ï¼Œéœ€è¦æ’å…¥å¾…æœº
                    console.log(`${currentItem.name}æ’­æ”¾å®Œæˆï¼Œåç»­æ— éå¾…æœºå†…å®¹ï¼Œæ’å…¥å¾…æœº`);
                    try {
                        live2dApp.playMotion('', 0, true); // æ’­æ”¾å¾…æœºçŠ¶æ€
                        console.log('æ’å…¥å¾…æœºçŠ¶æ€');
                    } catch (error) {
                        console.error('æ’å…¥å¾…æœºçŠ¶æ€å¤±è´¥:', error);
                    }
                    
                    // çŸ­æš‚å»¶è¿Ÿåç»§ç»­åºåˆ—
                    setTimeout(() => {
                        playNextMotion();
                    }, 500);
                } else {
                    // ç›´æ¥æ’­æ”¾ä¸‹ä¸€ä¸ª
                    console.log('ç»§ç»­æ’­æ”¾ä¸‹ä¸€é¡¹');
                    playNextMotion();
                }
            }, item.duration * 1000);
        }

        // æ£€æŸ¥æŒ‡å®šç´¢å¼•ä¹‹åæ˜¯å¦è¿˜æœ‰éå¾…æœºå†…å®¹
        function hasNonIdleStatesAfter(fromIndex) {
            for (let i = fromIndex; i < motionSequence.length; i++) {
                const item = motionSequence[i];
                // ç»Ÿä¸€åˆ¤æ–­ï¼šåªè¦ä¸æ˜¯å¾…æœºçŠ¶æ€ï¼Œå°±ç®—éå¾…æœºå†…å®¹
                const isIdleMotion = (item.type === 'motion' && item.group === '' && item.index === 0);
                
                if (!isIdleMotion) {
                    // æ˜¯éå¾…æœºçŠ¶æ€æˆ–ä»»ä½•è¡¨æƒ…
                    console.log(`åç»­è¿˜æœ‰éå¾…æœºå†…å®¹: ${item.name} (${item.type})`);
                    return true;
                }
            }
            console.log('åç»­æ²¡æœ‰éå¾…æœºå†…å®¹');
            return false;
        }

        // æš‚åœæ’­æ”¾
        function pauseSequence() {
            isPaused = true;
            if (playTimer) {
                clearTimeout(playTimer);
                playTimer = null;
            }
            updatePlaybackControls();
            updateStatus('å·²æš‚åœ');
        }

        // åœæ­¢æ’­æ”¾
        async function stopSequence() {
            isPlaying = false;
            isPaused = false;
            currentIndex = 0;
            if (playTimer) {
                clearTimeout(playTimer);
                playTimer = null;
            }
            
            // åœæ­¢æ—¶å›å½’å¾…æœºå¹¶æ¢å¤è‡ªåŠ¨å›å½’åŠŸèƒ½
            try {
                if (live2dApp && live2dApp.playMotion) {
                    // ä¸å†é‡ç½®è¡¨æƒ…ï¼Œä¿æŒå½“å‰è¡¨æƒ…çŠ¶æ€
                    console.log('æ™ºèƒ½å›å½’ï¼šä¿æŒå½“å‰è¡¨æƒ…çŠ¶æ€ï¼Œä¸è¿›è¡Œé‡ç½®');
                    setTimeout(() => {
                        live2dApp.playMotion('', 0, false); // æ¢å¤è‡ªåŠ¨å›å½’
                        console.log('åœæ­¢æ’­æ”¾ï¼Œå›å½’å¾…æœºçŠ¶æ€å¹¶æ¢å¤è‡ªåŠ¨å›å½’åŠŸèƒ½');
                    }, 100);
                }
            } catch (error) {
                console.error('åœæ­¢æ—¶å›å½’å¾…æœºå¤±è´¥:', error);
            }
            
            updatePlaybackControls();
            updateSequenceDisplay();
            updateProgress();
            updateCurrentMotion('æ— ');
            updateStatus('å·²åœæ­¢');
        }

        // æ›´æ–°æ’­æ”¾æ§åˆ¶æŒ‰é’®çŠ¶æ€
        function updatePlaybackControls() {
            const startBtn = document.getElementById('start-btn');
            const pauseBtn = document.getElementById('pause-btn');
            const stopBtn = document.getElementById('stop-btn');

            if (isPlaying && !isPaused) {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                startBtn.textContent = 'â–¶ï¸ æ’­æ”¾ä¸­...';
            } else if (isPaused) {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = false;
                startBtn.textContent = 'â–¶ï¸ ç»§ç»­æ’­æ”¾';
            } else {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                startBtn.textContent = 'â–¶ï¸ å¼€å§‹æ’­æ”¾';
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status) {
            document.getElementById('player-status').textContent = status;
        }

        // æ›´æ–°å½“å‰åŠ¨ä½œæ˜¾ç¤º
        function updateCurrentMotion(motionName) {
            document.getElementById('current-motion').textContent = motionName;
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress() {
            const progressText = document.getElementById('progress-text');
            const progressFill = document.getElementById('progress-fill');
            
            const current = isPlaying ? currentIndex + 1 : currentIndex;
            const total = motionSequence.length;
            const percentage = total > 0 ? (current / total) * 100 : 0;
            
            progressText.textContent = `${current}/${total}`;
            progressFill.style.width = `${percentage}%`;
        }

        // ä»JSONåŠ è½½åºåˆ—
        function loadFromJSON() {
            const jsonText = document.getElementById('json-editor').value.trim();
            if (!jsonText) {
                alert('è¯·è¾“å…¥JSONé…ç½®ï¼');
                return;
            }

            try {
                const config = JSON.parse(jsonText);
                if (!Array.isArray(config.sequence)) {
                    throw new Error('JSONæ ¼å¼é”™è¯¯ï¼šsequenceå¿…é¡»æ˜¯æ•°ç»„');
                }

                motionSequence = config.sequence.map(item => {
                    if (item.type === 'motion' || !item.type) { // å…¼å®¹æ—§æ ¼å¼
                        const motionName = item.name || item.motion; // å…¼å®¹æ—§æ ¼å¼
                        const motion = MOTIONS.find(m => m.name === motionName);
                        if (!motion) {
                            throw new Error(`æœªçŸ¥åŠ¨ä½œ: ${motionName}`);
                        }
                        return {
                            type: 'motion',
                            name: motion.name,
                            group: motion.group,
                            index: motion.index,
                            duration: item.duration || 3
                        };
                    } else if (item.type === 'expression') {
                        const expression = EXPRESSIONS.find(e => e.name === item.name);
                        if (!expression) {
                            throw new Error(`æœªçŸ¥è¡¨æƒ…: ${item.name}`);
                        }
                        return {
                            type: 'expression',
                            name: expression.name,
                            file: expression.file,
                            duration: item.duration || 3
                        };
                    } else {
                        throw new Error(`æœªçŸ¥ç±»å‹: ${item.type}`);
                    }
                });

                updateSequenceDisplay();
                alert('JSONé…ç½®åŠ è½½æˆåŠŸï¼');
            } catch (error) {
                alert('JSONé…ç½®åŠ è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // å¯¼å‡ºä¸ºJSON
        function exportToJSON() {
            const config = {
                sequence: motionSequence.map(item => ({
                    type: item.type,
                    name: item.name,
                    duration: item.duration
                })),
                settings: {
                    loop: document.getElementById('loop-checkbox').checked,
                    defaultInterval: parseFloat(document.getElementById('interval-input').value)
                }
            };

            document.getElementById('json-editor').value = JSON.stringify(config, null, 2);
        }

        // æ›´æ–°JSONç¼–è¾‘å™¨å†…å®¹
        function updateJSONEditor() {
            if (motionSequence.length > 0) {
                exportToJSON();
            }
        }

        // æ‰‹åŠ¨è¿æ¥Live2D
        function manualConnect() {
            // å°è¯•å¼ºåˆ¶è¿æ¥
            connectToLive2D();
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰è¿æ¥ï¼Œæä¾›è¯¦ç»†çš„è¿æ¥æŒ‡å—
            setTimeout(() => {
                if (!live2dApp) {
                    const instructions = `
è¿æ¥æŒ‡å—ï¼š

æ–¹æ³•1 - ä»Live2Dé¡µé¢æ‰“å¼€è„šæœ¬ï¼š
1. å…ˆæ‰“å¼€: http://localhost:8080/index-production.html
2. ç­‰å¾…Live2Dæ¨¡å‹åŠ è½½å®Œæˆ
3. æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·
4. åœ¨æ§åˆ¶å°è¾“å…¥: window.open('motion-player.html')

æ–¹æ³•2 - ç›´æ¥æµ‹è¯•ï¼ˆä»…ä¾›è°ƒè¯•ï¼‰ï¼š
å¦‚æœä½ æƒ³ç›´æ¥æµ‹è¯•è„šæœ¬åŠŸèƒ½ï¼Œå¯ä»¥ç‚¹å‡»"æ¨¡æ‹Ÿè¿æ¥"æŒ‰é’®
                    `;
                    
                    if (confirm(instructions + '\n\næ˜¯å¦è¦å¯ç”¨æ¨¡æ‹Ÿæ¨¡å¼è¿›è¡Œæµ‹è¯•ï¼Ÿ')) {
                        // åˆ›å»ºæ¨¡æ‹Ÿçš„Live2Då¯¹è±¡ç”¨äºæµ‹è¯•
                        live2dApp = {
                            model: { internalModel: true },
                            playMotion: function(group, index) {
                                console.log(`[æ¨¡æ‹Ÿ] æ’­æ”¾åŠ¨ä½œ: ç»„="${group}", ç´¢å¼•=${index}`);
                                const motionNames = ['å¾…æœº', 'æƒŠè®¶', 'å¼€å¿ƒ', 'ç”Ÿæ°”', 'çœ¨çœ¼', 'æ‘‡å¤´'];
                                alert(`[æ¨¡æ‹Ÿæ¨¡å¼] æ’­æ”¾åŠ¨ä½œ: ${motionNames[index] || 'æœªçŸ¥'}`);
                            }
                        };
                        updateStatus('å·²è¿æ¥åˆ°Live2Dï¼ˆæ¨¡æ‹Ÿæ¨¡å¼ï¼‰');
                        document.getElementById('connect-btn').textContent = 'ğŸŸ¢ å·²è¿æ¥ï¼ˆæ¨¡æ‹Ÿï¼‰';
                        document.getElementById('connect-btn').disabled = true;
                    }
                }
            }, 1000);
        }

        // æ›´æ–°JSONç¤ºä¾‹
        function updateJsonExample() {
            const example = {
                sequence: [
                    { type: "motion", name: "å¼€å¿ƒ", duration: 3 },
                    { type: "expression", name: "çˆ±å¿ƒçœ¼", duration: 2 },
                    { type: "motion", name: "çœ¨çœ¼", duration: 2 },
                    { type: "expression", name: "æ˜Ÿæ˜Ÿçœ¼", duration: 3 },
                    { type: "motion", name: "æ‘‡å¤´", duration: 4 },
                    { type: "motion", name: "å¾…æœº", duration: 3 }
                ],
                settings: {
                    loop: false,
                    defaultInterval: 3
                },
                note: "motionç±»å‹ä¸ºçŠ¶æ€æ§åˆ¶ï¼Œexpressionç±»å‹ä¸ºè¡¨æƒ…æ§åˆ¶"
            };
            document.getElementById('json-example').textContent = JSON.stringify(example, null, 2);
        }

        // æ·»åŠ æ ·å¼ï¼šå½“å‰æ’­æ”¾çš„åŠ¨ä½œé«˜äº®
        const style = document.createElement('style');
        style.textContent = `
            .sequence-item.current {
                background: #e3f2fd !important;
                border-color: #2196f3 !important;
                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>