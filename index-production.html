<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æ™ºLive2D - ç”Ÿäº§ç¯å¢ƒ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }

        /* Live2D canvas */
        #live2d-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* æ§åˆ¶é¢æ¿ */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 300px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.small {
            padding: 8px 12px;
            font-size: 11px;
        }

        /* è¯­éŸ³æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        #voice-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            font-size: 14px;
            padding: 15px 25px;
            width: 100%;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }

        #voice-btn:hover {
            background: linear-gradient(45deg, #ff5252, #ff7979);
        }

        #voice-btn.recording {
            background: linear-gradient(45deg, #ff1744, #f50057);
            animation: pulse 1.5s infinite;
        }

        #voice-btn.connecting {
            background: linear-gradient(45deg, #ffa726, #ffb74d);
            animation: connecting 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes connecting {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            color: #666;
            text-align: center;
            margin: 10px 0;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        /* ä¸­æ–­æŒ‰é’® */
        #interrupt-btn {
            background: linear-gradient(45deg, #f44336, #ef5350);
            width: 100%;
            margin-top: 10px;
        }

        #interrupt-btn:hover {
            background: linear-gradient(45deg, #d32f2f, #f44336);
        }

        #interrupt-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* é”™è¯¯ä¿¡æ¯ */
        .error-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f44336;
            color: white;
            padding: 10px;
            text-align: center;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .error-bar.show {
            transform: translateY(0);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .controls::-webkit-scrollbar {
            width: 6px;
        }

        .controls::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .controls::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 3px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .controls {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <canvas id="live2d-canvas"></canvas>
    
    <!-- é”™è¯¯æç¤ºæ¡ -->
    <div id="error-bar" class="error-bar"></div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls">
        <!-- è¯­éŸ³æ§åˆ¶ -->
        <div class="control-group">
            <h3>ğŸ¤ è¯­éŸ³å¯¹è¯</h3>
            <div id="voice-status" class="status">ç‚¹å‡»è¿æ¥å°æ™º</div>
            <button id="voice-btn" class="btn">è¿æ¥å°æ™ºAI</button>
            <button id="interrupt-btn" class="btn" disabled>ä¸­æ–­å¯¹è¯</button>
        </div>

        <!-- åŠ¨ä½œæ§åˆ¶ -->
        <div class="control-group">
            <h3>ğŸ’ƒ åŠ¨ä½œè¡¨æƒ…</h3>
            <div id="motions-container">
                <!-- åŠ¨ä½œæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- è¡¨æƒ…æ§åˆ¶ -->
        <div class="control-group">
            <h3>ğŸ˜Š è¡¨æƒ…æ§åˆ¶</h3>
            <div id="expressions-container">
                <!-- è¡¨æƒ…æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åŠ¨ä½œæ’­æ”¾å™¨ -->
        <div class="control-group">
            <h3>ğŸ­ åŠ¨ä½œæ’­æ”¾å™¨</h3>
            <button class="btn" onclick="openMotionPlayer()">æ‰“å¼€åŠ¨ä½œæ’­æ”¾å™¨</button>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="control-group">
            <h3>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h3>
            <div style="font-size: 11px; color: #666; line-height: 1.4;">
                <div>ç¯å¢ƒ: ç”Ÿäº§ç¯å¢ƒ</div>
                <div>ç‰ˆæœ¬: v2.0.0</div>
                <div id="device-info">è®¾å¤‡: æ­£åœ¨è·å–...</div>
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒè„šæœ¬ -->
    <script>
        // ========== å…¨å±€é…ç½® ==========
        const XIAOZHI_CONFIG = {
            // ç”Ÿäº§ç¯å¢ƒé…ç½®
            websocketUrl: 'wss://api.tenclass.net/xiaozhi/v1/',
            otaUrl: 'https://api.tenclass.net/xiaozhi/ota/',
            
            // è®¾å¤‡ä¿¡æ¯ (å·²æ¿€æ´»çš„è®¾å¤‡)
            deviceId: 'b3:66:fa:cc:95:b9',
            clientId: 'c5d17de5-277a-47d9-8a7b-137300ea0fbc',
            serialNumber: 'SN-07BB9BEF-b366facc95b9',
            hmacKey: '431c400f98c949da553dff65800effa5183d2f5def9db9698bbcd40b9d751df2',
            
            // éŸ³é¢‘é…ç½®
            audio: {
                sampleRate: 16000,
                channels: 1,
                frameSize: 960
            }
        };

        // ========== Live2Dç®¡ç†å™¨ ==========
        class Live2DManager {
            constructor() {
                this.app = null;
                this.model = null;
                this.canvas = document.getElementById('live2d-canvas');
                this.isLoaded = false;
            }

            async init() {
                try {
                    await this.loadScripts();
                    await this.initPixiApp();
                    await this.loadModel();
                    this.setupControls();
                    console.log('âœ“ Live2Dåˆå§‹åŒ–å®Œæˆ');
                    this.isLoaded = true;
                } catch (error) {
                    console.error('Live2Dåˆå§‹åŒ–å¤±è´¥:', error);
                    showError('Live2DåŠ è½½å¤±è´¥: ' + error.message);
                }
            }

            async loadScripts() {
                const scripts = [
                    'https://unpkg.com/pixi.js@7.3.2/dist/pixi.min.js',
                    'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js'
                ];

                for (const src of scripts) {
                    await this.loadScript(src);
                }

                // è®¾ç½®PIXIå…¨å±€å˜é‡
                window.PIXI = PIXI;
                
                // åŠ è½½Live2Dæ˜¾ç¤ºåº“
                await this.loadScript('https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.min.js');
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = () => reject(new Error(`è„šæœ¬åŠ è½½å¤±è´¥: ${src}`));
                    document.head.appendChild(script);
                });
            }

            async initPixiApp() {
                this.app = new PIXI.Application({
                    view: this.canvas,
                    width: window.innerWidth,
                    height: window.innerHeight,
                    backgroundColor: 0x000000,
                    backgroundAlpha: 0,
                    antialias: true,
                    resolution: window.devicePixelRatio || 1,
                    autoDensity: true
                });

                // å“åº”å¼å¤„ç†
                window.addEventListener('resize', () => {
                    this.app.renderer.resize(window.innerWidth, window.innerHeight);
                    if (this.model) {
                        this.positionModel();
                    }
                });
            }

            async loadModel() {
                try {
                    console.log('æ­£åœ¨åŠ è½½Live2Dæ¨¡å‹...');
                    
                    // éªŒè¯æ¨¡å‹æ–‡ä»¶
                    const response = await fetch('Mould/Z.model3.json', { method: 'HEAD' });
                    if (!response.ok) {
                        throw new Error('æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®');
                    }

                    this.model = await PIXI.live2d.Live2DModel.from('Mould/Z.model3.json');
                    this.app.stage.addChild(this.model);
                    this.positionModel();

                    console.log('âœ“ Live2Dæ¨¡å‹åŠ è½½æˆåŠŸ');
                } catch (error) {
                    console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                    throw error;
                }
            }

            positionModel() {
                if (!this.model) return;

                const scale = Math.min(
                    window.innerWidth / this.model.width,
                    window.innerHeight / this.model.height
                ) * 0.7;

                this.model.scale.set(scale);
                this.model.anchor.set(0.5, 0.5);
                this.model.x = window.innerWidth * 0.5;
                this.model.y = window.innerHeight * 0.5;
            }

            setupControls() {
                if (!this.model) return;

                const motionsContainer = document.getElementById('motions-container');
                const expressionsContainer = document.getElementById('expressions-container');

                // ä»æ¨¡å‹æ–‡ä»¶ä¸­è·å–åŠ¨ä½œåˆ—è¡¨ï¼ˆæŒ‰ç´¢å¼•é¡ºåºå¯¹åº”motionæ–‡ä»¶ï¼‰
                const motions = [
                    { name: 'å¾…æœº', group: '', index: 0 },
                    { name: 'æƒŠè®¶', group: '', index: 1 },
                    { name: 'å¼€å¿ƒ', group: '', index: 2 },
                    { name: 'ç”Ÿæ°”', group: '', index: 3 },
                    { name: 'çœ¨çœ¼', group: '', index: 4 },
                    { name: 'æ‘‡å¤´', group: '', index: 5 }
                ];

                // ç”ŸæˆåŠ¨ä½œæŒ‰é’®
                motions.forEach(motion => {
                    const btn = document.createElement('button');
                    btn.className = 'btn small';
                    btn.textContent = motion.name;
                    btn.onclick = () => this.playMotion(motion.group, motion.index);
                    motionsContainer.appendChild(btn);
                });

                // ä»æ¨¡å‹æ–‡ä»¶ä¸­è·å–è¡¨æƒ…åˆ—è¡¨
                const expressions = [
                    { name: 'çˆ±å¿ƒçœ¼', file: 'A1çˆ±å¿ƒçœ¼' },
                    { name: 'ç”Ÿæ°”', file: 'A2ç”Ÿæ°”' },
                    { name: 'æ˜Ÿæ˜Ÿçœ¼', file: 'A3æ˜Ÿæ˜Ÿçœ¼' },
                    { name: 'å“­å“­', file: 'A4å“­å“­' },
                    { name: 'éº¦å…‹é£', file: 'B1éº¦å…‹é£' },
                    { name: 'å¤–å¥—', file: 'B2å¤–å¥—' },
                    { name: 'èˆŒå¤´', file: 'èˆŒå¤´' }
                ];

                // ç”Ÿæˆè¡¨æƒ…æŒ‰é’®
                expressions.forEach(expression => {
                    const btn = document.createElement('button');
                    btn.className = 'btn small';
                    btn.textContent = expression.name;
                    btn.onclick = () => this.playExpression(expression.file);
                    expressionsContainer.appendChild(btn);
                });
            }

            playMotion(group, index = 0) {
                if (this.model && this.model.internalModel) {
                    try {
                        // ä½¿ç”¨pixi-live2d-displayçš„motionæ–¹æ³•ï¼Œä¼ å…¥ç»„åå’Œç´¢å¼•
                        this.model.motion(group, index);
                        console.log(`æ’­æ”¾åŠ¨ä½œ: ç»„=${group}, ç´¢å¼•=${index}`);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.textContent = `æ’­æ”¾åŠ¨ä½œ: ç´¢å¼• ${index}`;
                        }
                    } catch (error) {
                        console.error('æ’­æ”¾åŠ¨ä½œå¤±è´¥:', error);
                        // å°è¯•å…¶ä»–æ–¹å¼
                        try {
                            console.log('å°è¯•å¤‡ç”¨æ–¹æ³•...');
                            this.model.internalModel.motionManager.startMotion(group, index);
                        } catch (fallbackError) {
                            console.error('å¤‡ç”¨æ–¹æ³•ä¹Ÿå¤±è´¥:', fallbackError);
                        }
                    }
                }
            }

            playExpression(expressionName) {
                if (this.model && this.model.internalModel) {
                    try {
                        // ä½¿ç”¨pixi-live2d-displayçš„expressionæ–¹æ³•
                        this.model.expression(expressionName);
                        console.log(`æ’­æ”¾è¡¨æƒ…: ${expressionName}`);
                        
                        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                        const statusEl = document.getElementById('status');
                        if (statusEl) {
                            statusEl.textContent = `æ’­æ”¾è¡¨æƒ…: ${expressionName}`;
                        }
                    } catch (error) {
                        console.error('æ’­æ”¾è¡¨æƒ…å¤±è´¥:', error);
                    }
                }
            }

            // å…¨å±€æ–¹æ³•
            playTalk() {
                this.playMotion('talk', Math.floor(Math.random() * 3));
            }

            playIdle() {
                this.playMotion('idle', Math.floor(Math.random() * 3));
            }
        }

        // ========== å°æ™ºAIå®¢æˆ·ç«¯ ==========
        class XiaozhiAIClient {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.isRecording = false;
                this.sessionId = null;
                
                // éŸ³é¢‘ç›¸å…³
                this.audioContext = null;
                this.processor = null;
                this.mediaStream = null;
                
                // UIå…ƒç´ 
                this.voiceBtn = document.getElementById('voice-btn');
                this.statusDiv = document.getElementById('voice-status');
                this.interruptBtn = document.getElementById('interrupt-btn');
                
                this.bindEvents();
                this.updateDeviceInfo();
            }

            bindEvents() {
                this.voiceBtn.addEventListener('click', () => {
                    if (!this.isConnected) {
                        this.connectToXiaozhi();
                    }
                });

                // é•¿æŒ‰å½•éŸ³
                this.voiceBtn.addEventListener('mousedown', (e) => {
                    if (this.isConnected && !this.isRecording) {
                        e.preventDefault();
                        this.startRecording();
                    }
                });

                this.voiceBtn.addEventListener('mouseup', (e) => {
                    if (this.isRecording) {
                        e.preventDefault();
                        this.stopRecording();
                    }
                });

                // è§¦æ‘¸æ”¯æŒ
                this.voiceBtn.addEventListener('touchstart', (e) => {
                    if (this.isConnected && !this.isRecording) {
                        e.preventDefault();
                        this.startRecording();
                    }
                });

                this.voiceBtn.addEventListener('touchend', (e) => {
                    if (this.isRecording) {
                        e.preventDefault();
                        this.stopRecording();
                    }
                });

                this.interruptBtn.addEventListener('click', () => {
                    this.interrupt();
                });
            }

            updateDeviceInfo() {
                const deviceInfo = document.getElementById('device-info');
                deviceInfo.textContent = `è®¾å¤‡: ${XIAOZHI_CONFIG.deviceId}`;
            }

            async connectToXiaozhi() {
                if (this.isConnected) return;

                try {
                    this.updateStatus('æ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...');
                    this.voiceBtn.className = 'btn connecting';
                    
                    // è·å–è®¿é—®ä»¤ç‰Œ
                    const token = await this.getAccessToken();
                    this.accessToken = token;
                    
                    this.updateStatus('æ­£åœ¨è¿æ¥å°æ™ºAI...');
                    
                    // ç”Ÿæˆä¼šè¯ID
                    this.sessionId = this.generateSessionId();
                    
                    // è¿æ¥WebSocket
                    await this.connectWebSocket(token);
                    
                } catch (error) {
                    console.error('è¿æ¥å¤±è´¥:', error);
                    this.updateStatus(`è¿æ¥å¤±è´¥: ${error.message}`);
                    this.voiceBtn.className = 'btn';
                    showError('è¿æ¥å°æ™ºAIå¤±è´¥: ' + error.message);
                }
            }

            async getAccessToken() {
                try {
                    const response = await fetch(XIAOZHI_CONFIG.otaUrl, {
                        method: 'POST',
                        headers: {
                            'Device-Id': XIAOZHI_CONFIG.deviceId,
                            'Client-Id': XIAOZHI_CONFIG.clientId,
                            'Content-Type': 'application/json',
                            'User-Agent': 'Live2D-Client/1.0.0',
                            'Accept-Language': 'zh-CN',
                            'Activation-Version': '1.0.0'
                        },
                        body: JSON.stringify({
                            application: {
                                version: '1.0.0',
                                elf_sha256: XIAOZHI_CONFIG.hmacKey
                            },
                            board: {
                                type: 'live2d-client',
                                name: 'live2d-client',
                                ip: '127.0.0.1',
                                mac: XIAOZHI_CONFIG.deviceId
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`OTAè¯·æ±‚å¤±è´¥: HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('OTAå“åº”:', data);

                    if (!data.websocket || !data.websocket.token) {
                        throw new Error('OTAå“åº”ä¸­ç¼ºå°‘WebSocketä»¤ç‰Œ');
                    }

                    return data.websocket.token;
                } catch (error) {
                    console.error('è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥:', error);
                    throw new Error('æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ: ' + error.message);
                }
            }

            generateSessionId() {
                return 'live2d_' + Date.now() + '_' + Math.random().toString(36).substring(2);
            }

            async connectWebSocket(token) {
                return new Promise((resolve, reject) => {
                    // å°è¯•ä¸åŒçš„URLæ ¼å¼
                    const wsUrl = `${XIAOZHI_CONFIG.websocketUrl}`;
                    console.log('è¿æ¥WebSocket:', wsUrl);
                    console.log('ä½¿ç”¨token:', token);
                    console.log('è®¾å¤‡ID:', XIAOZHI_CONFIG.deviceId);
                    console.log('å®¢æˆ·ç«¯ID:', XIAOZHI_CONFIG.clientId);

                    this.ws = new WebSocket(wsUrl);

                    const timeout = setTimeout(() => {
                        if (this.ws.readyState !== WebSocket.OPEN) {
                            this.ws.close();
                            reject(new Error('WebSocketè¿æ¥è¶…æ—¶'));
                        }
                    }, 10000);

                    this.ws.onopen = () => {
                        clearTimeout(timeout);
                        console.log('âœ“ WebSocketè¿æ¥æˆåŠŸ');
                        this.sendHelloMessage();
                    };

                    this.ws.onmessage = (event) => {
                        this.handleMessage(event);
                    };

                    this.ws.onclose = (event) => {
                        console.log('WebSocketè¿æ¥å…³é—­:', event.code, event.reason);
                        this.isConnected = false;
                        this.updateStatus('è¿æ¥å·²æ–­å¼€');
                        this.voiceBtn.className = 'btn';
                        this.voiceBtn.textContent = 'é‡æ–°è¿æ¥';
                        this.interruptBtn.disabled = true;
                    };

                    this.ws.onerror = (error) => {
                        console.error('WebSocketé”™è¯¯:', error);
                        clearTimeout(timeout);
                        reject(new Error('WebSocketè¿æ¥é”™è¯¯'));
                    };

                    // ç­‰å¾…helloå“åº”
                    const originalOnMessage = this.ws.onmessage;
                    this.ws.onmessage = (event) => {
                        try {
                            const message = JSON.parse(event.data);
                            if (message.type === 'hello_response') {
                                console.log('âœ“ æ”¶åˆ°helloå“åº”:', message);
                                this.isConnected = true;
                                this.updateStatus('å·²è¿æ¥ - é•¿æŒ‰è¯´è¯');
                                this.voiceBtn.className = 'btn';
                                this.voiceBtn.textContent = 'é•¿æŒ‰è¯´è¯';
                                this.interruptBtn.disabled = false;
                                this.ws.onmessage = originalOnMessage;
                                resolve();
                            }
                        } catch (e) {
                            // å¿½ç•¥éJSONæ¶ˆæ¯
                        }
                    };
                });
            }

            sendHelloMessage() {
                // å…ˆå‘é€è®¤è¯ä¿¡æ¯
                const authMessage = {
                    authorization: `Bearer ${this.accessToken}`,
                    protocol_version: '1',
                    device_id: XIAOZHI_CONFIG.deviceId,
                    client_id: XIAOZHI_CONFIG.clientId
                };
                
                console.log('å‘é€è®¤è¯æ¶ˆæ¯:', authMessage);
                this.ws.send(JSON.stringify(authMessage));
                
                // ç„¶åå‘é€helloæ¶ˆæ¯
                const helloMessage = {
                    type: 'hello',
                    version: 1,
                    features: { mcp: true },
                    transport: 'websocket',
                    audio_params: {
                        format: 'opus',
                        sample_rate: XIAOZHI_CONFIG.audio.sampleRate,
                        channels: XIAOZHI_CONFIG.audio.channels,
                        frame_duration: 60
                    }
                };
                
                console.log('å‘é€helloæ¶ˆæ¯:', helloMessage);
                setTimeout(() => {
                    this.ws.send(JSON.stringify(helloMessage));
                }, 100);
            }

            handleMessage(event) {
                try {
                    // å°è¯•è§£æJSONæ¶ˆæ¯
                    let message;
                    try {
                        message = JSON.parse(event.data);
                    } catch {
                        // å¦‚æœä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯äºŒè¿›åˆ¶æ•°æ®
                        console.log('æ”¶åˆ°äºŒè¿›åˆ¶æ•°æ®:', event.data.length, 'bytes');
                        return;
                    }

                    console.log('æ”¶åˆ°æ¶ˆæ¯:', message);

                    switch (message.type) {
                        case 'stt':
                            this.handleSTTResult(message);
                            break;
                        case 'llm':
                            this.handleLLMResponse(message);
                            break;
                        case 'tts':
                            this.handleTTSMessage(message);
                            break;
                        case 'error':
                            console.error('æœåŠ¡å™¨é”™è¯¯:', message);
                            showError('æœåŠ¡å™¨é”™è¯¯: ' + (message.message || 'æœªçŸ¥é”™è¯¯'));
                            break;
                        default:
                            console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', message.type);
                    }
                } catch (error) {
                    console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
                }
            }

            handleSTTResult(message) {
                console.log('STTç»“æœ:', message.text);
                this.updateStatus(`å¬åˆ°: ${message.text}`);
                
                if (live2dManager.isLoaded) {
                    live2dManager.playIdle();
                }
            }

            handleLLMResponse(message) {
                console.log('LLMå“åº”:', message.text);
                this.updateStatus(`å°æ™º: ${message.text.substring(0, 30)}...`);
                
                if (live2dManager.isLoaded) {
                    live2dManager.playTalk();
                }
            }

            handleTTSMessage(message) {
                console.log('TTSæ¶ˆæ¯:', message);
                
                if (message.state === 'start') {
                    this.updateStatus('å°æ™ºæ­£åœ¨è¯´è¯...');
                    if (live2dManager.isLoaded) {
                        live2dManager.playTalk();
                    }
                } else if (message.state === 'stop') {
                    this.updateStatus('å·²è¿æ¥ - é•¿æŒ‰è¯´è¯');
                    if (live2dManager.isLoaded) {
                        live2dManager.playIdle();
                    }
                }
            }

            async startRecording() {
                if (!this.isConnected || this.isRecording) return;

                try {
                    this.isRecording = true;
                    this.voiceBtn.className = 'btn recording';
                    this.updateStatus('æ­£åœ¨å½•éŸ³...');

                    // è·å–éº¦å…‹é£æƒé™
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: XIAOZHI_CONFIG.audio.sampleRate,
                            channelCount: XIAOZHI_CONFIG.audio.channels,
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });

                    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: XIAOZHI_CONFIG.audio.sampleRate
                    });

                    const source = this.audioContext.createMediaStreamSource(this.mediaStream);
                    
                    // åˆ›å»ºéŸ³é¢‘å¤„ç†èŠ‚ç‚¹
                    this.processor = this.audioContext.createScriptProcessor(XIAOZHI_CONFIG.audio.frameSize, 1, 1);
                    
                    this.processor.onaudioprocess = (event) => {
                        const inputData = event.inputBuffer.getChannelData(0);
                        const pcmData = new Int16Array(inputData.length);
                        
                        // è½¬æ¢ä¸º16ä½PCM
                        for (let i = 0; i < inputData.length; i++) {
                            pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
                        }
                        
                        // å‘é€éŸ³é¢‘æ•°æ®
                        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                            this.ws.send(pcmData.buffer);
                        }
                    };

                    source.connect(this.processor);
                    this.processor.connect(this.audioContext.destination);

                    console.log('âœ“ å¼€å§‹å½•éŸ³');

                } catch (error) {
                    console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
                    this.stopRecording();
                    showError('æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message);
                }
            }

            stopRecording() {
                if (!this.isRecording) return;

                this.isRecording = false;
                this.voiceBtn.className = 'btn';
                this.updateStatus('å¤„ç†ä¸­...');

                // æ¸…ç†éŸ³é¢‘èµ„æº
                if (this.processor) {
                    this.processor.disconnect();
                    this.processor = null;
                }

                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                if (this.mediaStream) {
                    this.mediaStream.getTracks().forEach(track => track.stop());
                    this.mediaStream = null;
                }

                // å‘é€å½•éŸ³ç»“æŸä¿¡å·
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'audio_end', session_id: this.sessionId }));
                }

                console.log('âœ“ å½•éŸ³ç»“æŸ');
            }

            interrupt() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'interrupt', session_id: this.sessionId }));
                    this.updateStatus('å·²ä¸­æ–­');
                    console.log('âœ“ å‘é€ä¸­æ–­ä¿¡å·');
                }
            }

            updateStatus(message) {
                this.statusDiv.textContent = message;
                
                // æ›´æ–°çŠ¶æ€æ ·å¼
                this.statusDiv.className = 'status';
                if (message.includes('å·²è¿æ¥') || message.includes('æˆåŠŸ')) {
                    this.statusDiv.className += ' connected';
                } else if (message.includes('å¤±è´¥') || message.includes('é”™è¯¯')) {
                    this.statusDiv.className += ' error';
                }
            }
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function showError(message) {
            const errorBar = document.getElementById('error-bar');
            errorBar.textContent = message;
            errorBar.className = 'error-bar show';
            
            setTimeout(() => {
                errorBar.className = 'error-bar';
            }, 5000);
        }

        // ========== å…¨å±€æ–¹æ³• ==========
        function playTalk() {
            if (live2dManager.isLoaded) {
                live2dManager.playTalk();
            }
        }


        function playIdle() {
            if (live2dManager.isLoaded) {
                live2dManager.playIdle();
            }
        }

        // æ‰“å¼€åŠ¨ä½œæ’­æ”¾å™¨ï¼ˆè‡ªåŠ¨è¿æ¥ç‰ˆæœ¬ï¼‰
        function openMotionPlayer() {
            // æ‰“å¼€æ–°çª—å£å¹¶ä¼ é€’è¿æ¥ä¿¡æ¯
            const playerWindow = window.open('motion-player.html', 'MotionPlayer', 'width=1200,height=800');
            
            // ç­‰å¾…æ–°çª—å£åŠ è½½å®Œæˆåè‡ªåŠ¨å»ºç«‹è¿æ¥
            if (playerWindow) {
                playerWindow.addEventListener('load', () => {
                    // ç›´æ¥ä¼ é€’live2dAppå¼•ç”¨ç»™æ–°çª—å£
                    if (live2dManager && live2dManager.isLoaded) {
                        playerWindow.live2dApp = live2dManager;
                        console.log('âœ“ åŠ¨ä½œæ’­æ”¾å™¨è‡ªåŠ¨è¿æ¥æˆåŠŸ');
                    }
                });
                
                // ç¡®ä¿è¿æ¥æˆåŠŸçš„å¤‡ç”¨æ–¹æ³•
                setTimeout(() => {
                    if (playerWindow && !playerWindow.closed && live2dManager) {
                        playerWindow.live2dApp = live2dManager;
                        if (playerWindow.updateStatus) {
                            playerWindow.updateStatus('å·²è‡ªåŠ¨è¿æ¥åˆ°Live2D');
                        }
                    }
                }, 1000);
                
                console.log('åŠ¨ä½œæ’­æ”¾å™¨çª—å£å·²æ‰“å¼€');
            } else {
                alert('æ— æ³•æ‰“å¼€åŠ¨ä½œæ’­æ”¾å™¨çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®');
            }
        }

        // ========== åº”ç”¨åˆå§‹åŒ– ==========
        let live2dManager;
        let xiaozhiClient;

        window.addEventListener('load', async () => {
            try {
                console.log('ğŸš€ å°æ™ºLive2D - ç”Ÿäº§ç¯å¢ƒå¯åŠ¨');
                
                // åˆå§‹åŒ–Live2D
                live2dManager = new Live2DManager();
                await live2dManager.init();
                
                // å°†Live2Dç®¡ç†å™¨æš´éœ²åˆ°å…¨å±€ï¼Œä¾›åŠ¨ä½œæ’­æ”¾å™¨è„šæœ¬ä½¿ç”¨
                window.live2dApp = live2dManager;
                
                // è®¾ç½®localStorageæ ‡è®°ï¼Œè¡¨ç¤ºLive2Då·²å‡†å¤‡å°±ç»ª
                try {
                    localStorage.setItem('live2d_status', 'ready');
                } catch (e) {
                    console.warn('æ— æ³•è®¾ç½®localStorageæ ‡è®°');
                }
                
                // åˆå§‹åŒ–å°æ™ºAIå®¢æˆ·ç«¯
                xiaozhiClient = new XiaozhiAIClient();
                
                console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                showError('åº”ç”¨å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        });

        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            showError('å‘ç”Ÿé”™è¯¯: ' + event.error.message);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            showError('å¼‚æ­¥æ“ä½œå¤±è´¥: ' + event.reason.message);
        });
    </script>
</body>
</html>